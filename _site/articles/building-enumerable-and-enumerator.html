<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Building Enumerable &amp; Enumerator in Ruby</title>
  <meta name="description" content="When I first came to Ruby, one of the things that impressed me the most was the killer features provided by the Enumerable module. I eventually also came to ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/building-enumerable-and-enumerator">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Building Enumerable & Enumerator in Ruby</h1>
    <p class="post-meta"><time datetime="2011-09-13T00:00:00-04:00" itemprop="datePublished">Sep 13, 2011</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>When I first came to Ruby, one of the things that impressed me the most was the killer features provided by the <code class="highlighter-rouge">Enumerable</code> module. I eventually also came to love <code class="highlighter-rouge">Enumerator</code>, even though it took me a long time to figure out what it was and what one might use it for.</p>

<p>As a beginner, I had always assumed that these features worked through some dark form of magic that was buried deep within the Ruby interpreter. With so much left to learn just in order to be productive, I was content to postpone learning the details about what was going on under the hood. After some time, I came to regret that decision, thanks to David A. Black.</p>

<p>David teaches Ruby to raw beginners not only by showing them what <code class="highlighter-rouge">Enumerable</code> can do, but also by making them implement their own version of it! This is a profoundly good exercise, because it exposes how nonmagical the features are: if you understand <code class="highlighter-rouge">yield</code>, you can build all the methods in <code class="highlighter-rouge">Enumerable</code>. Similarly, the interesting features of <code class="highlighter-rouge">Enumerator</code> can be implemented fairly easily if you use Ruby’s <code class="highlighter-rouge">Fiber</code> construct.</p>

<p>In this article, we’re going to work through the exercise of rolling your own subset of the functionality provided by <code class="highlighter-rouge">Enumerable</code> and <code class="highlighter-rouge">Enumerator</code>, discussing each detail along the way. Regardless of your skill level, an understanding of the elegant design of these constructs will undoubtedly give you a great source of inspiration that you can draw from when designing new constructs in your own programs.</p>

<h3 id="setting-the-stage-with-some-tests">Setting the stage with some tests</h3>

<p>I’ve selected a small but representative subset of the features that <code class="highlighter-rouge">Enumerable</code> and <code class="highlighter-rouge">Enumerator</code> provide and written some tests to nail down their behavior. These tests will guide my implementations throughout the rest of this article and serve as a roadmap for you if you’d like to try out the exercise on your own.</p>

<p>If you have some time to do so, try to get at least some of the tests to go green before reading my implementation code and explanations, as you’ll learn a lot more that way. But if you’re not planning on doing that, at least read through the tests carefully and think about how you might go about implementing the features they describe.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SortedList</span>
  <span class="kp">include</span> <span class="no">FakeEnumerable</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@data</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">&lt;&lt;</span><span class="p">(</span><span class="n">new_element</span><span class="p">)</span>
    <span class="vi">@data</span> <span class="o">&lt;&lt;</span> <span class="n">new_element</span>
    <span class="vi">@data</span><span class="p">.</span><span class="nf">sort!</span>
   
    <span class="nb">self</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">each</span>
    <span class="k">if</span> <span class="nb">block_given?</span>
      <span class="vi">@data</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="k">yield</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="no">FakeEnumerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">:each</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span> 
<span class="k">end</span>

<span class="nb">require</span> <span class="s2">"minitest/autorun"</span>

<span class="n">describe</span> <span class="s2">"FakeEnumerable"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@list</span> <span class="o">=</span> <span class="no">SortedList</span><span class="p">.</span><span class="nf">new</span>

    <span class="c1"># will get stored interally as 3,4,7,13,42</span>
    <span class="vi">@list</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span> <span class="o">&lt;&lt;</span> <span class="mi">42</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"supports map"</span> <span class="k">do</span>
    <span class="vi">@list</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}.</span><span class="nf">must_equal</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">43</span><span class="p">])</span>  
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"supports sort_by"</span> <span class="k">do</span>
    <span class="c1"># ascii sort order</span>
    <span class="vi">@list</span><span class="p">.</span><span class="nf">sort_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="p">.</span><span class="nf">to_s</span> <span class="p">}.</span><span class="nf">must_equal</span><span class="p">([</span><span class="mi">13</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"supports select"</span> <span class="k">do</span>
    <span class="vi">@list</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span><span class="p">.</span><span class="nf">even?</span> <span class="p">}.</span><span class="nf">must_equal</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="mi">42</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"supports reduce"</span> <span class="k">do</span>
    <span class="vi">@list</span><span class="p">.</span><span class="nf">reduce</span><span class="p">(:</span><span class="o">+</span><span class="p">).</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">69</span><span class="p">)</span>
    <span class="vi">@list</span><span class="p">.</span><span class="nf">reduce</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="o">|</span> <span class="n">s</span> <span class="o">+</span> <span class="n">e</span> <span class="p">}.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">69</span><span class="p">)</span>
    <span class="vi">@list</span><span class="p">.</span><span class="nf">reduce</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="o">|</span> <span class="n">s</span> <span class="o">+</span> <span class="n">e</span> <span class="p">}.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="s2">"FakeEnumerator"</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@list</span> <span class="o">=</span> <span class="no">SortedList</span><span class="p">.</span><span class="nf">new</span>

    <span class="vi">@list</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span> <span class="o">&lt;&lt;</span> <span class="mi">42</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"supports next"</span> <span class="k">do</span>
    <span class="n">enum</span> <span class="o">=</span> <span class="vi">@list</span><span class="p">.</span><span class="nf">each</span>

    <span class="n">enum</span><span class="p">.</span><span class="nf">next</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">enum</span><span class="p">.</span><span class="nf">next</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">enum</span><span class="p">.</span><span class="nf">next</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">enum</span><span class="p">.</span><span class="nf">next</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">enum</span><span class="p">.</span><span class="nf">next</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

    <span class="n">assert_raises</span><span class="p">(</span><span class="no">StopIteration</span><span class="p">)</span> <span class="p">{</span> <span class="n">enum</span><span class="p">.</span><span class="nf">next</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"supports rewind"</span> <span class="k">do</span>
    <span class="n">enum</span> <span class="o">=</span> <span class="vi">@list</span><span class="p">.</span><span class="nf">each</span>

    <span class="mi">4</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">enum</span><span class="p">.</span><span class="nf">next</span> <span class="p">}</span>
    <span class="n">enum</span><span class="p">.</span><span class="nf">rewind</span>

    <span class="mi">2</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">enum</span><span class="p">.</span><span class="nf">next</span> <span class="p">}</span>
    <span class="n">enum</span><span class="p">.</span><span class="nf">next</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"supports with_index"</span> <span class="k">do</span>
    <span class="n">enum</span>     <span class="o">=</span> <span class="vi">@list</span><span class="p">.</span><span class="nf">map</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0. 3"</span><span class="p">,</span> <span class="s2">"1. 4"</span><span class="p">,</span> <span class="s2">"2. 7"</span><span class="p">,</span> <span class="s2">"3. 13"</span><span class="p">,</span> <span class="s2">"4. 42"</span><span class="p">]</span>  

    <span class="n">enum</span><span class="p">.</span><span class="nf">with_index</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="o">|</span> <span class="s2">"</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span> <span class="p">}.</span><span class="nf">must_equal</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If you do decide to try implementing these features yourself, get as close to the behavior that Ruby provides as you can, but don’t worry if your implementation is different from what Ruby really uses. Just think of this as if it’s a new problem that needs solving, and let the tests guide your implementation. Once you’ve done that, read on to see how I did it.</p>

<h3 id="implementing-the-fakeenumerable-module">Implementing the <code class="highlighter-rouge">FakeEnumerable</code> module</h3>

<p>Before I began work on implementing <code class="highlighter-rouge">FakeEnumerable</code>, I needed to get its tests to a failure state rather than an error state. The following code does exactly that:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">FakeEnumerable</span>
  <span class="k">def</span> <span class="nf">map</span> 
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">select</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">sort_by</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I then began working on implementing the methods one by one, starting with <code class="highlighter-rouge">map</code>. The key thing to realize while working with <code class="highlighter-rouge">Enumerable</code> is that every feature will build on top of the <code class="highlighter-rouge">each</code> method in some way, using it in combination with <code class="highlighter-rouge">yield</code> to produce its results. The <code class="highlighter-rouge">map</code> feature is possibly the most straightforward nontrivial combination of these operations, as you can see in this implementation:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">map</span> 
  <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="k">yield</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">out</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Here we see that <code class="highlighter-rouge">map</code> is simply a function that builds up a new array by taking each element and replacing it with the return value of the block you provide to it. We can clean this up to make it a one liner using <code class="highlighter-rouge">Object#tap</code>, but I’m not sure if I like that approach because it breaks the simplicity of the implementation a bit. That said, I’ve included it here for your consideration and will use it throughout the rest of this article, just for the sake of brevity.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">map</span>
  <span class="p">[].</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span> <span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="k">yield</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Implementing <code class="highlighter-rouge">select</code> is quite easy as well. It builds on the same concepts used to implement <code class="highlighter-rouge">map</code> but adds a conditional check to see whether the block returns a <code class="highlighter-rouge">true</code> value. For each new yielded element, if the value returned by the block is logically true, the element gets added to the newly built array; otherwise, it does not.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">select</span>
  <span class="p">[].</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span> <span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">e</span> <span class="k">if</span> <span class="k">yield</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Implementing <code class="highlighter-rouge">sort_by</code> is a little more tricky. I cheated and looked at the API documentation, which (perhaps surprisingly) describes how the method is implemented and even gives a reference implementation in Ruby. Apparently, <code class="highlighter-rouge">sort_by</code> uses a <a href="http://en.wikipedia.org/wiki/Schwartzian_transform">Schwartzian transform</a> to convert the collection we are iterating over into tuples containing the sort key and the original element. It then uses <code class="highlighter-rouge">Array#sort</code> to put these in order, and it finally uses <code class="highlighter-rouge">map</code> on the resulting array to convert the array of tuples back into an array of the elements from the original collection. That’s definitely more confusing to explain than it is to implement in code, so just look at the following code for clarification:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">sort_by</span>
  <span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="p">[</span><span class="k">yield</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">a</span><span class="p">]</span> <span class="p">}.</span><span class="nf">sort</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The interesting thing about this implementation is that <code class="highlighter-rouge">sort_by</code> is dependent on <code class="highlighter-rouge">map</code>, both on the current collection being iterated over as well as on the <code class="highlighter-rouge">Array</code> it generates. But after tracing it down to the core, this method is still expecting the collection to implement only the <code class="highlighter-rouge">each</code> method. Additionally, because <code class="highlighter-rouge">Array#sort</code> is thrown into the mix, your sort keys need to respond to <code class="highlighter-rouge">&lt;=&gt;</code>. But for such a powerful method, the contract is still very narrow.</p>

<p>Implementing <code class="highlighter-rouge">reduce</code> is a bit more involved because it has three different ways of interacting with it. It’s also interesting because it’s one of the few <code class="highlighter-rouge">Enumerable</code> methods that isn’t necessarily designed to return an <code class="highlighter-rouge">Array</code> object. I’ll let you ponder the following implementation a bit before providing more commentary, because reading through it should be a good exercise.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="n">operation_or_value</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">operation_or_value</span>
  <span class="k">when</span> <span class="no">Symbol</span>
    <span class="c1"># convert things like reduce(:+) into reduce { |s,e| s + e }</span>
    <span class="k">return</span> <span class="n">reduce</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">operation_or_value</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">when</span> <span class="kp">nil</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">else</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">operation_or_value</span>
  <span class="k">end</span>

  <span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">acc</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="n">acc</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">else</span>
      <span class="n">acc</span> <span class="o">=</span> <span class="k">yield</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">return</span> <span class="n">acc</span>
<span class="k">end</span>
</code></pre>
</div>

<p>First, I have to say I’m not particularly happy with my implementation; it seems a bit too brute force and I think I might be missing some obvious refactorings. But it should have been readable enough for you to get a general feel for what’s going on. The first paragraph of code is simply handling the three different cases of <code class="highlighter-rouge">reduce()</code>. The real operation happens starting with our <code class="highlighter-rouge">each</code> call.</p>

<p>Without a predefined initial value, we set the initial value to the first element in the collection, and our first yield occurs starting with the second element. Otherwise, the initial value and first element are yielded. The purpose of <code class="highlighter-rouge">reduce()</code> is to perform an operation on each successive value in a list by combining it in some way with the last calculated value. In this way, the list gets reduced to a single value in the end. This behavior explains why the old alias for this method in Ruby was called <code class="highlighter-rouge">inject</code>: a function is being injected between each element in the collection via our <code class="highlighter-rouge">yield</code> call. I find this operation much easier to understand when I’m able to see it in terms of primitive concepts such as <code class="highlighter-rouge">yield</code> and <code class="highlighter-rouge">each</code> because it makes it possible to trace exactly what is going on.</p>

<p>If you are having trouble following the implementation of <code class="highlighter-rouge">reduce()</code>, don’t worry about it. It’s definitely one of the more complex <code class="highlighter-rouge">Enumerable</code> methods, and if you try to implement a few of the others and then return to studying <code class="highlighter-rouge">reduce()</code>, you may have better luck. But the beautiful thing is that if you ignore the <code class="highlighter-rouge">reduce(:+)</code> syntactic sugar, it introduces no new concepts beyond that what is used to implement <code class="highlighter-rouge">map()</code>. If you think you understand <code class="highlighter-rouge">map()</code> but not <code class="highlighter-rouge">reduce()</code>, it’s a sign that you may need to brush up on your fundamentals, such as how <code class="highlighter-rouge">yield</code> works.</p>

<p>If you’ve been following along at home, you should at this point be passing all your <code class="highlighter-rouge">FakeEnumerable</code> tests. That means it’s time to get started on our <code class="highlighter-rouge">FakeEnumerator</code>.</p>

<h3 id="implementing-the-fakeenumerator-class">Implementing the <code class="highlighter-rouge">FakeEnumerator</code> class</h3>

<p>Similar to before, I needed to write some code to get my tests to a failure state. First, I set up the skeleton of the <code class="highlighter-rouge">FakeEnumerator</code> class.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FakeEnumerator</span>
  <span class="k">def</span> <span class="nf">next</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">with_index</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">rewind</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Then I realized that I needed to back and at least modify the <code class="highlighter-rouge">FakeEnumerable#map</code> method, as my tests rely on it returning a <code class="highlighter-rouge">FakeEnumerator</code> object when a block is not provided, in a similar manner to the way <code class="highlighter-rouge">Enumerable#map</code> would return an <code class="highlighter-rouge">Enumerator</code> in that scenario.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">FakeEnumerable</span>
  <span class="k">def</span> <span class="nf">map</span> 
    <span class="k">if</span> <span class="nb">block_given?</span>
      <span class="p">[].</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span> <span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="k">yield</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="no">FakeEnumerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">:map</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Although, technically speaking, I should have also updated all my other <code class="highlighter-rouge">FakeEnumerable</code> methods, it’s not important to do so because our tests don’t cover it and that change introduces no new concepts to discuss. With this change to <code class="highlighter-rouge">map</code>, my tests all failed rather than erroring out, which meant it was time to start working on the implementation code.</p>

<p>But before we get started, it’s worth reflecting on the core purpose of an <code class="highlighter-rouge">Enumerator</code>, which I haven’t talked about yet. At its core, an <code class="highlighter-rouge">Enumerator</code> is simply a proxy object that mixes in <code class="highlighter-rouge">Enumerable</code> and then delegates its <code class="highlighter-rouge">each</code> method to some other iterator provided by the object it wraps. This behavior turns an internal iterator into an external one, which allows you to pass it around and manipulate it as an object.</p>

<p>Our tests call for us to implement <code class="highlighter-rouge">next</code>, <code class="highlighter-rouge">rewind</code>, and <code class="highlighter-rouge">each_index</code>, but before we can do that meaningfully, we need to make <code class="highlighter-rouge">FakeEnumerator</code> into a <code class="highlighter-rouge">FakeEnumerable</code>-enabled proxy object. There are no tests for this because I didn’t want to reveal too many hints to those who wanted to try this exercise at home, but this code will do the trick:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FakeEnumerator</span>
  <span class="kp">include</span> <span class="no">FakeEnumerable</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> 
    <span class="vi">@target</span> <span class="o">=</span> <span class="n">target</span>
    <span class="vi">@iter</span>   <span class="o">=</span> <span class="n">iter</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="vi">@target</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="vi">@iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> 
  <span class="k">end</span>

   <span class="c1"># other methods go here...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Here we see that <code class="highlighter-rouge">each</code> uses <code class="highlighter-rouge">send</code> to call the original iterator method on the target object. Other than that, this is the ordinary pattern we’ve seen in implementing other collections. The next step is to implement our <code class="highlighter-rouge">next</code> method, which is a bit tricky.</p>

<p>What we need to be able to do is iterate once, then pause and return a value. Then, when <code class="highlighter-rouge">next</code> is called again, we need to be able to advance one more iteration and repeat the process. We could do something like run the whole iteration and cache the results into an array, then do some sort of indexing operation, but that’s both inefficient and impractical for certain applications. This problem made me realize that Ruby’s <code class="highlighter-rouge">Fiber</code> construct might be a good fit because it specifically allows you to jump in and out of a chunk of code on demand. So I decided to try that out and see how far I could get. After some fumbling around, I got the following code to pass the test:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1"># loading the fiber stdlib gives us some extra features, including Fiber#alive?</span>
<span class="nb">require</span> <span class="s2">"fiber"</span> 

<span class="k">class</span> <span class="nc">FakeEnumerator</span>
  <span class="k">def</span> <span class="nf">next</span>
    <span class="vi">@fiber</span> <span class="o">||=</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
      <span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">yield</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">}</span>

      <span class="k">raise</span> <span class="no">StopIteration</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="vi">@fiber</span><span class="p">.</span><span class="nf">alive?</span>
      <span class="vi">@fiber</span><span class="p">.</span><span class="nf">resume</span> 
    <span class="k">else</span>
      <span class="k">raise</span> <span class="no">StopIteration</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This code is hard to read because it isn’t really a linear flow, but I’ll do my best to explain it using my very limited knowledge of how the <code class="highlighter-rouge">Fiber</code> construct works. Basically, when you call <code class="highlighter-rouge">Fiber#new</code> with a block, the code in that block isn’t executed immediately. Instead, execution begins when <code class="highlighter-rouge">Fiber#resume</code> is called. Each time a <code class="highlighter-rouge">Fiber#yield</code> call is encountered, control is returned to the caller of <code class="highlighter-rouge">Fiber#resume</code> with the value that was passed to <code class="highlighter-rouge">Fiber#yield</code> returned. Each subsequent <code class="highlighter-rouge">Fiber#resume</code> picks up execution back at the point where the last <code class="highlighter-rouge">Fiber#yield</code> call was made, rather than at the beginning of the code block. This process continues until no more <code class="highlighter-rouge">Fiber#yield</code> calls remain, and then the last executed line of code is returned as the final value of <code class="highlighter-rouge">Fiber#resume</code>. Any additional attempts to call <code class="highlighter-rouge">Fiber#resume</code> result in a <code class="highlighter-rouge">FiberError</code> because there is nothing left to execute.</p>

<p>If you reread the previous paragraph a couple of times and compare it to the definition of my <code class="highlighter-rouge">next</code> method, it should start to make sense. But if it’s causing your brain to melt, check out the <a href="http://ruby-doc.org/core-1.9/classes/Fiber.html">Fiber documentation</a>, which is reasonably helpful.</p>

<p>The very short story about this whole thing is that using a <code class="highlighter-rouge">Fiber</code> in our <code class="highlighter-rouge">next</code> definition lets us keep track of just how far into the <code class="highlighter-rouge">each</code> iteration we are and jump back into the iterator on demand to get the next value. I prevent the <code class="highlighter-rouge">FiberError</code> from ever occurring by checking to see whether the <code class="highlighter-rouge">Fiber</code> object is still alive before calling <code class="highlighter-rouge">resume</code>. But I also need to make it so that the final executed statement within the <code class="highlighter-rouge">Fiber</code> raises a <code class="highlighter-rouge">StopIteration</code> error as well, to prevent it from returning the result of <code class="highlighter-rouge">each</code>, which would be the collection itself. This is a kludge, and if you have a better idea for how to handle this case, please leave me a comment.</p>

<p>The use of <code class="highlighter-rouge">Fiber</code> objects to implement <code class="highlighter-rouge">next</code> makes it possible to work with infinite iterators, such as <code class="highlighter-rouge">Enumerable#cycle</code>. Though we won’t get into implementation details, the following code should give some hints as to why this is a useful feature:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="o">&gt;&gt;</span> <span class="n">row_colors</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:red</span><span class="p">,</span> <span class="ss">:green</span><span class="p">].</span><span class="nf">cycle</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Enumerator: [:red, :green]:cycle&gt;</span>
<span class="o">&gt;&gt;</span> <span class="n">row_colors</span><span class="p">.</span><span class="nf">next</span>
<span class="o">=&gt;</span> <span class="ss">:red</span>
<span class="o">&gt;&gt;</span> <span class="n">row_colors</span><span class="p">.</span><span class="nf">next</span>
<span class="o">=&gt;</span> <span class="ss">:green</span>
<span class="o">&gt;&gt;</span> <span class="n">row_colors</span><span class="p">.</span><span class="nf">next</span>
<span class="o">=&gt;</span> <span class="ss">:red</span>
<span class="o">&gt;&gt;</span> <span class="n">row_colors</span><span class="p">.</span><span class="nf">next</span>
<span class="o">=&gt;</span> <span class="ss">:green</span>
</code></pre>
</div>

<p>As cool as that is, and as much as it makes me want to dig into implementing it, I have to imagine that you’re getting tired by now. Heck, I’ve already slept twice since I started writing this article! So let’s hurry up and finish implementing <code class="highlighter-rouge">rewind</code> and <code class="highlighter-rouge">each_index</code> so that we can wrap things up.</p>

<p>I found a way to implement <code class="highlighter-rouge">rewind</code> that is trivial, but something about it makes me wonder if I’ve orphaned a <code class="highlighter-rouge">Fiber</code> object somewhere and whether that has weird garbage collection mplications. But nonetheless, because our implementation of <code class="highlighter-rouge">next</code> depends on the caching of a <code class="highlighter-rouge">Fiber</code> object to keep track of where it is in its iteration, the easiest way to rewind back to the beginning state is to simply wipe out that object. The following code gets my <code class="highlighter-rouge">rewind</code> tests passing:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">rewind</span>
  <span class="vi">@fiber</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Now only one feature stands between us and the completion of our exercise: <code class="highlighter-rouge">with_index</code>. The real <code class="highlighter-rouge">with_index</code> method in Ruby is much smarter than what you’re about to see, but for its most simple functionality, the following code will do the trick:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">with_index</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> 
    <span class="n">out</span> <span class="o">=</span> <span class="k">yield</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">out</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Here, I did the brute force thing and maintained my own counter. I then made a small modification to control flow so that rather than yielding just the element on each iteration, both the element and its index are yielded. Keep in mind that the <code class="highlighter-rouge">each</code> call here is a proxy to some other iterator on another collection, which is what gives us the ability to call <code class="highlighter-rouge">@list.map.with_index</code> and get <code class="highlighter-rouge">map</code> behavior rather than <code class="highlighter-rouge">each</code> behavior. Although you won’t use every day, knowing how to implement an around filter using <code class="highlighter-rouge">yield</code> can be quite useful.</p>

<p>With this code written, my full test suite finally went green. Even though I’d done these exercises a dozen times before, I still learned a thing or two while writing this article, and I imagine there is still plenty left for me to learn as well. How about you?</p>

<h3 id="reflections">Reflections</h3>

<p>This is definitely one of my favorite exercises for getting to understand Ruby better. I’m not usually big on contrived practice drills, but there is something about peeling back the magic on features that look really complex on the surface that gives me a great deal of satisfaction. I find that even if my solutions are very much cheap counterfeits of what Ruby must really be doing, it still helps tremendously to have implemented these features in any way I know how, because it gives me a mental model of my own construction from which to view the features.</p>

<p>If you enjoyed this exercise, there are a number of things that you could do to squeeze even more out of it. The easiest way to do so is to implement a few more of the <code class="highlighter-rouge">Enumerable</code> and <code class="highlighter-rouge">Enumerator</code> methods. As you do that, you’ll find areas where the implementations we built out today are clearly insufficient or would be better off written another way. That’s fine, because it will teach you even more about how these features hang together. You can also discuss and improve upon the examples I’ve provided, as there is certainly room for refactoring in several of them. Finally, if you want to take a more serious approach to things, you could take a look at the tests in <a href="https://github.com/rubyspec/rubyspec">RubySpec</a> and the implementations in <a href="https://github.com/rubinius/rubinius">Rubinius</a>. Implementing Ruby in Ruby isn’t just something folks do for fun these days, and if you really enjoyed working on these low-level features, you might consider contributing to Rubinius in some way. The maintainers of that project are amazing, and you can learn a tremendous amount that way.</p>

<p>Of course, not everyone has time to contribute to a Ruby implementation, even if it’s for the purpose of advancing their own understanding of Ruby. So I’d certainly settle for a comment here sharing your experiences with this exercise.</p>

  </div>

  <div style="text-align: center">
    <h3><a href="/">Want to keep reading? Check out the archives for more.</a></h3>

    <small>Practicing Ruby is proudly independent, open source, and advertising free.<br/>If you insist on being asked for something in return, check out <a href="/support">how to support my work</a>.</small>
  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
