<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Structural Design Patterns</title>
  <meta name="description" content="In this two part series, I’ve been looking at the classical design patterns laid out by the Gang of Four and exploring their relevance to modern day Ruby pro...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://practicingruby.com/articles/structural-design-patterns">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://practicingruby.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Structural Design Patterns</h1>
    <p class="post-meta"><time datetime="2011-02-28T00:00:00-05:00" itemprop="datePublished">Feb 28, 2011</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>In this two part series, I’ve been looking at the classical design patterns laid out by the Gang of Four and exploring their relevance to modern day Ruby programming. Rather than teaching the design patterns themselves, my goal is to give practical examples using real code so that you can consider what the strengths and weaknesses of these techniques are.</p>

<p>In this issue, I’ll be focusing on the structural design patterns, all of which have to do with the relationships between clusters of code. The seven patterns listed below are the ones we’ll focus on in this article.</p>

<ul>
  <li>Adapter</li>
  <li>Bridge</li>
  <li>Composite</li>
  <li>Proxy</li>
  <li>Decorator</li>
  <li>Facade</li>
  <li>Flyweight</li>
</ul>

<p>An important thing to keep in mind is that while the original GoF book was written with C++ and Smalltalk examples, none of the patterns were written with Ruby’s semantics in mind. This makes it necessary to use a little poetic license to explore how these patterns apply in Ruby. That having been said, the examples we’ll look at attempt to preserve the spirit of the patterns they implement even if they’re not semantically identical.</p>

<h3 id="adapter">Adapter</h3>

<p>An <a href="http://en.wikipedia.org/wiki/Adapter_pattern">Adapter</a> is used when you want to provide a unified interface to a number of different objects that implement similar functionality. This pattern is easy to spot in the wild for a Ruby developer, as most of us have to use ActiveRecord in our day to day work. Under the hood, ActiveRecord talks to a large amount of different databases, but wraps them up in a common interface its implementation code can avoid worrying about their individual differences. This is exactly the sort of thing the Adapter pattern is useful for.</p>

<p>Increasingly, Rubyists are finding this pattern to be useful in other settings as well. In particular, things like Intridea’s <a href="https://github.com/intridea/multi_json">multi_json</a> gem allow libraries and applications to be built against an abstract interface rather than requiring some particular JSON library that might conflict with other dependencies. Inspired by the ideas behind multi_json, a Mendicant University student (Mitko Kostov) built a similar adapter library for Markdown processors called <a href="https://github.com/mytrile/marky">Marky</a>. The base implementation is very simple, and gives us a good opportunity to look at one way to implement an Adapter in Ruby from the ground up.</p>

<p>The basic idea is that we want to be able to use a common interface while easily
configuring which backend is used. The following example shows how Marky might
be used:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># using RDiscount as a backend</span>
<span class="no">Marky</span><span class="p">.</span><span class="nf">adapter</span> <span class="o">=</span> <span class="ss">:rdiscount</span>

<span class="no">Marky</span><span class="p">.</span><span class="nf">to_html</span><span class="p">(</span><span class="s2">"hello world"</span><span class="p">)</span> <span class="c1">#=&gt; "&lt;p&gt;hello world&lt;/p&gt;</span>

<span class="c1"># using BlueCloth as a backend</span>
<span class="no">Marky</span><span class="p">.</span><span class="nf">adapter</span> <span class="o">=</span> <span class="ss">:bluecloth</span>

<span class="no">Marky</span><span class="p">.</span><span class="nf">to_html</span><span class="p">(</span><span class="s2">"hello world"</span><span class="p">)</span> <span class="c1">#=&gt; "&lt;p&gt;hello world&lt;/p&gt;"</span>
</code></pre>
</div>

<p>To make this work, it is necessary to map the name of an adapter to a class which wraps the underlying engine and implements a <code class="highlighter-rouge">to_html()</code> method. The code that actually wires up the adapter is shown below.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Marky</span>
  <span class="kp">extend</span> <span class="nb">self</span>

  <span class="k">def</span> <span class="nf">adapter</span>
    <span class="k">return</span> <span class="vi">@adapter</span> <span class="k">if</span> <span class="vi">@adapter</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">adapter</span> <span class="o">=</span> <span class="ss">:rdiscount</span>
    <span class="vi">@adapter</span>
  <span class="k">end</span>
   
  <span class="k">def</span> <span class="nf">adapter</span><span class="o">=</span><span class="p">(</span><span class="n">adapter_name</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">adapter_name</span>
    <span class="k">when</span> <span class="no">Symbol</span><span class="p">,</span> <span class="no">String</span>
      <span class="nb">require</span> <span class="s2">"adapters/</span><span class="si">#{</span><span class="n">adapter_name</span><span class="si">}</span><span class="s2">"</span>
      <span class="vi">@adapter</span> <span class="o">=</span> <span class="no">Marky</span><span class="o">::</span><span class="no">Adapters</span><span class="p">.</span><span class="nf">const_get</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">adapter_name</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">capitalize</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="s2">"Missing adapter </span><span class="si">#{</span><span class="n">adapter_name</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">adapter</span><span class="p">.</span><span class="nf">to_html</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>While this uses a tiny bit of dynamic Ruby magic to look up the right module name, when we see the actual adapters, it all comes together.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># adapters/bluecloth.rb</span>

<span class="nb">require</span> <span class="s2">"bluecloth"</span>

<span class="k">module</span> <span class="nn">Marky</span>
  <span class="k">module</span> <span class="nn">Adapters</span>
    <span class="k">module</span> <span class="nn">Bluecloth</span>
      <span class="kp">extend</span> <span class="nb">self</span>
      <span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="o">::</span><span class="no">BlueCloth</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">string</span><span class="p">).</span><span class="nf">to_html</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># adapters/rdiscount.rb</span>

<span class="nb">require</span> <span class="s2">"rdiscount"</span>

<span class="k">module</span> <span class="nn">Marky</span>
  <span class="k">module</span> <span class="nn">Adapters</span>
    <span class="k">module</span> <span class="nn">Rdiscount</span>
      <span class="kp">extend</span> <span class="nb">self</span>
      <span class="k">def</span> <span class="nf">to_html</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="o">::</span><span class="no">RDiscount</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">string</span><span class="p">).</span><span class="nf">to_html</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Since all the adapters implement a <code class="highlighter-rouge">to_html()</code> method that share a common
contract, <code class="highlighter-rouge">Marky.to_html()</code> will work regardless of what adapter gets loaded.
The win here is that if that libraries, applications and frameworks rely on
adapters rather than concrete implementations, it will be easier to swap
one engine out for another when necessary.</p>

<p>While not every problem domain needs added level of indirection that Adapters introduce, they can come in handy when there are several competing implementations solving a common problem but you don’t want to forced to choose one over the other.</p>

<h3 id="bridge">Bridge</h3>

<p>The idea behind a <a href="http://en.wikipedia.org/wiki/Bridge_pattern">Bridge</a> is to place a physical separation between the interface of a given type of object and its implementation. In languages in which the type system gets in the way, this kind of pattern is important for reducing the proliferation of various type permutations by making hierarchies of interfaces and implementations orthogonal to one another. If that sounds like academic jibberish to you, there is a <a href="http://sourcemaking.com/design_patterns/bridge">SourceMaking article</a> that might help sort the concepts out for you a bit.</p>

<p>I had a hard time thinking through where this pattern has its place in Ruby, mainly because there is a built in separation of interface and implementation in Ruby via duck typing semantics. The best example I could come up with was to port the painfully complex C++ example that SourceMaking uses in their article to something that is a bit more natural looking in Ruby. Read it over, and think about what it might be gaining us as you go.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1">##Concrete Implementations</span>

<span class="k">class</span> <span class="nc">BasicTimeData</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span><span class="p">)</span>
    <span class="vi">@hour</span>     <span class="o">=</span> <span class="n">hour</span>
    <span class="vi">@minutes</span>  <span class="o">=</span> <span class="n">minutes</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">formatted_output</span>
    <span class="s2">"Time is </span><span class="si">#{</span><span class="vi">@hour</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="vi">@minutes</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TimeWithMeridianData</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">meridian</span><span class="p">)</span>
    <span class="vi">@hour</span>     <span class="o">=</span> <span class="n">hour</span>
    <span class="vi">@minutes</span>  <span class="o">=</span> <span class="n">minutes</span>
    <span class="vi">@meridian</span> <span class="o">=</span> <span class="n">meridian</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">formatted_output</span>
    <span class="s2">"Time is </span><span class="si">#{</span><span class="vi">@hour</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="vi">@minutes</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="vi">@meridian</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1">##Bridge</span>

<span class="k">module</span> <span class="nn">TimeFormatter</span>
  <span class="k">def</span> <span class="nf">to_s</span>
    <span class="vi">@time_data</span><span class="p">.</span><span class="nf">formatted_output</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1">## Abstract Objects linked to Concrete Implementations through Bridge</span>

<span class="k">class</span> <span class="nc">BasicTime</span>
  <span class="kp">include</span> <span class="no">TimeFormatter</span>
  
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
    <span class="vi">@time_data</span> <span class="o">=</span> <span class="no">BasicTimeData</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>    
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">TimeWithMeridian</span>
  <span class="kp">include</span> <span class="no">TimeFormatter</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
    <span class="vi">@time_data</span> <span class="o">=</span> <span class="no">TimeWithMeridianData</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1">## Example Usage</span>

<span class="n">time1</span>  <span class="o">=</span> <span class="no">BasicTime</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"10"</span><span class="p">,</span><span class="s2">"30"</span><span class="p">)</span>
<span class="n">time2</span>  <span class="o">=</span> <span class="no">TimeWithMeridian</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"10"</span><span class="p">,</span><span class="s2">"30"</span><span class="p">,</span><span class="s2">"PM"</span><span class="p">)</span>

<span class="p">[</span><span class="n">time1</span><span class="p">,</span> <span class="n">time2</span><span class="p">].</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">t</span> <span class="p">}</span>
</code></pre>
</div>

<p>While it might just due to the nature of the example, I feel this code is still quite contrived, and that hides its benefits. The takeway here is mostly that it’s possible for both <code class="highlighter-rouge">BasicTimeData</code> and <code class="highlighter-rouge">TimeWithMeridianData</code> to change without breaking <code class="highlighter-rouge">BasicTime</code> and <code class="highlighter-rouge">TimeWithMeridian</code>, as long as <code class="highlighter-rouge">TimeFormatter</code> is updated. Similarly, a change in the needs of <code class="highlighter-rouge">BasicTime</code> and <code class="highlighter-rouge">TimeWithMeridian</code> will not affect the concrete implementations of the data structures, as long as the bridge provides the necessary wiring.</p>

<p>The thing that I struggle with in this pattern is understanding what unique behaviors the <code class="highlighter-rouge">BasicTime</code> and <code class="highlighter-rouge">TimeWithMeridian</code> objects could implement that justify their existence. Is this pattern an artifact of static languages that isn’t really needed in Ruby? Or am I just missing some important detail that could be cleared up with a good example or two? Feel free to leave a comment letting me know what you think.</p>

<h3 id="composite">Composite</h3>

<p>The <a href="http://en.wikipedia.org/wiki/Composite_pattern">Composite pattern</a> is useful when you want to treat a group of objects as if it were a single, unified object. To explore this pattern, we can look at some experimental code I wrote for Prawn which was designed to make it possible to treat all objects drawn in the document as compositions of primitive PDF instructions. We can start with an example of rendering a curve, working from the outside in.</p>

<p>When <code class="highlighter-rouge">curve()</code> is called on a Prawn drawing, the PDF content is generated as a
side effect and the user does not need to do anything with the return value of
that method. However, if someone wanted to play with the internals, they could
call <code class="highlighter-rouge">curve!()</code> instead and get themselves an object that implements a
<code class="highlighter-rouge">to_pdf()</code> method, as in the following example:</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">chunk</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="nf">curve!</span><span class="p">(</span><span class="ss">:point1</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">],</span>
                      <span class="ss">:point2</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">],</span> 
                      <span class="ss">:bound1</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="mi">90</span><span class="p">],</span>
                      <span class="ss">:bound2</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="mi">90</span><span class="p">])</span>

<span class="nb">puts</span> <span class="n">chunk</span><span class="p">.</span><span class="nf">to_pdf</span>

<span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="p">.</span><span class="nf">.</span><span class="o">.</span><span class="no">OUTPUTS</span><span class="p">.</span><span class="nf">.</span>

  <span class="mi">100</span><span class="o">.</span><span class="mo">000</span> <span class="mi">100</span><span class="o">.</span><span class="mo">000</span> <span class="n">m</span>
  <span class="mi">60</span><span class="o">.</span><span class="mo">000</span> <span class="mi">90</span><span class="o">.</span><span class="mo">000</span> <span class="mi">60</span><span class="o">.</span><span class="mo">000</span> <span class="mi">90</span><span class="o">.</span><span class="mo">000</span> <span class="mi">50</span><span class="o">.</span><span class="mo">000</span> <span class="mi">50</span><span class="o">.</span><span class="mo">000</span> <span class="n">c</span>
</code></pre>
</div>

<p>We can catch a glimpse of how this <code class="highlighter-rouge">to_pdf()</code> method is actually implemented via several composed primitive objects by taking a look at the source for the <code class="highlighter-rouge">curve!()</code> method.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">curve!</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">chunk</span><span class="p">(</span><span class="ss">:curve</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
    <span class="p">[</span> <span class="n">move_to!</span><span class="p">(</span><span class="ss">:point</span> <span class="o">=&gt;</span> <span class="n">c</span><span class="p">[</span><span class="ss">:point1</span><span class="p">]),</span>
      <span class="n">curve_to!</span><span class="p">(</span><span class="ss">:point</span> <span class="o">=&gt;</span> <span class="n">c</span><span class="p">[</span><span class="ss">:point2</span><span class="p">],</span>
                <span class="ss">:bound1</span> <span class="o">=&gt;</span> <span class="n">c</span><span class="p">[</span><span class="ss">:bound1</span><span class="p">],</span>
                <span class="ss">:bound2</span> <span class="o">=&gt;</span> <span class="n">c</span><span class="p">[</span><span class="ss">:bound2</span><span class="p">])</span> <span class="p">]</span>

  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In the above, <code class="highlighter-rouge">chunk()</code> is a helper method which builds a <code class="highlighter-rouge">Prawn::Core::Chunk</code> object, which serves as the composite object in this system. We’ll look at how chunks are implemented in a bit, but note that the block given to the <code class="highlighter-rouge">chunk()</code> method defines what the individual chunk is composed of. In this case, a curve consists of two subchunks, one responsible for generating a move instruction, and one for rendering a curve from the current drawing location to another point. The definitions for both of those methods are shown below.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">move_to!</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">chunk</span><span class="p">(</span><span class="ss">:move_to</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
    <span class="n">raw_chunk</span><span class="p">(</span><span class="s2">"%.3f %.3f m"</span> <span class="o">%</span> <span class="n">c</span><span class="p">[</span><span class="ss">:point</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">line_to!</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="n">chunk</span><span class="p">(</span><span class="ss">:line_to</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
    <span class="n">raw_chunk</span><span class="p">(</span><span class="s2">"%.3f %.3f l"</span> <span class="o">%</span> <span class="n">c</span><span class="p">[</span><span class="ss">:point</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Similar to <code class="highlighter-rouge">chunk!()</code>, these methods can called directly, producing an object with a <code class="highlighter-rouge">to_pdf()</code> method, as shown below.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">chunk</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="nf">move_to!</span><span class="p">(</span><span class="ss">:point</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
<span class="nb">puts</span> <span class="n">chunk</span><span class="p">.</span><span class="nf">to_pdf</span>

<span class="n">chunk2</span> <span class="o">=</span> <span class="n">canvas</span><span class="p">.</span><span class="nf">curve_to!</span><span class="p">(</span><span class="ss">:point</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">],</span>
                          <span class="ss">:bound1</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="mi">90</span><span class="p">],</span>
                          <span class="ss">:bound2</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="mi">90</span><span class="p">])</span>

<span class="nb">puts</span> <span class="n">chunk2</span><span class="p">.</span><span class="nf">to_pdf</span>

<span class="c1"># combined output is identical to calling curve!() directly.</span>
</code></pre>
</div>

<p>Through these two methods, we encounter the leaf nodes in our composition, <code class="highlighter-rouge">Prawn::Core::RawChunk</code> objects. These objects are where the actual text that is in our <code class="highlighter-rouge">to_pdf()</code> is stored. With that in mind, we can now look at the actual objects that this graphics system is built on.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Prawn</span>
  <span class="k">module</span> <span class="nn">Core</span>
    <span class="k">class</span> <span class="nc">RawChunk</span>
      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="vi">@content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="vi">@command</span> <span class="o">=</span> <span class="ss">:raw_pdf_text</span>
        <span class="vi">@params</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">end</span>

      <span class="kp">attr_accessor</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:command</span><span class="p">,</span> <span class="ss">:params</span>
      <span class="kp">alias_method</span> <span class="ss">:to_pdf</span><span class="p">,</span> <span class="ss">:content</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Chunk</span>
      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="o">&amp;</span><span class="n">action</span><span class="p">)</span>
        <span class="vi">@command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="vi">@params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="vi">@action</span> <span class="o">=</span> <span class="n">action</span>
      <span class="k">end</span>

      <span class="kp">attr_reader</span> <span class="ss">:command</span><span class="p">,</span> <span class="ss">:params</span><span class="p">,</span> <span class="ss">:action</span>

      <span class="k">def</span> <span class="nf">content</span>
        <span class="n">action</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">to_pdf</span>
        <span class="k">case</span> <span class="n">results</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">when</span> <span class="no">Array</span>
          <span class="n">results</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">sub_chunk</span><span class="o">|</span> <span class="n">sub_chunk</span><span class="p">.</span><span class="nf">to_pdf</span> <span class="p">}.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">when</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">Chunk</span><span class="p">,</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RawChunk</span>
          <span class="n">results</span><span class="p">.</span><span class="nf">to_pdf</span>
        <span class="k">else</span>
          <span class="k">raise</span> <span class="s2">"Bad Chunk: </span><span class="si">#{</span><span class="n">results</span><span class="p">.</span><span class="nf">class</span><span class="si">}</span><span class="s2"> not supported"</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>From this we see that a chunk’s content can be an array of children, a chunk, or a raw chunk object. The <code class="highlighter-rouge">to_pdf()</code> method is responsible for traversing downwards through the composition until it reaches the raw chunk objects which simply return the raw content. But because the APIs match, we can look at the chunks at any level of the system and burrow down to their raw data.</p>

<p>While this might be a bit of an intense example, it shows how the Composite pattern can be used to make a complex set of objects look and feel as if they were a single unified entity. It may be a bit much to take in on a first glance, but try to think of how you could apply these ideas to your own code and you might gain some useful insights.</p>

<h3 id="proxy">Proxy</h3>

<p>A <a href="http://en.wikipedia.org/wiki/Proxy_pattern">Proxy</a> is any object that acts as a drop-in replacement object that does a bit of work and then delegates to some other underlying object. This is another pattern that’s easy to recognize for Rails developers, because it is used extensively in ActiveRecord associations support. The following example shows a typical interaction between a base model and one of its associations.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">quiz</span> <span class="o">=</span> <span class="no">Quiz</span><span class="p">.</span><span class="nf">first</span>
<span class="n">quiz</span><span class="p">.</span><span class="nf">questions</span><span class="p">.</span><span class="nf">class</span> <span class="c1">#=&gt; Array</span>

<span class="n">quiz</span><span class="p">.</span><span class="nf">questions</span><span class="p">.</span><span class="nf">count</span> <span class="c1">#=&gt; 10</span>

<span class="n">quiz</span><span class="p">.</span><span class="nf">questions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:question_text</span> <span class="o">=&gt;</span> <span class="s2">"Who is the creator of Ruby?"</span><span class="p">,</span>
                      <span class="ss">:answer</span>        <span class="o">=&gt;</span> <span class="s2">"Matz"</span><span class="p">)</span>

<span class="n">quiz</span><span class="p">.</span><span class="nf">questions</span><span class="p">.</span><span class="nf">count</span> <span class="c1">#=&gt; 11</span>

<span class="n">quiz</span><span class="p">.</span><span class="nf">questions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">answer</span> <span class="c1">#=&gt; "Matz" </span>
</code></pre>
</div>

<p>While the questions association claims to be an array, it also provides some of the common helpers found in <code class="highlighter-rouge">ActiveRecord::Base</code>. If we stick to the core idea and ignore some of the Rails specific details, creating such an association proxy is fairly easy to do using Ruby’s delegate standard library. The code below more or less does the trick.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"delegate"</span>

<span class="k">class</span> <span class="nc">Quiz</span>
  <span class="k">def</span> <span class="nf">questions</span>
    <span class="vi">@questions</span>                  <span class="o">||=</span> <span class="no">HasManyAssociation</span><span class="p">.</span><span class="nf">new</span><span class="p">([])</span>
    <span class="vi">@questions</span><span class="p">.</span><span class="nf">associated_class</span> <span class="o">||=</span> <span class="no">Question</span>

    <span class="vi">@questions</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Question</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="vi">@params</span> <span class="o">=</span> <span class="n">params</span>
  <span class="k">end</span>

  <span class="kp">attr_reader</span> <span class="ss">:params</span>

  <span class="k">def</span> <span class="nf">answer</span>
    <span class="n">params</span><span class="p">[</span><span class="ss">:answer</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">HasManyAssociation</span> <span class="o">&lt;</span> <span class="no">DelegateClass</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span>
  <span class="kp">attr_accessor</span> <span class="ss">:associated_class</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="k">super</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="nb">self</span> <span class="o">&lt;&lt;</span> <span class="n">associated_class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">quiz</span> <span class="o">=</span> <span class="no">Quiz</span><span class="p">.</span><span class="nf">new</span>

<span class="c1"># grab the proxy object</span>
<span class="n">questions</span> <span class="o">=</span> <span class="n">quiz</span><span class="p">.</span><span class="nf">questions</span>


<span class="c1"># use custom create() method on proxy object</span>

<span class="n">questions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:question_text</span> <span class="o">=&gt;</span> <span class="s2">"Who is the creator of Ruby?"</span><span class="p">,</span>
                 <span class="ss">:answer</span>        <span class="o">=&gt;</span> <span class="s2">"Matz"</span><span class="p">)</span>
<span class="n">questions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">:question_text</span> <span class="o">=&gt;</span> <span class="s2">"Who is the creator of Perl?"</span><span class="p">,</span>
                 <span class="ss">:answer</span>        <span class="o">=&gt;</span> <span class="s2">"Larry Wall"</span><span class="p">)</span>


<span class="c1"># use array like behavior on proxy object</span>

<span class="nb">p</span> <span class="n">questions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">answer</span> <span class="c1">#=&gt; "Matz"</span>
<span class="nb">p</span> <span class="n">questions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">answer</span> <span class="c1">#=&gt; "Larry Wall"</span>
<span class="nb">p</span> <span class="n">questions</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span> <span class="n">q</span><span class="p">.</span><span class="nf">answer</span> <span class="p">}.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span> <span class="c1">#=&gt; "Matz, Larry Wall"</span>
</code></pre>
</div>

<p>Interestingly enough, while Ruby provides a standard library for building Proxy objects, most people tend to implement them in a different way, through the use of an explicit <code class="highlighter-rouge">method_missing()</code> hook on a blank slate object such as Ruby 1.9’s BasicObject. For example, we could have written our HasManyAssociation code in the manner shown below and things would still work as expected.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HasManyAssociation</span> <span class="o">&lt;</span> <span class="no">BasicObject</span>
  <span class="kp">attr_accessor</span> <span class="ss">:associated_class</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="vi">@array</span> <span class="o">=</span> <span class="n">array</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="nb">self</span> <span class="o">&lt;&lt;</span> <span class="n">associated_class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
    <span class="vi">@array</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Without looking at the source, I’m almost sure that Rails does something similar to this, because doing some_association.class returns Array rather than the name of the proxy object. This is the only noticeable difference between this approach and the DelegateClass approach.</p>

<p>Personally, I’ve written proxies in both ways, and I tend to prefer the <code class="highlighter-rouge">DelegateClass()</code> approach slightly, simply because it’s more explicit and doesn’t require me to explicitly define a <code class="highlighter-rouge">method_missing()</code> hook. But on the other hand, we can see that rolling your own proxy implementation is trivial in Ruby, and some may prefer the self contained nature of doing the delegation work yourself. It’d be interesting to hear what readers have to say on this topic, so please feel free to post to the mailing list if you prefer one approach over the other.</p>

<h3 id="decorator">Decorator</h3>

<p>While there is a clear distinction between a <a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorator</a> and a Proxy in static languages, in Ruby the two concepts almost merge, except that a Decorator is used for the purpose of adding / extending behavior of a target object, and a Proxy is a more general concept.</p>

<p>Since I’ve already written up a cool example of using decorators on this blog, I think what I’ll do is point you over there in the interest of keeping this article from being even more incredibly long than it already is. Check out the <a href="http://blog.rubybestpractices.com/posts/gregory/008-decorator-delegator-disco.html">Decorator Delegator Disco</a> if you want to see some interesting code samples that implement this pattern.</p>

<h3 id="facade">Facade</h3>

<p>The <a href="http://en.wikipedia.org/wiki/Facade_pattern">Facade pattern</a> simplifies how users interact with a codebase by implementing an interface that hides many implementation details for the most common behaviors needed by consumers. Looking at it from the outside, a perfect example of this is the open-uri standard library. When using open-uri, it is possible to do a simple HTTP get request with just a single line of code, as shown below.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"open-uri"</span>

<span class="nb">puts</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"http://www.google.com"</span><span class="p">).</span><span class="nf">read</span>
</code></pre>
</div>

<p>The purpose of open-uri is to make reading a resource via an HTTP GET request look and feel like opening an ordinary file. This is a very common use case, so open-uri makes it easy to work with. To see what this facade is hiding, we can write the equivalent code using the libraries it wraps, <code class="highlighter-rouge">Net::HTTP</code> and <code class="highlighter-rouge">URI</code>.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'net/http'</span>
<span class="nb">require</span> <span class="s1">'uri'</span>

<span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s1">'http://www.google.com'</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="n">url</span><span class="p">.</span><span class="nf">port</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">http</span><span class="o">|</span>
  <span class="n">http</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/index.html'</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">puts</span> <span class="n">res</span><span class="p">.</span><span class="nf">body</span>
</code></pre>
</div>

<p>While the code above isn’t especially difficult to read, it certainly feels like more work than the previous example. This is primarily because of the flexibility and functionality tradeoff between the two approaches. The open-uri library can afford to be much more high level and limited in scope because its sole purpose is to help make a single particular task easier. On the other hand, <code class="highlighter-rouge">Net::HTTP</code> and <code class="highlighter-rouge">URI</code> are both complex tools that can be used for a number of different things. The use of the Facade pattern allows for both kinds of objects to coexist peacefully within a single system.</p>

<p>It’s worth keeping in mind that pretty much every DSL you encounter is a Facade of some form or another. If you’re interested in seeing how simple interfaces can mask highly complex networks of objects, consider doing a source dive into your favorite tool that utilizes a domain specific language, such as Rake, RSpec, or Sinatra. You’ll find a number of different techniques at work depending on which project you explore, but all have the common characteristic of providing a simplified way to interact with a deep system.</p>

<h3 id="flyweight">Flyweight</h3>

<p>The <a href="http://en.wikipedia.org/wiki/Flyweight_pattern">Flyweight pattern</a> is a way to represent what would seem like a large amount of data in a lightweight way. This is one of those patterns that mostly goes away in Ruby due to built in language constructs, but it’s worth taking a look at just for the sake of completeness.</p>

<p>The wikipedia article linked above discusses font metrics as a common application of the flyweight pattern, in which you may want to associate each character in a string with a large amount of information describing how that character should be rendered. The basic idea is that it’d be far too inefficient memory-wise to create a new instance of font metrics data for every character in a document. So instead, using the Flyweight pattern, it is possible to map the index of characters in a string to a single instance for each unique character, vastly reducing the amount of memory consumed. This is a problem I’ve actually had to solve before within Prawn, but it’s a bit of a tough one demonstrate briefly if we attempt to show real code.</p>

<p>However, if we stub out the actual font metrics generation, it’s easy to see that this problem can be solved by wrapping a simple Ruby hash that has an initializer block.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FontMetrics</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="vi">@string</span> <span class="o">=</span> <span class="n">string</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">glyph_data</span><span class="p">[</span><span class="vi">@string</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">glyph_data</span>
    <span class="vi">@glyph_data</span> <span class="o">||=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="o">|</span> <span class="n">h</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics_for</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># stubbed out, but would typcially refer to something</span>
  <span class="c1"># largish and time consuming to generate</span>
  <span class="c1"># </span>
  <span class="k">def</span> <span class="nf">metrics_for</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">:bbox</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span> <span class="p">}</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="n">string</span> <span class="o">=</span> <span class="s2">"Hello World"</span>

<span class="n">metrics</span> <span class="o">=</span> <span class="no">FontMetrics</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

<span class="nb">p</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1">#=&gt; {:bbox=&gt;[86, 44, 88, 31]}</span>
<span class="nb">p</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1">#=&gt; {:bbox=&gt;[52, 7, 38, 98]}</span>
<span class="nb">p</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1">#=&gt; {:bbox=&gt;[52, 7, 38, 98]}</span>
<span class="nb">p</span> <span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#=&gt; {:bbox=&gt;[52, 7, 38, 98]}</span>

<span class="nb">p</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">object_id</span> <span class="o">==</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nf">object_id</span> <span class="c1">#=&gt; true</span>

<span class="nb">p</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#=&gt; false</span>
<span class="nb">p</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="c1">#=&gt; true</span>
</code></pre>
</div>

<p>From the above code, we see that the <code class="highlighter-rouge">FontMetrics</code> object gives the appearance of having data for each and every character in the string, but checking the <code class="highlighter-rouge">object_id</code> for each proves that only one object per unique character has been created. While I suppose we could call this a Flyweight, I think that in Ruby we’d just say that we were caching the metrics data using a hash with an initializer. But perhaps using this vocabulary wouldn’t hurt, if we want to keep our minds focused on the high level concepts.</p>

<h3 id="reflections">Reflections</h3>

<p>After writing two articles on the the topic, I’m finding myself getting sick of design patterns. But when I look back on the code I’ve shared with you, I realize that when I built these things, I never really thought consciously about what pattern they were, and it took me until the time of writing this article to put a name on them.</p>

<p>A major concern I have about classical patterns is that in order to see the resemblance of the code I’ve shared to the original GoF patterns, you really need to look at things sideways and squint a bit. It’d be great for me to be able to just say ‘Use a flyweight here’ and have it mean something, but if you say that to someone without a strong background in Ruby, you may end up with hundreds of lines of a Java-esque monstrosity.</p>

<p>To be sure, I’m not saying that this exploration has not been worthwhile. Forcing myself to think of how many of the classic GoF patterns might materialize themselves in Ruby has been a very interesting experience, because it’s really making me think about how we build and design our code. But the problem of whether we can actually have a common vocabulary about concepts that really get distorted in translation makes me wonder about the merits of stacking up pattern definitions, at least without giving them new names.</p>

<p>I’m quite curious about what folks have been thinking as they read through the last two articles, in particular, I wonder if seeing me try to attack patterns from a purely pragmatic perspective has changed anything about the way readers look at these concepts. I’m also kind of curious if ‘that guy’ is out there, silently thinking to himself “Well… actually” after seeing my somewhat liberal interpretation of these classic patterns. Please leave a comment letting me know what you think!</p>

<blockquote>
  <p><strong>NOTE:</strong> This article has also been published on the Ruby Best Practices blog. There <a href="http://blog.rubybestpractices.com/posts/gregory/060-issue-26-structural-design-patterns.html#disqus_thread">may be additional commentary</a> 
over there worth taking a look at.</p>
</blockquote>

  </div>

  <div style="text-align: center">
    <h3><a href="/">Want to keep reading? Check out the archives for more.</a></h3>

    <small>Practicing Ruby is proudly independent, open source, and advertising free.<br/>If you insist on being asked for something in return, check out <a href="/support">how to support my work</a>.</small>
  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
