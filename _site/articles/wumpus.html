<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hunt the Wumpus: An exercise in creative coding</title>
  <meta name="description" content="Hunt the Wumpus is a hide-and-seek game that takes place in an undergroundcave network full of interconnected rooms. To win the game, the playerneeds to loca...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/wumpus">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
          <a class="page-link" href="/about">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Hunt the Wumpus: An exercise in creative coding</h1>
    <p class="post-meta"><time datetime="2013-12-11T00:00:00-05:00" itemprop="datePublished">Dec 11, 2013</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="http://en.wikipedia.org/wiki/Hunt_the_Wumpus">Hunt the Wumpus</a> is a hide-and-seek game that takes place in an underground
cave network full of interconnected rooms. To win the game, the player
needs to locate the evil Wumpus and kill it while avoiding various different 
hazards that are hidden within in the cave.</p>

<p>Originally written by Gregory Yob in the 1970s, this game is traditionally
played using a text-based interface, which leaves plenty up to the
player’s imagination, and also makes programming easier for those who
want to build Wumpus-like games of their own.</p>

<p>Because of its simple but clever nature, Hunt the Wumpus has been ported 
to many different platforms and programming languages over the last several
decades. In this article, you will discover why this blast from the past 
serves as an excellent example of creative computing, and you’ll also 
learn how to implement it from scratch in Ruby.</p>

<h2 id="gameplay-demonstration">Gameplay demonstration</h2>

<p>There are only two actions available to the player throughout the game: to move
from room to room, or to shoot arrows into nearby rooms in an attempt to kill 
the Wumpus. Until the player knows for sure where the Wumpus is, most of their actions 
will be dedicated to moving around the cave to gain a sense of its layout:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>You are in room 1.
Exits go to: 2, 8, 5
-----------------------------------------
What do you want to do? (m)ove or (s)hoot? m
Where? 2
-----------------------------------------
You are in room 2.
Exits go to: 1, 10, 3
-----------------------------------------
What do you want to do? (m)ove or (s)hoot? m
Where? 10
-----------------------------------------
You are in room 10.
Exits go to: 2, 11, 9
</code></pre>
</div>

<p>Even after only a couple actions, the player can start to piece together
a map of the cave’s topography, which will help them avoid getting lost
as they continue their explorations:</p>

<p><img src="//i.imgur.com/5gCTOAt.png" alt="" /></p>

<p>Play continues in this fashion, with the player wandering around until 
a hazard is detected:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>What do you want to do? (m)ove or (s)hoot? m
Where? 11
-----------------------------------------
You are in room 11.
Exits go to: 10, 8, 20
-----------------------------------------
What do you want to do? (m)ove or (s)hoot? m
Where? 20
-----------------------------------------
You are in room 20.
You feel a cold wind blowing from a nearby cavern.
Exits go to: 11, 19, 17
</code></pre>
</div>

<p>In this case, the player has managed to get close
to a bottomless pit, which is detected by the presence of
a cold wind emanating from an adjacent room.</p>

<p>Because hazards are sensed indirectly, the player needs to use a deduction
process to know for sure which hazards are in what rooms. With the knowledge of
the cave layout so far, the only thing that is for certain is there is at least one
pit nearby, with both rooms 17 and 19 being possible candidates. One of them
might be safe, but there is also a chance that BOTH rooms contain pits.
In a literal sense, the player might have reached a dead end:</p>

<p><img src="//i.imgur.com/D6aA2wl.png" alt="" /></p>

<p>A risky player might chance it and try one of the two rooms, but
that isn’t a smart way to play. The safe option is to 
backtrack in search of a different path through the cave:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>What do you want to do? (m)ove or (s)hoot? m
Where? 11
-----------------------------------------
You are in room 11.
Exits go to: 10, 8, 20
-----------------------------------------
What do you want to do? (m)ove or (s)hoot? m
Where? 8
-----------------------------------------
You are in room 8.
You smell something terrible nearby
Exits go to: 11, 1, 7
</code></pre>
</div>

<p>Changing directions ends up paying off. Upon entering room 8,
the terrible smell that is sensed indicates that the Wumpus is nearby,
and because rooms 1 and 11 have already been visited, there
is only one place left for the Wumpus to be hiding:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>What do you want to do? (m)ove or (s)hoot? s
Where? 7
-----------------------------------------
YOU KILLED THE WUMPUS! GOOD JOB, BUDDY!!!
</code></pre>
</div>

<p>At the end of the hunt, the player’s map ended up looking like this:</p>

<p><img src="//i.imgur.com/IZnqNNw.png" alt="" /></p>

<p>In less fortunate circumstances, the player would need to do a lot more
exploration before they could be certain about where the Wumpus 
was hiding. Other hazards might also be encountered, including giant bats 
that are capable of moving the player to a random location in the cave.
Because all these factors are randomized in each new game, Hunt the Wumpus
can be played again and again without ever encountering an identical
cave layout.</p>

<p>We will discuss more about the game rules throughout the rest of this
article, but the few concepts illustrated in this demonstration are more 
than enough for us to start modeling some of the key game objects.
Let’s get to work!</p>

<h2 id="implementing-hunt-the-wumpus-from-scratch">Implementing “Hunt the Wumpus” from scratch</h2>

<p>Like many programs from its era, Hunt the Wumpus was designed to 
be hackable. If you look at one of the <a href="http://www.atariarchives.org/bcc1/showpage.php?page=247">original publications</a>
about the game, you can see that the author actively encourages
tweaking its rules, and even includes the full source code 
of the game.</p>

<p>Before you rush off to study the original implementation, remember that 
it was written four decades ago in BASIC. Unless you consider yourself
a technological archaeologist, it’s probably not the best way to
learn about the game. With that in mind, I’ve put together a learning
exercise that will guide you through implementing some of the core 
game concepts of Hunt the Wumpus – without getting bogged down in
specific game rules or having to write boring user interface code.</p>

<p>In particular, I want you to implement three classes that I have 
already written the tests for:</p>

<ol>
  <li>A <code class="highlighter-rouge">Wumpus::Room</code> class to manage hazards and connections between rooms</li>
  <li>A <code class="highlighter-rouge">Wumpus::Cave</code> class to manage the overall topography of the cave</li>
  <li>A <code class="highlighter-rouge">Wumpus::Player</code> class that handles sensing and encountering hazards</li>
</ol>

<p>You can work through this exercise by <a href="https://github.com/elm-city-craftworks/wumpus">cloning its git repository</a>, 
and following the instructions in the README. I have put the tests for each 
class on its own branch, so that you can merge them into your own code 
one at a time until you end up with a complete passing test suite.</p>

<p>Once these three classes are written, you’ll be able to use my UI code 
and game logic to play a rousing round of Hunt the Wumpus. You’ll
also be able to compare your own work to my <a href="https://github.com/elm-city-craftworks/wumpus/tree/reference_implementation">reference implementation</a>
of the game, and discuss any questions or thoughts with me about
the differences between our approaches.</p>

<p>Throughout the rest of this article, I will provide design and implementation
notes for each class, as well as a brief overview of how the game rules for
Hunt the Wumpus can be implemented using these objects. These notes
should help you interpret what the test suite is actually asking
you to build, and will also help you understand my reference
implementation.</p>

<blockquote>
  <p><strong>NOTE:</strong> If you’re short on time or aren’t in the mood for hacking
right now, you can still get a lot out of this exercise by simply 
thinking about how you’d write the code to pass the provided test 
suite, and then looking my implementation. But it’s definitely
better to at least <em>try</em> to write some code yourself, even
if you don’t complete the full exercise.</p>
</blockquote>

<h2 id="modeling-rooms">Modeling rooms</h2>

<p>Structurally speaking, rooms and their connections form a simple undirected graph:</p>

<p><img src="//i.imgur.com/p81T0Gn.png" alt="" /></p>

<p>Our <code class="highlighter-rouge">Room</code> class will manage these connections, and also make it easy 
to query and manipulate the hazards that can be found in a room –
including bats, pits, and the wumpus itself. In particular, we will
build an object with the following attributes and behaviors:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"A room"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"has a number"</span>
  <span class="n">it</span> <span class="s2">"may contain hazards"</span>

  <span class="n">describe</span> <span class="s2">"with neighbors"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"has two-way connections to neighbors"</span>
    <span class="n">it</span> <span class="s2">"knows the numbers of all neighboring rooms"</span>
    <span class="n">it</span> <span class="s2">"can choose a neighbor randomly"</span>
    <span class="n">it</span> <span class="s2">"is not safe if it has hazards"</span> 
    <span class="n">it</span> <span class="s2">"is not safe if its neighbors have hazards"</span>
    <span class="n">it</span> <span class="s2">"is safe when it and its neighbors have no hazards"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Let’s walk through each of these requirements individually and fill
in the necessary details.</p>

<p>1) Every room has an identifying number that helps the player keep 
track of where they are:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"A room"</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:room</span><span class="p">)</span> <span class="p">{</span> <span class="no">Wumpus</span><span class="o">::</span><span class="no">Room</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"has a number"</span> <span class="k">do</span>
    <span class="n">room</span><span class="p">.</span><span class="nf">number</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>2) Rooms may contain hazards, which can be added or removed as the 
game progresses:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"may contain hazards"</span> <span class="k">do</span> 
  <span class="c1"># rooms start out empty</span>
  <span class="n">assert</span> <span class="n">room</span><span class="p">.</span><span class="nf">empty?</span>

  <span class="c1"># hazards can be added</span>
  <span class="n">room</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span>
  <span class="n">room</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>

  <span class="c1"># a room with hazards isn't empty</span>
  <span class="n">refute</span> <span class="n">room</span><span class="p">.</span><span class="nf">empty?</span>

  <span class="c1"># hazards can be detected by name</span>
  <span class="n">assert</span> <span class="n">room</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span>
  <span class="n">assert</span> <span class="n">room</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>

  <span class="n">refute</span> <span class="n">room</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:alf</span><span class="p">)</span>

  <span class="c1"># hazards can be removed</span>
  <span class="n">room</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>
  <span class="n">refute</span> <span class="n">room</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>3) Each room can be connected to other rooms in the cave:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"with neighbors"</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:exit_numbers</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="p">}</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="n">exit_numbers</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">room</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="no">Wumpus</span><span class="o">::</span><span class="no">Room</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">}</span>
  <span class="k">end</span>

   <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>4) One-way paths are not allowed, i.e. all connections between rooms are
bidirectional:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"has two-way connections to neighbors"</span> <span class="k">do</span>
  <span class="n">exit_numbers</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> 
    <span class="c1"># a neighbor can be looked up by room number</span>
    <span class="n">room</span><span class="p">.</span><span class="nf">neighbor</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="nf">number</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="c1"># Room connections are bidirectional</span>
    <span class="n">room</span><span class="p">.</span><span class="nf">neighbor</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="nf">neighbor</span><span class="p">(</span><span class="n">room</span><span class="p">.</span><span class="nf">number</span><span class="p">).</span><span class="nf">must_equal</span><span class="p">(</span><span class="n">room</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>5) Each room knows all of its exits, which consist of
all neighboring room numbers:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"knows the numbers of all neighboring rooms"</span> <span class="k">do</span>
  <span class="n">room</span><span class="p">.</span><span class="nf">exits</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="n">exit_numbers</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>6) Neighboring rooms can be selected at random, which is
useful for certain game events:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"can choose a neighbor randomly"</span> <span class="k">do</span>
  <span class="n">exit_numbers</span><span class="p">.</span><span class="nf">must_include</span><span class="p">(</span><span class="n">room</span><span class="p">.</span><span class="nf">random_neighbor</span><span class="p">.</span><span class="nf">number</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>7) A room is considered safe only if there are no hazards within it
or any of its neighbors:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"is not safe if it has hazards"</span> <span class="k">do</span>
  <span class="n">room</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span>

  <span class="n">refute</span> <span class="n">room</span><span class="p">.</span><span class="nf">safe?</span>
<span class="k">end</span>

<span class="n">it</span> <span class="s2">"is not safe if its neighbors have hazards"</span> <span class="k">do</span>
  <span class="n">room</span><span class="p">.</span><span class="nf">random_neighbor</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span>

  <span class="n">refute</span> <span class="n">room</span><span class="p">.</span><span class="nf">safe?</span>
<span class="k">end</span>

<span class="n">it</span> <span class="s2">"is safe when it and its neighbors have no hazards"</span> <span class="k">do</span>
  <span class="n">assert</span> <span class="n">room</span><span class="p">.</span><span class="nf">safe?</span>
<span class="k">end</span>
</code></pre>
</div>

<p><strong>Implementation notes</strong></p>

<p>Because this object only handles basic data tranformations, it
shouldn’t be hard to implement. But if you get stuck, you
can always look at <a href="https://github.com/elm-city-craftworks/wumpus/blob/reference_implementation/lib/wumpus/room.rb">my version of the Wumpus::Room class</a>.</p>

<h2 id="modeling-the-cave">Modeling the cave</h2>

<p>Although a game of Hunt the Wumpus can be played with an arbitrary cave layout,
the traditional Wumpus cave is based on the <a href="http://en.wikipedia.org/wiki/Dodecahedron">dodecahedron</a>. To
model things this way, a room is placed at each vertex, and the edges form
the connections between rooms. If you squash the structure to fit in a
two-dimensional space, you end up with the following graph:</p>

<p><img src="//i.imgur.com/Myxk4vS.png" alt="" /></p>

<p>Even though it would be technically possible to construct this structure without
a collection object by connecting rooms together in an ad-hoc fashion,
traversing the structure and manipulating it would be cumbersome. For that
reason, we will build a <code class="highlighter-rouge">Wumpus::Cave</code> object with the following properties:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"A cave"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"has 20 rooms that each connect to exactly three other rooms"</span> 
  <span class="n">it</span> <span class="s2">"can select rooms at random"</span>
  <span class="n">it</span> <span class="s2">"can move hazards from one room to another"</span>
  <span class="n">it</span> <span class="s2">"can add hazards at random to a specific number of rooms"</span>
  <span class="n">it</span> <span class="s2">"can find a room with a particular hazard"</span>
  <span class="n">it</span> <span class="s2">"can find a safe room to serve as an entrance"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Some of these features a bit tricky to explain comprehensively through
tests, but the following examples should give you a basic idea of
how they’re meant to work.</p>

<p>1) The cave has 20 rooms, and each room is connected to exactly 
three other rooms:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"A cave"</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:cave</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Wumpus</span><span class="o">::</span><span class="no">Cave</span><span class="p">.</span><span class="nf">dodecahedron</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:rooms</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="nf">.</span><span class="mi">20</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">cave</span><span class="p">.</span><span class="nf">room</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s2">"has 20 rooms that each connect to exactly three other rooms"</span> <span class="k">do</span>
    <span class="n">rooms</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">room</span><span class="o">|</span>
      <span class="n">room</span><span class="p">.</span><span class="nf">neighbors</span><span class="p">.</span><span class="nf">count</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      
      <span class="n">assert</span> <span class="n">room</span><span class="p">.</span><span class="nf">neighbors</span><span class="p">.</span><span class="nf">all?</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">neighbors</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">room</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The intent here is to loosly verify that the layout is dodecahedron 
shaped, but it is more of a sanity check than a strict validation.
A stronger check would require us to compute things like minimal
cycles for each point, which would make for a much more 
complicated test.</p>

<p>In my implementation I use a JSON file that hard-codes the 
connections between each room explicitly rather than trying to 
automatically generate the layout, so this test is mostly just to catch errors 
with that configuration file. If you reuse the <a href="https://raw.github.com/elm-city-craftworks/wumpus/reference_implementation/data/dodecahedron.json">dodecahredon.json</a> 
file in your own code, it should make passing these tests easy.</p>

<p>2) Rooms in the cave can be selected randomly:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"can select rooms at random"</span> <span class="k">do</span>
  <span class="n">sampling</span> <span class="o">=</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span>

  <span class="c1"># see test/helper.rb for how this assertion works</span>
  <span class="n">must_eventually</span><span class="p">(</span><span class="s2">"randomly select each room"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">new_room</span> <span class="o">=</span> <span class="n">cave</span><span class="p">.</span><span class="nf">random_room</span> 
    <span class="n">sampling</span> <span class="o">&lt;&lt;</span> <span class="n">new_room</span>

    <span class="n">sampling</span> <span class="o">==</span> <span class="no">Set</span><span class="p">[</span><span class="o">*</span><span class="n">rooms</span><span class="p">]</span> 
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This feature is important for implementing the behavior of giant bats, who move
the player to a random location in the cave. It is also useful for hazard
placement, as we’ll see later. The way I test the behavior is a bit awkward,
but the basic idea is that if you keep selecting rooms at random, you’ll
eventually hit every room in the cave.</p>

<p>3) Hazards can be moved from one room to another:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"can move hazards from one room to another"</span> <span class="k">do</span>
  <span class="n">room</span>      <span class="o">=</span> <span class="n">cave</span><span class="p">.</span><span class="nf">random_room</span>
  <span class="n">neighbor</span>  <span class="o">=</span> <span class="n">room</span><span class="p">.</span><span class="nf">neighbors</span><span class="p">.</span><span class="nf">first</span>

  <span class="n">room</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>

  <span class="n">assert</span> <span class="n">room</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>
  <span class="n">refute</span> <span class="n">neighbor</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>

  <span class="n">cave</span><span class="p">.</span><span class="nf">move</span><span class="p">(</span><span class="ss">:bats</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="n">room</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="n">neighbor</span><span class="p">)</span>

  <span class="n">refute</span> <span class="n">room</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>
  <span class="n">assert</span> <span class="n">neighbor</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This test shows bats being moved from a random room to
one of its neighbors, but <code class="highlighter-rouge">Cave#move</code> can used to move any hazard
between any two rooms in the cave, even if they are not
adajecent to each other.</p>

<p>4) Hazards can be randomly distributed throughout the cave:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"can add hazards at random to a specific number of rooms"</span> <span class="k">do</span>
  <span class="n">cave</span><span class="p">.</span><span class="nf">add_hazard</span><span class="p">(</span><span class="ss">:bats</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

  <span class="n">rooms</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span> <span class="p">}.</span><span class="nf">count</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>For the most part, the work to be done here is just to pick
some rooms at random and add hazards
to them. However, because there is no sense in adding a single
type of hazard to a room more than once, <code class="highlighter-rouge">Cave#add_hazard</code>
should take care to select only rooms that do not already have
the specified hazard in them. This is hinted at by the specs,
but because the check is a loose one, just keep this detail
in mind while implementing this method.</p>

<p>5) Rooms can be looked up based on the hazards they contain:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"can find a room with a particular hazard"</span> <span class="k">do</span>
  <span class="n">cave</span><span class="p">.</span><span class="nf">add_hazard</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

  <span class="n">assert</span> <span class="n">cave</span><span class="p">.</span><span class="nf">room_with</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">).</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In my implementation, I just grab the first room that matches the 
criteria, but any matching room would be acceptable. It
would also make sense to have a <code class="highlighter-rouge">Cave#all_rooms_with</code> method, but it isn’t needed for a basic implementation
of the game.</p>

<p>6) A safe entrance can be located:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"can find a safe room to serve as an entrance"</span> <span class="k">do</span>
  <span class="n">cave</span><span class="p">.</span><span class="nf">add_hazard</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">cave</span><span class="p">.</span><span class="nf">add_hazard</span><span class="p">(</span><span class="ss">:pit</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">cave</span><span class="p">.</span><span class="nf">add_hazard</span><span class="p">(</span><span class="ss">:bats</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

  <span class="n">entrance</span> <span class="o">=</span> <span class="n">cave</span><span class="p">.</span><span class="nf">entrance</span>

  <span class="n">assert</span> <span class="n">entrance</span><span class="p">.</span><span class="nf">safe?</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This is where the <code class="highlighter-rouge">Wumpus::Room#safe?</code> method comes in handy. Picking any room
that passes that condition is enough to get the job done here.</p>

<p><strong>Implementation notes</strong></p>

<p>The desired behavior of the <code class="highlighter-rouge">Wumpus::Cave</code> class is admittedly a bit
underspecified here, but in many cases minor variations won’t effect
gameplay all that much. Some of these operations are also intentionally 
a bit more general than what is strictly needed for the game, to permit 
some experimentation with rule changes once you have a working implementation.</p>

<p>This was a challenging object for me to design and test, because many 
of the features which are intuitively obvious are hard to specify 
formally. Do the best you can with building it, and refer
to <a href="https://github.com/elm-city-craftworks/wumpus/blob/reference_implementation/lib/wumpus/cave.rb">my implementation of the Wumpus::Cave class</a> whenever 
you hit any snags.</p>

<h2 id="modeling-the-player">Modeling the player</h2>

<p>Despite the complexity of the cave layout, most game events in 
Hunt the Wumpus are triggered by local conditions based on the 
player’s current room and its direct neighbors. For example, 
imagine that the player is positioned in Room #1 as shown in 
following diagram:</p>

<p><img src="//i.imgur.com/A0e5pMn.png" alt="" /></p>

<p>With this setup, the player would sense the nearby hazards,
resulting in the following output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>You are in room 1.
You hear a rustling sound nearby
You smell something terrible nearby
Exits go to: 2, 3, 4
</code></pre>
</div>

<p>Ordinarily we’d need to do some investigation work to discover which hazards
were where, but because this is a contrived scenario, we don’t 
need to guess. Knowing the layout of the neighborhood, we can enumerate the 
possible outcomes for any player action:</p>

<ul>
  <li>The player will encounter the wumpus upon moving into room 2.</li>
  <li>The player will encounter bats upon moving into room 3.</li>
  <li>The player will not encounter any hazards in room 4.</li>
  <li>The player can shoot into room 2 to kill the wumpus.</li>
  <li>The player will miss the wumpus by shooting into room 3 or 4.</li>
</ul>

<p>If you take this single example and generalize it, you’ll find that every turn
of Hunt the Wumpus involves only three distinct kinds of events:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"the player"</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s2">"can sense hazards in neighboring rooms"</span> 
  <span class="n">it</span> <span class="s2">"can encounter hazards when entering a room"</span>
  <span class="n">it</span> <span class="s2">"can perform actions on neighboring rooms"</span> 
<span class="k">end</span>
</code></pre>
</div>

<p>With these requirements in mind, it is possible for us to model 
the <code class="highlighter-rouge">Wumpus::Player</code> class as an event-driven object that handles 
each event type listed above. The only state it needs to explicitly
maintain is a reference to the room currently being explored: everything 
else can be managed externally through callbacks. You’ll see why this
is useful when we look at how the game rules are implemented later,
but for now just try to follow along as best as you can.</p>

<p>The test setup for the <code class="highlighter-rouge">Wumpus::Player</code> class is a bit complicated, mostly 
because we need to reconstruct something similar to the layout shown in the
previous diagram in order to meaningfully test its behavior:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"the player"</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:player</span><span class="p">)</span> <span class="p">{</span> <span class="no">Wumpus</span><span class="o">::</span><span class="no">Player</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:empty_room</span><span class="p">)</span> <span class="p">{</span> <span class="no">Wumpus</span><span class="o">::</span><span class="no">Room</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:wumpus_room</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Wumpus</span><span class="o">::</span><span class="no">Room</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:bat_room</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Wumpus</span><span class="o">::</span><span class="no">Room</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">tap</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In addition to wiring up some rooms, I also register all of the events we’re 
interested in tracking during setup, using some dummy callbacks that are
meant to serve as stand-ins for real game logic. This is not an
elegant way of building a test harness, but it gets the job done:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">let</span><span class="p">(</span><span class="ss">:sensed</span><span class="p">)</span>      <span class="p">{</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
<span class="n">let</span><span class="p">(</span><span class="ss">:encountered</span><span class="p">)</span> <span class="p">{</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

<span class="n">before</span> <span class="k">do</span>
  <span class="n">empty_room</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">bat_room</span><span class="p">)</span>
  <span class="n">empty_room</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">wumpus_room</span><span class="p">)</span>

  <span class="n">player</span><span class="p">.</span><span class="nf">sense</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">sensed</span> <span class="o">&lt;&lt;</span> <span class="s2">"You hear a rustling"</span>
  <span class="k">end</span>

  <span class="n">player</span><span class="p">.</span><span class="nf">sense</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">sensed</span> <span class="o">&lt;&lt;</span> <span class="s2">"You smell something terrible"</span>
  <span class="k">end</span>

  <span class="n">player</span><span class="p">.</span><span class="nf">encounter</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">encountered</span> <span class="o">&lt;&lt;</span> <span class="s2">"The wumpus ate you up!"</span>
  <span class="k">end</span>

  <span class="n">player</span><span class="p">.</span><span class="nf">encounter</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">encountered</span> <span class="o">&lt;&lt;</span> <span class="s2">"The bats whisk you away!"</span>
  <span class="k">end</span>

  <span class="n">player</span><span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="ss">:move</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">destination</span><span class="o">|</span>
    <span class="n">player</span><span class="p">.</span><span class="nf">enter</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Once all of that is taken care of, the callbacks can be tested in isolated
scenarios:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">it</span> <span class="s2">"can sense hazards in neighboring rooms"</span> <span class="k">do</span>
  <span class="n">player</span><span class="p">.</span><span class="nf">enter</span><span class="p">(</span><span class="n">empty_room</span><span class="p">)</span>
  <span class="n">player</span><span class="p">.</span><span class="nf">explore_room</span>

  <span class="n">sensed</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="no">Set</span><span class="p">[</span><span class="s2">"You hear a rustling"</span><span class="p">,</span> <span class="s2">"You smell something terrible"</span><span class="p">])</span>
  
  <span class="n">assert</span> <span class="n">encountered</span><span class="p">.</span><span class="nf">empty?</span>
<span class="k">end</span>

<span class="n">it</span> <span class="s2">"can encounter hazards when entering a room"</span> <span class="k">do</span>
  <span class="n">player</span><span class="p">.</span><span class="nf">enter</span><span class="p">(</span><span class="n">bat_room</span><span class="p">)</span>
  <span class="n">encountered</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="no">Set</span><span class="p">[</span><span class="s2">"The bats whisk you away!"</span><span class="p">])</span>
  
  <span class="n">assert</span> <span class="n">sensed</span><span class="p">.</span><span class="nf">empty?</span> 
<span class="k">end</span>

<span class="n">it</span> <span class="s2">"can perform actions on neighboring rooms"</span> <span class="k">do</span>
  <span class="n">player</span><span class="p">.</span><span class="nf">act</span><span class="p">(</span><span class="ss">:move</span><span class="p">,</span> <span class="n">wumpus_room</span><span class="p">)</span>
  <span class="n">player</span><span class="p">.</span><span class="nf">room</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="n">wumpus_room</span><span class="p">)</span>

  <span class="n">encountered</span><span class="p">.</span><span class="nf">must_equal</span><span class="p">(</span><span class="no">Set</span><span class="p">[</span><span class="s2">"The wumpus ate you up!"</span><span class="p">])</span>
  <span class="n">assert</span> <span class="n">sensed</span><span class="p">.</span><span class="nf">empty?</span>
<span class="k">end</span>
</code></pre>
</div>

<p>These test cases verify that the right callbacks have been called
by manipulating simple sets of strings, but the real use case for 
the <code class="highlighter-rouge">Wumpus::Player</code> class is to trigger  operations on 
game objects as well as the user interface. If you are having
trouble imagining what that would look like, it may help to 
read ahead a bit further before attempting to get these 
tests to pass.</p>

<p><strong>Implementation notes:</strong></p>

<p>Like the <code class="highlighter-rouge">Wumpus::Cave</code> class, this object is underspecified, but you probably
don’t need to build something identical to <a href="https://github.com/elm-city-craftworks/wumpus/blob/reference_implementation/lib/wumpus/player.rb">my implementation of Wumpus::Player</a>
in order to get the game to run. However, you may want to make an effort
to ensure that callbacks are triggered in the order that they are registered,
otherwise you can run into some interesting edge cases when more than one
condition is satisfied at the same time.</p>

<h2 id="defining-the-game-rules">Defining the game rules</h2>

<p>With a foundation in place, implementing the game logic for Hunt the
Wumpus is very easy. My version of the game simplifies the rules, but
hopefully still captures the spirit of the original.</p>

<p>As you walk through the following code, you can treat the
<code class="highlighter-rouge">Wumpus::Narrator</code> object as a black box. This is a boring object that
only does some basic I/O under the hood, so your time
would be better spent focusing on the game logic.</p>

<p>With that caveat out of the way, let’s take a look at how Hunt the Wumpus can be
implemented in terms of the three game objects we just built. To get started, we
need a cave!</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">cave</span> <span class="o">=</span> <span class="no">Wumpus</span><span class="o">::</span><span class="no">Cave</span><span class="p">.</span><span class="nf">dodecahedron</span>
</code></pre>
</div>

<p>This cave will contain three pits, three giant bats, and the most evil and
stinky Wumpus you could ever imagine:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">cave</span><span class="p">.</span><span class="nf">add_hazard</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">cave</span><span class="p">.</span><span class="nf">add_hazard</span><span class="p">(</span><span class="ss">:pit</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">cave</span><span class="p">.</span><span class="nf">add_hazard</span><span class="p">(</span><span class="ss">:bats</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</code></pre>
</div>

<p>We also need a player to navigate the cave, and a narrator to regale us with
tales about the player’s adventures:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">player</span>    <span class="o">=</span> <span class="no">Wumpus</span><span class="o">::</span><span class="no">Player</span><span class="p">.</span><span class="nf">new</span>
<span class="n">narrator</span>  <span class="o">=</span> <span class="no">Wumpus</span><span class="o">::</span><span class="no">Narrator</span><span class="p">.</span><span class="nf">new</span>
</code></pre>
</div>

<p>Whenever a player senses a hazard nearby, the narrator will give us a hint
of what kind of trouble lurks just around the bend:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">player</span><span class="p">.</span><span class="nf">sense</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">narrator</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">"You hear a rustling sound nearby"</span><span class="p">)</span> 
<span class="k">end</span>

<span class="n">player</span><span class="p">.</span><span class="nf">sense</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">narrator</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">"You smell something terrible nearby"</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">player</span><span class="p">.</span><span class="nf">sense</span><span class="p">(</span><span class="ss">:pit</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">narrator</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">"You feel a cold wind blowing from a nearby cavern."</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If upon entering a room the player encounters the Wumpus, it
will become startled. We’ll discuss the detailed consequences
of this later, but the basic idea is that it will cause the
Wumpus to either run away to an adjacent room, or to gobble
the player up:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">player</span><span class="p">.</span><span class="nf">encounter</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">player</span><span class="p">.</span><span class="nf">act</span><span class="p">(</span><span class="ss">:startle_wumpus</span><span class="p">,</span> <span class="n">player</span><span class="p">.</span><span class="nf">room</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>When bats are encountered, the narrator will inform us of
the event, then a random room will be selected to drop
the player off in. If any hazards are encountered
in that room, the effects will be applied immediately,
possibly leading to the player’s demise.</p>

<p>But assuming that the player managed to survive the flight, 
the bats will take up residence in the new location. This
can make navigation very complicated, because stumbling
back into that room will cause the player to be moved
to yet another random location:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">player</span><span class="p">.</span><span class="nf">encounter</span><span class="p">(</span><span class="ss">:bats</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">narrator</span><span class="p">.</span><span class="nf">say</span> <span class="s2">"Giant bats whisk you away to a new cavern!"</span>

  <span class="n">old_room</span> <span class="o">=</span> <span class="n">player</span><span class="p">.</span><span class="nf">room</span>
  <span class="n">new_room</span> <span class="o">=</span> <span class="n">cave</span><span class="p">.</span><span class="nf">random_room</span>

  <span class="n">player</span><span class="p">.</span><span class="nf">enter</span><span class="p">(</span><span class="n">new_room</span><span class="p">)</span>

  <span class="n">cave</span><span class="p">.</span><span class="nf">move</span><span class="p">(</span><span class="ss">:bats</span><span class="p">,</span> <span class="ss">from: </span><span class="n">old_room</span><span class="p">,</span> <span class="ss">to: </span><span class="n">new_room</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If the player happens to come across a bottomless pit, the
story ends immediately, even though the player’s journey
will probably go on forever:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">player</span><span class="p">.</span><span class="nf">encounter</span><span class="p">(</span><span class="ss">:pit</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">narrator</span><span class="p">.</span><span class="nf">finish_story</span><span class="p">(</span><span class="s2">"You fell into a bottomless pit. Enjoy the ride!"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The player’s actions are what ultimately ends up triggering game events. 
The movement action is straightforward: it simply updates the player’s
current location and then fires callbacks for any hazards encountered:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">player</span><span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="ss">:move</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">destination</span><span class="o">|</span>
  <span class="n">player</span><span class="p">.</span><span class="nf">enter</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Shooting is more complicated, although the way it is implemented here
is still a simplification of how the original game worked. In Gregory Yob’s
version, you had only five arrows, but they could travel a distance of up to
five rooms, even shooting around corners if you knew the right path. In my
version, arrows are unlimited but can only fire into neighboring rooms.</p>

<p>If the player shoots into the room that the Wumpus is hiding in, the beast 
is slayed and the story ends happily ever after. If instead the player shoots
into the wrong room, then no matter where the Wumpus is in the cave, it will 
be startled by the sound.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">player</span><span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="ss">:shoot</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">destination</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">destination</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span>
    <span class="n">narrator</span><span class="p">.</span><span class="nf">finish_story</span><span class="p">(</span><span class="s2">"YOU KILLED THE WUMPUS! GOOD JOB, BUDDY!!!"</span><span class="p">)</span> 
  <span class="k">else</span>
    <span class="n">narrator</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">"Your arrow missed!"</span><span class="p">)</span>

    <span class="n">player</span><span class="p">.</span><span class="nf">act</span><span class="p">(</span><span class="ss">:startle_wumpus</span><span class="p">,</span> <span class="n">cave</span><span class="p">.</span><span class="nf">room_with</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>When the Wumpus is startled, it will either stay where it is or move into
one of its neighboring rooms. The player will be able to hear the Wumpus
move anywhere in the cave, even if it is not in a nearby room.</p>

<p>If the Wumpus is in the same room as the player at the end of this process,
it will gobble the player up and the game will end in sadness and tears:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">player</span><span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="ss">:startle_wumpus</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">old_wumpus_room</span><span class="o">|</span>
  <span class="k">if</span> <span class="p">[</span><span class="ss">:move</span><span class="p">,</span> <span class="ss">:stay</span><span class="p">].</span><span class="nf">sample</span> <span class="o">==</span> <span class="ss">:move</span>
    <span class="n">new_wumpus_room</span> <span class="o">=</span> <span class="n">old_wumpus_room</span><span class="p">.</span><span class="nf">random_neighbor</span>
    <span class="n">cave</span><span class="p">.</span><span class="nf">move</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">,</span> <span class="ss">from: </span><span class="n">old_wumpus_room</span><span class="p">,</span> <span class="ss">to: </span><span class="n">new_wumpus_room</span><span class="p">)</span>

    <span class="n">narrator</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">"You heard a rumbling in a nearby cavern."</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="n">player</span><span class="p">.</span><span class="nf">room</span><span class="p">.</span><span class="nf">has?</span><span class="p">(</span><span class="ss">:wumpus</span><span class="p">)</span>
    <span class="n">narrator</span><span class="p">.</span><span class="nf">finish_story</span><span class="p">(</span><span class="s2">"You woke up the wumpus and he ate you!"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>And that pretty much sums it up. I omitted a few lines of boilerplate
code that fire up the main event loop, but this pretty much covers
all of the code that implements the actual game rules. It is designed
to be very hackable, so please do experiment with it however you’d like.</p>

<p>If you want to review the full game executable without the intermingled
commentary, please see <a href="https://github.com/elm-city-craftworks/wumpus/blob/reference_implementation/bin/wumpus">the bin/wumpus script</a>.</p>

<h2 id="additional-exercises">Additional Exercises</h2>

<p>Hopefully by working through this article you’ve seen for yourself why Hunt the
Wumpus is both fun to play and fun to implement. If you are looking for more
things to try, I’d suggest the following activities:</p>

<ul>
  <li>
    <p>Limit the number of arrows that the player can shoot, and end the game when
the player runs out of arrows.</p>
  </li>
  <li>
    <p>Try implementing the “crooked arrow” behavior of the original Wumpus game. To
do this allow the player to specify a path of up to five rooms. Whenever the
player guesses an incorrect path, have the arrow to bounce into a random room.
If the arrow ends up hitting the player because of this, they lose!</p>
  </li>
  <li>
    <p>Make it harder to guess the connections between rooms by randomizing
the room numbers for each new game while keeping the overall shape the same.</p>
  </li>
  <li>
    <p>Try out one of the alternative cave layouts described in Gregory Yob’s
followup publication about <a href="http://www.atariarchives.org/bcc2/showpage.php?page=244">Wumpus 2</a>.</p>
  </li>
  <li>
    <p>Add new hazards of your own, or other types of game objects that
are beneficial, or provide some more depth to the story.</p>
  </li>
  <li>
    <p>Implement a solver bot that plays the game automatically.</p>
  </li>
  <li>
    <p>Build a better user interface for the game, either improving the text-based
UI or attempting something using a GUI or web-based interface. You should
only need to edit the <code class="highlighter-rouge">Wumpus::Narrator</code> and <code class="highlighter-rouge">Wumpus::Console</code> objects
in order to replace the current interface.</p>
  </li>
  <li>
    <p>Keep the game behavior the same, but try out a different design than the one
I provided here and/or improve the test suite.</p>
  </li>
</ul>

<p>If you try out any of these extra credit exercises, please share your work. I’d
be very interested to see what you come up with. Until then, happy hacking!</p>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
