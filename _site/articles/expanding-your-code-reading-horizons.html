<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Expanding your code reading horizons</title>
  <meta name="description" content="An interesting thing about learning new programming languages is that it takesmuch less time to learn how to read programs than it does to write them. Whileb...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/expanding-your-code-reading-horizons">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Expanding your code reading horizons</h1>
    <p class="post-meta"><time datetime="2012-11-13T00:00:00-05:00" itemprop="datePublished">Nov 13, 2012</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>An interesting thing about learning new programming languages is that it takes
much less time to learn how to read programs than it does to write them. While
building non-trivial software in a language you are not familiar with can take weeks
or months of dedicated practice, the same software could be read and understood
in a fraction of that time.</p>

<p>Because programming languages are much more similar to the formal language of 
mathematics than they are to natural languages, people from diverse backgrounds 
can communicate complex ideas with a surprising lack of friction. Unfortunately,
we often forget this point because we are overwhelmed by the memories of how
hard it is to <em>write</em> elegant code in a new language. This tendency puts us at a
tremendous disadvantage, because it causes us to artifically limit our access to
valuable learning resources.</p>

<p>In this article, I will walk you through an example of how I was plagued by this
very fear, how I overcame it, and how that lead me to learn a lot 
about <a href="http://clojure.org/">Clojure</a> in a very short period of time. My hope is that by following 
in my footsteps, you’ll be able to learn the technique I used and possibly apply
it to your own studies.</p>

<h2 id="how-i-finally-learned-about-ant-colony-optimization">How I finally learned about Ant Colony Optimization</h2>

<p>For a few weeks before this article was published, I was busy
researching  <a href="http://en.wikipedia.org/wiki/Swarm_intelligence">swarm intelligence</a>. I have always been fascinated by 
how nature-inspired algorithms can be used to solve surprisingly complex 
computing problems, and I decided that I wanted to try implementing some 
of them myself. I started off by implementing the <a href="http://en.wikipedia.org/wiki/Boids">Boids algorithm</a>, 
and was surprised at how quickly I was able to get something vaguely 
resembling a flock of birds to appear on my screen. Motivated by that small
win, I decided to try my hand at simulating an <a href="http://en.wikipedia.org/wiki/Ant_colony_optimization">Ant Colony</a>.</p>

<p>On the surface, ant behavior is deceptively simple, even intuitive. At least,
that is what the description provided by Wikipedia would have you believe:</p>

<ol>
  <li>An ant (called “blitz”) runs more or less at random around the colony;</li>
  <li>If it discovers a food source, it returns more or less directly to the nest, leaving in its path a trail of pheromone;</li>
  <li>These pheromones are attractive; nearby ants will be inclined to follow, more or less directly, the track;</li>
  <li>Returning to the colony, these ants will strengthen the route;</li>
  <li>If there are two routes to reach the same food source then, in a given amount of time, the shorter one will be traveled by more ants than the long route;</li>
  <li>The short route will be increasingly enhanced, and therefore become more attractive;</li>
  <li>The long route will eventually disappear because pheromones are volatile;</li>
  <li>Eventually, all the ants have determined and therefore “chosen” the shortest route.</li>
</ol>

<p>Unfortunately, it is hard to find resources that precisely describe the rules
that govern each of these behaviors, and those that do exist are highly abstract
and mathematical. While I’m not one to shy away from theoretical papers, I
usually like to approach them once I understand a concept fairly well in
practice. For this particular problem, I was unable to find the materials 
that would get to that point, and it felt like I was hitting a brick wall.</p>

<p>Although I found tons of examples of applying a generalized form of ant colony 
optimization to the traveling salesman problem, I wanted to start with a more 
direct simulation of the natural behavior. After digging around for a bit, I
found <a href="https://gist.github.com/1093917">Rich Hickey’s ant simulator</a>, which is implemented 
in <a href="http://clojure.org/">Clojure</a>. Check out the video below to see what it looks like in action:</p>

<div align="center">
<iframe width="720" height="480" src="//www.youtube.com/embed/shm7QcJMvig?rel=0" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>I knew right away that this was exactly the kind of simulation I wanted to
build, but it honestly didn’t even cross my mind to attempt to read the Clojure
code and port it to Ruby. One quick glance at its <a href="https://gist.github.com/1093917">source code</a> reminded me
just how much I wanted to learn a Lisp dialect some day, but it definitely
wasn’t going to be today! I didn’t have time to go dust off the books on my
shelf that I never read, or to watch the <a href="http://blip.tv/clojure/clojure-concurrency-819147">2.5 hour long video</a> of the
talk that this code came from.</p>

<p>So instead of doing all that, I set off to build my own implementation from
scratch by cobbling together the bits of information I had collected
into something that sort of worked. Using the general description of ant
behavior as my guide, I left it up to my imagination to fill in the details, and
within an hour or so I had built something that had ants moving around the
screen. Unfortunately, my little family of ants seemed to have come from a
failed evolutionary branch, because they didn’t do what they were supposed to
do! They’d wander around randomly, get stuck, choose the wrong food sources, and
generally misbehave in all sorts of painful ways. Thinking that I needed a
break, I stepped away from the project for a day so that I could come back to it
with a fresh perspective.</p>

<p>The next day, I did end up getting something vaguely resembling an ant colony to
appear on my screen. The behavior was not perfect, but it illustrated the main 
idea of the algorithm:</p>

<div align="center">
<iframe width="720" height="480" src="//www.youtube.com/embed/p_XmuRHs57g?rel=0" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>It was fairly easy to get to this point, but then it became extremely hard to 
improve upon the simulator. Ant colony optimization has a lot of variables to it
(i.e. things like the size of the world, number of ants, number of food sources,
pheremone decay rate, amount of pheremone dropped per iteration, etc). Changing
any one of these things can influence the effectiveness of the others. When you
combine this variability with an implementation where the actual behaviors were 
half-baked and possibly buggy, you end up with a big mess that is hard to debug,
and even harder to understand. Knowing that my code was in really bad shape,
I was ready to give up.</p>

<p>Although it took a lot of rumination to get me there, the lightbulb eventually
turned on: maybe reading the Clojure implementation wasn’t such a bad idea after
all! I had initially thought that learning the algorithm would be much easier
than learning the semantics and syntax of a new language, but two days of hard
work and mediocre results lead me to re-evaluate that assumption. At the very
least, I could spend an afternoon with the Clojure code. Even if the ants still frightened
and confused me in the end, I’d at least learn how to read some code from a language 
that I had always wanted to study anyway.</p>

<p>I think you can guess what happened next: within a couple of hours, I not only
fully understood Rich Hickey’s implementation, but I had also learned dozens
upon dozens of Clojure features, including a few that have no direct analogue in
Ruby. While it may have been a result of frustration 
driven development, I was genuinely surprised at what a great way this was to
learn a new language while also studying a programming problem that I was
interested in.</p>

<p>Throughout the rest of this article, I will attempt to demonstrate that given
the right example, even a few dozen lines of code can teach you a tremendous
amount of useful things about a language that you’ve never worked with before.
If you are new to Clojure programming, you’ll be able to follow along
and experience the same benefits that I did; if you already know the
language, you can use this as an exercise in developing a beginner’s mindset. In
either case, I think you’ll be surprised at how much we can extract
from such a small chunk of code.</p>

<p>To keep things simple, we won’t bother to read the complex bits of code that 
implements ant behavior. Instead, we’ll start from the bottom up and
take a look at how this simulation models its world and the ants within it.
Although this won’t help us understand how things get set into action, it will
give us plenty of opportunities to learn some interesting Clojure
features.</p>

<h2 id="modeling-the-world">Modeling the world</h2>

<p>The following code is responsible for creating a blank slate world with 80x80
dimensions:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defstruct</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="no">:food</span><span class="w"> </span><span class="no">:pher</span><span class="p">)</span><span class="w"> </span><span class="c1">;may also have :ant and :home
</span><span class="w">
</span><span class="c1">;dimensions of square world
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span><span class="w">

</span><span class="c1">;world is a 2d vector of refs to cells
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">world</span><span class="w"> 
   </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nb">vector</span><span class="w"> 
     </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="w"> 
            </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nb">vector</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">ref</span><span class="w"> </span><span class="p">(</span><span class="nb">struct</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> 
                               </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="n">dim</span><span class="p">))))</span><span class="w"> 
          </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="n">dim</span><span class="p">))))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="p">[[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]]</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<p>Even if this is the first time you’ve ever seen a Clojure program, you could take an
educated guess at what is going on in at least a few of these lines of code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defstruct</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="no">:food</span><span class="w"> </span><span class="no">:pher</span><span class="p">)</span><span class="w">      </span><span class="c1">; this defines a Struct-like thing
</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span><span class="w">                      </span><span class="c1">; this defines a named value, setting dim=80
</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="p">[[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]]</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w">     </span><span class="c1">; this looks like an accessor into a
</span><span class="w">                                  </span><span class="c1">; two-dimensional grid
</span></code></pre>
</div>

<p>The code in the <code class="highlighter-rouge">world</code> definition is much more complicated, but it 
has a helpful comment that describes what it is: a 2D vector of 
refs to cells. This hint gives us some useful keywords to search for 
in <a href="http://clojure.org/documentation">Clojure’s API docs</a>. With a bit of effort, it is possible
to use this code sample and Clojure’s documentation to learn all the 
following things about the language:</p>

<ol>
  <li>The <a href="http://clojure.org/data_structures#Data%20Structures-Maps%20%28IPersistentMap%29">Map</a> collection is Clojure’s equivalent to Ruby’s <code class="highlighter-rouge">Hash</code> object.</li>
  <li>The <a href="http://clojure.org/data_structures#Data%20Structures-StructMaps">StructMap</a> collection is a <code class="highlighter-rouge">Map</code> with some predefined keys
that cannot be removed. They can be defined using <code class="highlighter-rouge">defstruct</code>, and are instantiated
via <code class="highlighter-rouge">struct</code>.</li>
  <li>The <code class="highlighter-rouge">(def ...)</code> construct is a <a href="http://clojure.org/special_forms#Special%20Forms--%28def%20symbol%20init?%29">special form</a> that defines global variables 
within a namespace, but it is considered bad style to treat these variables as
if they were mutable.</li>
  <li>The <code class="highlighter-rouge">(defn ...)</code> construct is a macro which among other things provides
syntactic sugar for defining functions with named parameters.</li>
  <li>The <a href="http://clojure.org/data_structures#Data%20Structures-Vectors%20%28IPersistentVector%29">Vector</a> collection has core functionality which is similar to
Ruby’s <code class="highlighter-rouge">Array</code> object. Vectors can be instantiated using the <code class="highlighter-rouge">vector</code> function or
via the <code class="highlighter-rouge">[]</code> literal syntax,  and their elements are accessed using 
the <code class="highlighter-rouge">nth</code> function.</li>
  <li>All collections in Clojure implement a <a href="http://clojure.org/sequences">Sequence</a>
interface that is similar to Ruby’s <code class="highlighter-rouge">Enumerable</code> module. It provides various
functions that Ruby programmers are already familiar with, such as <code class="highlighter-rouge">map</code>, <code class="highlighter-rouge">reduce</code>, 
<code class="highlighter-rouge">sort</code> But because most of these functions return lazy sequences, they
behave slightly differently than their Ruby counterparts.</li>
  <li>The <a href="http://clojure.org/refs">Ref</a> construct is a transactional reference, which is one of
Clojure’s concurrency primitives. In a nutshell, wrapping state in a <code class="highlighter-rouge">Ref</code>
makes it so that state can only be modified from within a transaction, ensuring
thread safety.</li>
  <li>Among other things, the <code class="highlighter-rouge">range</code> function provides behavior similar to the enumerator 
form of Ruby’s <code class="highlighter-rouge">Integer#times</code> method.</li>
  <li>The <code class="highlighter-rouge">apply</code> function provides functionality similar to Ruby’s splat operator
(<code class="highlighter-rouge">*</code>), passing the elements of a sequence as arguments to a function.</li>
  <li>The <a href="http://blog.fogus.me/2009/09/04/understanding-the-clojure-macro/">-&gt; macro</a> provides syntactic sugar for function composition, which
can make chaining function calls easier.</li>
</ol>

<p>Based on this laundry list of concepts to learn, it is easy to see from this
example alone that much like Ruby, Clojure is a very rich language that is
capable of concisely expressing very complex ideas. With that in mind, it is
helpful to use Clojure’s REPL to experiment while learning, much as we’d do
with <code class="highlighter-rouge">irb</code> in Ruby. Once again using the code sample as a guide, an 
exploration such as the one that follows can go a long way towards 
verifying our understanding of what we learned from the documentation:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">defstruct</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="no">:food</span><span class="w"> </span><span class="no">:pher</span><span class="p">)</span><span class="w">
</span><span class="c1">; #'user/cell
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">struct</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w">
</span><span class="c1">; {:food 1, :pher 4}
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="no">:c</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="no">:d</span><span class="w"> </span><span class="no">:e</span><span class="w"> </span><span class="no">:f</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="c1">; [[:a :b :c] [:d :e :f]]
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">[[</span><span class="no">:a</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="no">:c</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="no">:d</span><span class="w"> </span><span class="no">:e</span><span class="w"> </span><span class="no">:f</span><span class="p">]])</span><span class="w">
</span><span class="c1">; #'user/data
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span><span class="c1">; :f
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span><span class="c1">; IndexOutOfBoundsException   clojure.lang.PersistentVector.arrayFor 
; (PersistentVector.java:106)
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span><span class="c1">; :b
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w">
</span><span class="c1">; :f
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">
</span><span class="c1">; (2 4 6)
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">vector</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]))</span><span class="w">
</span><span class="c1">; [(2 4 6)]
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nb">vector</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]))</span><span class="w">
</span><span class="c1">; [2 4 6]
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w">
</span><span class="c1">; (0 1 2 3 4)
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nb">vector</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">struct</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)))</span><span class="w">
</span><span class="c1">; [{:food 0, :pher 0} {:food 0, :pher 0} {:food 0, :pher 0} 
; {:food 0, :pher 0} {:food 0, :pher 0}]
</span></code></pre>
</div>

<p>Knowing what we now know, it is possible to imagine a loose translation of the
original Clojure code sample into Ruby, if we account for a few cavaets:</p>

<ol>
  <li>
    <p>Most <code class="highlighter-rouge">Enumerable</code> methods return <code class="highlighter-rouge">Array</code> objects, which are not lazily
evaluated. Some support for lazy sequences exist in Ruby 2.0, but we’ll
not bother with that in our translation because it’d only create more
work for us.</p>
  </li>
  <li>
    <p>We don’t have a direct analogy to Clojure’s <code class="highlighter-rouge">Ref</code> construct, but we can
pretend that we do for the purposes of this example.</p>
  </li>
  <li>
    <p>We don’t have anything baked into the language which implements a <code class="highlighter-rouge">Hash</code> with
some required keys and some optional ones. But such behavior could be
emulated by building a custom <code class="highlighter-rouge">Cell</code> object.</p>
  </li>
  <li>
    <p>We don’t have destructuring in the parameter lists for our
functions, so we need to handle destructuring manually within the bodies
of our methods rather than their signatures.</p>
  </li>
</ol>

<p>Keeping these points in mind, here’s a semi-literal translation of Clojure code
to Ruby:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">DIM</span>    <span class="o">=</span> <span class="mi">80</span>                                          
<span class="no">WORLD</span>  <span class="o">=</span> <span class="no">DIM</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span>                                 <span class="c1"># 1</span>
           <span class="no">DIM</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="no">Ref</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Cell</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">}</span>      <span class="c1"># 2,3</span>
         <span class="k">end</span>

<span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>       
  <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pos</span>                                              <span class="c1"># 4</span>
  <span class="no">WORLD</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>While the two languages cannot be categorically compared by such a coarse
exercise in syntactic gymnastics, it does help the similarities and 
differences between the languages stand out a bit more. This allows us to reuse
the knowledge we already have, and also exposes the gaps in our 
understanding that need to be filled in.</p>

<blockquote>
  <p><strong>SIDE QUEST:</strong> The remaining two sections in this article will repeat this
same basic process on two more small chunks of code from the ant simulator. If you have some
free time and an interest in learning Clojure, you may want to start
with the initial code samples in each section and try to figure them out on
your own, and <em>then</em> come back to read my notes. If you decide to
try this out, please share a comment with what you’ve learned.</p>
</blockquote>

<p>Now that we’ve tackled one concrete feature from this program, it will be much
easier to understand the rest. There’s a lot left to learn, so let’s keep
moving!</p>

<h2 id="modeling-an-ant">Modeling an ant</h2>

<p>The following code is responsible for initializing an ant at a 
given location within the world:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defstruct</span><span class="w"> </span><span class="n">ant</span><span class="w"> </span><span class="no">:dir</span><span class="p">)</span><span class="w"> </span><span class="c1">;may also have :food
</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">create-ant</span><span class="w"> 
  </span><span class="s">"create an ant at the location, returning an ant agent on the location"</span><span class="w">
  </span><span class="p">[</span><span class="n">loc</span><span class="w"> </span><span class="n">dir</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">dosync</span><span class="w">
      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="nf">place</span><span class="w"> </span><span class="n">loc</span><span class="p">)</span><span class="w">
            </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nb">struct</span><span class="w"> </span><span class="n">ant</span><span class="w"> </span><span class="n">dir</span><span class="p">)]</span><span class="w">
        </span><span class="p">(</span><span class="nb">alter</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="nb">assoc</span><span class="w"> </span><span class="no">:ant</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">agent</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre>
</div>

<p>Because we already have a rudimentary understanding of how <code class="highlighter-rouge">StructMap</code> works,
and how to define functions, we can skip over some of the boilerplate
and get right to the good stuff:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nb">dosync</span><span class="w">                               </span><span class="c1">; 1
</span><span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="nf">place</span><span class="w"> </span><span class="n">loc</span><span class="p">)</span><span class="w">                 </span><span class="c1">; 2
</span><span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nb">struct</span><span class="w"> </span><span class="n">ant</span><span class="w"> </span><span class="n">dir</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">alter</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="nb">assoc</span><span class="w"> </span><span class="no">:ant</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w">            </span><span class="c1">; 3
</span><span class="w">    </span><span class="p">(</span><span class="nb">agent</span><span class="w"> </span><span class="n">loc</span><span class="p">)))</span><span class="w">                     </span><span class="c1">; 4
</span></code></pre>
</div>

<p>Digging back into Clojure’s API docs, we can learn four new things 
from this code sample:</p>

<ol>
  <li>
    <p>The <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/dosync">dosync</a> macro starts a transaction,
which among other things, makes it possible to modify <code class="highlighter-rouge">Ref</code>
structures in a thread-safe way.</p>
  </li>
  <li>
    <p>The <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/let">let</a> macro allows you to make use of named values within
a lexical scope. This construct appears to be roughly similar to the 
concept of block-local variables in Ruby.</p>
  </li>
  <li>
    <p>The <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/alter">alter</a> function is used for modifying the contents of a <code class="highlighter-rouge">Ref</code>
structure, and can only be called within a transaction.</p>
  </li>
  <li>
    <p>The <a href="http://clojure.org/agents">Agent</a> construct is another one of Clojure’s concurrency
primitives. This structure provides an interesting state-centric alternative
to the actor model of concurrency: rather than encapsulating behavior that acts
upon external state, agents encapsulate state which is <em>acted upon</em> by external
behaviors.</p>
  </li>
</ol>

<p>Of course, in order to verify that we understand what the documentation is
telling us, nothing beats a bit of casual experimentation in the REPL:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="mi">20</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w">
</span><span class="c1">; 30
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="mi">20</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w">
</span><span class="c1">; 30
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">y</span><span class="w"> </span><span class="mi">20</span><span class="p">])</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w">
</span><span class="c1">; CompilerException java.lang.RuntimeException: Unable to resolve 
; symbol: y in this context, compiling:(NO_SOURCE_PATH:3) 
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">(</span><span class="nb">ref</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="no">:x</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:y</span><span class="w"> </span><span class="mi">1</span><span class="p">})</span><span class="w"> </span><span class="p">)</span><span class="w">
</span><span class="c1">; #'user/foo
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="n">foo</span><span class="w">
</span><span class="c1">; #&lt;Ref@6762ba99: {:y 1, :x 1}&gt;
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="no">:z</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span><span class="c1">; ClassCastException clojure.lang.Ref cannot be cast to clojure.lang.Associative  
; clojure.lang.RT.assoc (RT.java:691)
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="err">@</span><span class="n">foo</span><span class="w"> </span><span class="no">:z</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span><span class="c1">; {:z 2, :y 1, :x 1}
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="err">@</span><span class="n">foo</span><span class="w">
</span><span class="c1">; {:y 1, :x 1}
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">alter</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="nb">assoc</span><span class="w"> </span><span class="no">:z</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span><span class="c1">; IllegalStateException No transaction running  
; clojure.lang.LockingTransaction.getEx (LockingTransaction.java:208)
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">dosync</span><span class="w"> </span><span class="p">(</span><span class="nb">alter</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="nb">assoc</span><span class="w"> </span><span class="no">:z</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w">
</span><span class="c1">; {:z 2, :y 1, :x 1}
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="p">(</span><span class="nb">agent</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]))</span><span class="w">
</span><span class="c1">; #'user/bar
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="n">bar</span><span class="w">
</span><span class="c1">; #&lt;Agent@3445378f: [1 2 3]&gt;
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="err">@</span><span class="n">bar</span><span class="w">
</span><span class="c1">; [1 2 3]
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">send</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="nb">reverse</span><span class="p">)</span><span class="w">
</span><span class="c1">; #&lt;Agent@3445378f: [1 2 3]&gt;
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="n">bar</span><span class="w">
</span><span class="c1">; #&lt;Agent@3445378f: (3 2 1)&gt;
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="err">@</span><span class="n">bar</span><span class="w">
</span><span class="c1">; (3 2 1)
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">reverse</span><span class="w"> </span><span class="err">@</span><span class="n">bar</span><span class="p">)</span><span class="w">
</span><span class="c1">; (1 2 3)
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="err">@</span><span class="n">bar</span><span class="w">
</span><span class="c1">; (3 2 1)
</span></code></pre>
</div>

<p>The ant creation code sample consists mostly of features that don’t exist in
Ruby, so a direct translation isn’t possible. However, it doesn’t hurt to
imagine what the syntax for these features might look like in Ruby if we did
have Clojure’s concurrency primitives:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">create_ant</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">dir</span><span class="p">)</span>
    <span class="no">Ref</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span> 
      <span class="nb">p</span> <span class="o">=</span> <span class="n">place</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
      <span class="n">a</span> <span class="o">=</span> <span class="no">Ant</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
    
      <span class="nb">p</span><span class="p">.</span><span class="nf">ant</span> <span class="o">=</span> <span class="n">a</span>

      <span class="no">Agent</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>
</div>

<p>Assuming that Clojure’s semantics were maintained, either all mutations that
happen within the <code class="highlighter-rouge">Ref.transaction</code> block would be applied, or none of them
would be. Furthermore, thread-safety would be handled for us ensuring state
consistency for the duration of the block. Language-level transactions seem like
seriously powerful stuff, and it will be interesting to see if Ruby ends up
adopting them in the future.</p>

<h2 id="populating-the-world">Populating the world</h2>

<p>The following code populates the initial state of the world with ants and food:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">;number of ants = nants-sqrt^2
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">nants-sqrt</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w">
</span><span class="c1">;number of places with food
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">food-places</span><span class="w"> </span><span class="mi">35</span><span class="p">)</span><span class="w">
</span><span class="c1">;range of amount of food at a place
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">food-range</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">home-off</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">dim</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">home-range</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="n">home-off</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">nants-sqrt</span><span class="w"> </span><span class="n">home-off</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">setup</span><span class="w"> 
  </span><span class="s">"places initial food and ants, returns seq of ant agents"</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nb">dosync</span><span class="w">
    </span><span class="p">(</span><span class="nb">dotimes</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">food-places</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="nf">place</span><span class="w"> </span><span class="p">[(</span><span class="nb">rand-int</span><span class="w"> </span><span class="n">dim</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="n">dim</span><span class="p">)])]</span><span class="w">
        </span><span class="p">(</span><span class="nb">alter</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="nb">assoc</span><span class="w"> </span><span class="no">:food</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="n">food-range</span><span class="p">))))</span><span class="w">
    </span><span class="p">(</span><span class="nb">doall</span><span class="w">
     </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">home-range</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">home-range</span><span class="p">]</span><span class="w">
       </span><span class="p">(</span><span class="nf">do</span><span class="w">
         </span><span class="p">(</span><span class="nb">alter</span><span class="w"> </span><span class="p">(</span><span class="nf">place</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">])</span><span class="w"> 
                </span><span class="nb">assoc</span><span class="w"> </span><span class="no">:home</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nf">create-ant</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">8</span><span class="p">)))))))</span><span class="w">
</span></code></pre>
</div>

<p>As in the ant initialization code, this snippet includes a mixture of new
concepts and old ones. If we focus on the body of the <code class="highlighter-rouge">setup</code> definition, there
are five new things for us to learn:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nb">dosync</span><span class="w">
    </span><span class="p">(</span><span class="nb">dotimes</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">food-places</span><span class="p">]</span><span class="w">                             </span><span class="c1">;1
</span><span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="nf">place</span><span class="w"> </span><span class="p">[(</span><span class="nb">rand-int</span><span class="w"> </span><span class="n">dim</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="n">dim</span><span class="p">)])]</span><span class="w">   </span><span class="c1">;2
</span><span class="w">        </span><span class="p">(</span><span class="nb">alter</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="nb">assoc</span><span class="w"> </span><span class="no">:food</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="n">food-range</span><span class="p">))))</span><span class="w">
    </span><span class="p">(</span><span class="nb">doall</span><span class="w">                                               </span><span class="c1">;3
</span><span class="w">     </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">home-range</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">home-range</span><span class="p">]</span><span class="w">                    </span><span class="c1">;4
</span><span class="w">       </span><span class="p">(</span><span class="nf">do</span><span class="w">                                               </span><span class="c1">;5
</span><span class="w">         </span><span class="p">(</span><span class="nb">alter</span><span class="w"> </span><span class="p">(</span><span class="nf">place</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">])</span><span class="w"> 
                </span><span class="nb">assoc</span><span class="w"> </span><span class="no">:home</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nf">create-ant</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">8</span><span class="p">))))))</span><span class="w">
</span></code></pre>
</div>

<ol>
  <li>
    <p>The <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/dotimes">dotimes</a> macro is a simple iterator that is comparable to the
block form of <code class="highlighter-rouge">Integer#times</code> in Ruby.</p>
  </li>
  <li>
    <p>The <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/rand-int">rand-int</a> function returns a random integer between 0 and
a given number, which is similar to calling Ruby’s <code class="highlighter-rouge">Kernel#rand</code> with an 
integer argument.</p>
  </li>
  <li>
    <p>The <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/doall">doall</a> macro is used to force a lazy sequence to be fully
evaluated.</p>
  </li>
  <li>
    <p>The <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/for">for</a> macro implements list comprehensions, which are a very
powerful form of iterator that does not have a direct analogue in Ruby.</p>
  </li>
  <li>
    <p>The <a href="http://clojure.org/special_forms#Special%20Forms--%28do%20exprs*%29">do</a> special form executes a series of expressions in sequence and
returns the result of the last expression. This is roughly equivalent to Ruby’s
<code class="highlighter-rouge">do...end</code> block syntax.</p>
  </li>
</ol>

<p>One last trip back to the REPL is needed to confirm that once again, the
documentation is not lying, and we have not misunderstood its explanations:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">dotimes</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w">
</span><span class="c1">; 0
; 1
; 2
; 3
; 4
; nil
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w">
</span><span class="c1">; 3
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w">
</span><span class="c1">; 6
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w">
</span><span class="c1">; 6
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">rand-int</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w">
</span><span class="c1">; 2
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">])</span><span class="w">
</span><span class="c1">; ([0 0] [0 1] [0 2] [0 3] [0 4] [1 0] [1 1] [1 2] [1 3] [1 4] 
; [2 0] [2 1] [2 2] [2 3] [2 4] [3 0] [3 1] [3 2] [3 3] [3 4] 
; [4 0] [4 1] [4 2] [4 3] [4 4])
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w">
</span><span class="c1">; (0 1 2 3 4 1 2 3 4 5 2 3 4 5 6 3 4 5 6 7 4 5 6 7 8)
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">do</span><span class="w"> </span><span class="p">(</span><span class="nb">print</span><span class="w"> </span><span class="s">"hello world\n"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w">
</span><span class="c1">; hello world
; 2
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">realized?</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]))</span><span class="w"> 
</span><span class="c1">; false
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">realized?</span><span class="w"> </span><span class="p">(</span><span class="nb">doall</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">5</span><span class="p">)]</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">])))</span><span class="w">
</span><span class="c1">; true
</span></code></pre>
</div>

<p>Because many of the Clojure features used for populating the simulation’s 
world either already exist in Ruby or are irrelevant due to implementation
differences, this code sample translates fairly well. Apart from the fact
that the <code class="highlighter-rouge">Ref</code> construct in this example is imaginary, the only 
noticeable thing that is lost in translation is the conciseness
of Clojure’s list comprehensions. But in this particular use case,
<code class="highlighter-rouge">Array#product</code> gets us part of the way there:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">NANTS_SQRT</span>  <span class="o">=</span> <span class="mi">7</span>
<span class="no">FOOD_PLACES</span> <span class="o">=</span> <span class="mi">35</span>
<span class="no">FOOD_RANGE</span>  <span class="o">=</span> <span class="mi">100</span>

<span class="no">HOME_OFF</span>   <span class="o">=</span> <span class="no">DIM</span> <span class="o">/</span> <span class="mi">4</span>
<span class="no">HOME_RANGE</span> <span class="o">=</span> <span class="p">(</span><span class="no">HOME_OFF</span><span class="p">.</span><span class="nf">.</span><span class="no">NANTS_SQRT</span> <span class="o">+</span> <span class="no">HOME_OFF</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setup</span>
  <span class="no">Ref</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
    <span class="no">FOOD_PLACES</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
      <span class="nb">p</span>      <span class="o">=</span> <span class="n">place</span><span class="p">([</span><span class="nb">rand</span><span class="p">(</span><span class="no">DIM</span><span class="p">),</span> <span class="nb">rand</span><span class="p">(</span><span class="no">DIM</span><span class="p">])</span>
      <span class="nb">p</span><span class="p">.</span><span class="nf">food</span> <span class="o">=</span> <span class="nb">rand</span><span class="p">(</span><span class="no">FOOD_RANGE</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="no">HOME_RANGE</span><span class="p">.</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">product</span><span class="p">(</span><span class="no">HOME_RANGE</span><span class="p">.</span><span class="nf">to_a</span><span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">|</span>
      <span class="n">place</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]).</span><span class="nf">home</span> <span class="o">=</span> <span class="kp">true</span>
    
      <span class="n">create_ant</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>At this point, you should now completely understand the structure of the initial
state of the world in <a href="https://gist.github.com/1093917">Rich Hickey’s ant simulator</a>, and if you’re new to
Clojure, you probably know a lot more about the language than you did when you
started reading. If you have enjoyed the journey so far, definitely consider
reading the entire program; this article only covers tip of the iceberg!</p>

<h2 id="reflections">Reflections</h2>

<p><a href="http://xkcd.com">XKCD</a> sums up how I feel about this exercise much better than I could on my own:</p>

<p><a href="http://xkcd.com/297/"><img src="http://imgs.xkcd.com/comics/lisp_cycles.png" alt="" /></a></p>

<p>That said, I’m sure that more than a few people would be happy to tell you that 
many of the pragmatic compromises that Clojure has made are blasphemic in some
way. Truth be told, I don’t know nearly enough about functional languages to
weigh in on any of those claims.</p>

<p>The real takeaway for me was that by stepping outside of my comfort zone for
even a few hours, I was able to look back at Ruby with a fresh perspective. I
was also able to gain an understanding of a programming problem that I couldn’t
find a good Ruby example for. Both of these things were a huge win for me. I
hope that you will find a way to try this exercise out on one of your own 
problems, and I look forward to hearing what you think of it.</p>

<p>Learning to read code in a language you are not familiar with takes practice,
but it is easier than it seems. If you step outside the
bubble from time to time, only good things will come of it.</p>

<blockquote>
  <p><strong>NOTE</strong>: You may want to try out <a href="http://www.4clojure.com">4Clojure</a> if you want to hone
your Clojure skills at a more gradual pace than what we attempted in this
article. It’s a quiz site similar to <a href="http://rubykoans.com">RubyKoans</a>.</p>
</blockquote>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
