<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Building a better Turing tarpit</title>
  <meta name="description" content="In Issue 3.3, I presented a proof-of-concept Ruby implementation of the Brainfuck programming language and challenged Practicing Ruby readers to improve upon...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/spiral-staircase-of-refactoring">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Building a better Turing tarpit</h1>
    <p class="post-meta"><time datetime="2012-01-25T00:00:00-05:00" itemprop="datePublished">Jan 25, 2012</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>In <a href="http://practicingruby.com/articles/shared/bwgflabwncjv">Issue 3.3</a>, I presented a proof-of-concept Ruby implementation of the <a href="http://en.wikipedia.org/wiki/Brainfuck">Brainfuck programming language</a> and challenged Practicing Ruby readers to improve upon it. After receiving several patches that helped move things along, I sat down once again to clean up the code even further. What I came to realize as I worked on my revisions is that the refactoring process is very similar to climbing a spiral staircase. Each structural change to the code simultaneously left the project back where it started along one vector while moving it forward along another.</p>

<p>Because we often look at the merits of a given refactoring technique within the context of a single transition from worse code to better code, it’s easy to mistakenly assume that the refactoring process is much more linear than it actually is. In this article, I’ve tried to capture a much wider angle view of how refactoring really works in the wild. The end result is a story which I hope will spark some good discussions about how we can improve our code quality over time.</p>

<h3 id="prologue-everything-has-to-start-somewhere">Prologue. Everything has to start somewhere</h3>

<p>I decided to name my interpreter <a href="http://en.wikipedia.org/wiki/Turing_tarpit">Turing Tarpit</a>, because that term is perfectly apt for describing languages like Brainfuck. In a nutshell, the term refers to any language which is infinitely flexible, yet nearly impossible to use for anything practical. It turns out that building this sort of mind trap for programmers is quite easy to do.</p>

<p>My first iteration was easy enough to build, and consisted of three objects: a <code class="highlighter-rouge">Tape</code>, an <code class="highlighter-rouge">Interpreter</code>, and a <code class="highlighter-rouge">Scanner</code>. The rough breakdown of responsibilities was something like this:</p>

<ul>
  <li>
    <p>The <a href="https://github.com/elm-city-craftworks/turing_tarpit/blob/starting_point/lib/turing_tarpit.rb#L103-149">Tape object</a> implemented something similar to the storage mechanism in a <a href="http://en.wikipedia.org/wiki/Turing_machine#Informal_description">Turing machine</a>. It provided mechanisms for accessing and modifying numeric values in cells, as well as a way to increment and decrement the pointer that determined which cell to operate on.</p>
  </li>
  <li>
    <p>The <a href="https://github.com/elm-city-craftworks/turing_tarpit/blob/starting_point/lib/turing_tarpit.rb#L7-34">Interpreter object</a> served as a mapping between Brainfuck’s symbolic operators and the operations provided by the <code class="highlighter-rouge">Tape</code> object. It also implemented the I/O functionality required by Brainfuck.</p>
  </li>
  <li>
    <p>The <a href="https://github.com/elm-city-craftworks/turing_tarpit/blob/starting_point/lib/turing_tarpit.rb#L36-69">Scanner object</a> was responsible for taking a Brainfuck source file as input and transforming it into a stream of operations that could be handled by the <code class="highlighter-rouge">Interpreter</code> object. For the most part this simply meant reading the source file one character at a time, but this object also needed to account for Brainfuck’s forward and backward jump operations.</p>
  </li>
</ul>

<p>While my initial implementation was reasonably clean for a proof-of-concept, it definitely had room for improvement. I decided to ask for feedback early in the hopes that folks would find and fix the things I knew were problematic while simultaneously checking my blindspots for issues that I hadn’t noticed myself.</p>

<h3 id="act-i-getting-a-fresh-perspective-on-the-problem">Act I. Getting a fresh perspective on the problem</h3>

<p>Some of the issues brought up by contributors were fairly obvious housekeeping chores, but nonetheless made the project nicer to work with:</p>

<ul>
  <li>
    <p>Steve Klabnik <a href="https://github.com/elm-city-craftworks/turing_tarpit/pull/3">requested a way to run the whole test suite at once</a> instead of file by file. He had provided a patch with a Rakefile, but since the project didn’t have any immediate need for other rake tasks, we ended up deciding that a simple <em>test/suite.rb</em> file would be sufficient. Notes were added to the README on how to run the tests.</p>
  </li>
  <li>
    <p>Renato Riccieri <a href="https://github.com/elm-city-craftworks/turing_tarpit/pull/6">broke the classes out into individual files</a>. The original implementation had everything in <em>lib/turing_tarpit.rb</em>, simply for convenience reasons while spiking. Breaking the classes into individual files brought the project more in line with <a href="http://chneukirchen.github.com/rps/">standard Ruby packaging conventions</a>.</p>
  </li>
  <li>
    <p>Benoit Daloze <a href="https://github.com/elm-city-craftworks/turing_tarpit/pull/2">refactored some ugly output code</a> to use <code class="highlighter-rouge">putc(char)</code> instead of <code class="highlighter-rouge">print("" &lt;&lt; char)</code>. Since the latter was obviously a hack due to my lack of awareness of the <code class="highlighter-rouge">putc</code> method, this was a welcome contribution.</p>
  </li>
</ul>

<p>After this initial round of cleanup, we ended up thinking through a pair of more substantial problems: the inconsitent use of private accessors, and a proposed refactoring to break up the <code class="highlighter-rouge">Scanner</code> object into two separate objects, a <code class="highlighter-rouge">Tokenizer</code> and a <code class="highlighter-rouge">Scanner</code>.</p>

<p><strong>The story behind my recent private accessor experiments</strong></p>

<p>Ryan LeCompte was the one to bring up <a href="https://github.com/elm-city-craftworks/turing_tarpit/issues/1">the question about private accessors</a>, and was curious about why I had used them in some places but referenced instance variables directly in others. The main reason for this was simply that the use of private accessors is a new experiment for me, and so in my haste of getting a first version out the door, I remembered to use them in some places but not in others.</p>

<p>This project in particular posed certain challenges for using private accessors conveniently. A specific example of where I ran into some weird edge cases can easily be seen in the <code class="highlighter-rouge">Tape</code> object:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">TuringTarpit</span>
  <span class="k">class</span> <span class="nc">Tape</span>
    <span class="k">def</span> <span class="nf">initialize</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">pointer_position</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="c1"># ...</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">increment_pointer</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">pointer_position</span> <span class="o">=</span> <span class="n">pointer_position</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>

    <span class="c1"># ...</span>

    <span class="kp">private</span>

    <span class="kp">attr_writer</span> <span class="ss">:pointer_position</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If you just glance quickly at this class definition, it is very tempting to try to refactor <code class="highlighter-rouge">increment_pointer</code> so that it uses convenient <code class="highlighter-rouge">+=</code> syntax, resulting in something like the code below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">increment_pointer</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">pointer_position</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In most cases, this refactoring would be a good one because it makes the code slightly less verbose without sacrificing readability. However, it turns out that Ruby does not extend the same private method special casing to <code class="highlighter-rouge">self.foo += something</code> as it does to <code class="highlighter-rouge">self.foo = something</code>. This means that if you attempt to refactor this code to use <code class="highlighter-rouge">+=</code> it ends up raising a <code class="highlighter-rouge">NoMethodError</code>. Because this is definitely a downside of using private accessors, it’s reasonable to ask why you’d bother to use them in the first place rather than using public accessors or simply referring to instance variables directly.</p>

<p>The best reason I can find for making use of accessors in general vs. instance variables is simply that the former are much more flexible. New behavior such as validations or transformations can be added later by changing what used to be vanilla accessors into ordinary method definitions. Additionally, if you accidentally introduce a typo into your code, you will get a <code class="highlighter-rouge">NoMethodError</code> right away rather than having to track down why your attribute is <code class="highlighter-rouge">nil</code> when you didn’t expect it to be in some completely different place in your code.</p>

<p>The problem with making accessors public is that it hints to the consumer that it is meant to be touched and used, which is often not the case at all, especially for writers. While Ruby makes it trivial to circumvent privacy protections, a private method communicates to the user that it is meant to be treated as an implementation detail and should not be depended on. So the reason for using a private accessor is the same as the reason for using a private method: to mark the accessor as part of the internals of the object.</p>

<p>The interesting thing I stumbled across in this particular project is that if you take this technique to the extreme, it is possible to build entire applications without ever explicitly referencing an instance variable. It comes at the cost of the occasional weird edge case when calling private methods internally, but makes it possible to treat instance variables as a whole as a <em>language implementation detail</em>, rather than an <em>application implementation detail</em>. Faced with the opportunity to at least experiment with that idea, I decided to make the entire Turing Tarpit codebase completely free of instance variables, which ended up taking very little effort.</p>

<p>The jury is still out on whether or not this is a good idea, but I plan to keep trying the idea out in my projects and see whether I run into any more issues. If I don’t experience problems, I’d say this technique is well worth it because it emphasizes message-passing rather than state manipulation in our objects.</p>

<p><strong>Splitting up the Scanner object</strong></p>

<p>After helping out with a few of the general housekeeping chores, Steve Klabnik then turned his attention to one of the weakest spots in the code, the <code class="highlighter-rouge">Scanner</code> object. He pointed out that having an object with dependencies on a whole lot of private methods is a bit of a code smell, and focused specifically on the <code class="highlighter-rouge">Scanner#next</code> method. The original implementation looked like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">TuringTarpit</span>
  <span class="k">class</span> <span class="nc">Scanner</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="n">cell_value</span><span class="p">)</span>
      <span class="n">validate_index</span>

      <span class="n">element</span> <span class="o">=</span> <span class="vi">@chars</span><span class="p">[</span><span class="vi">@index</span><span class="p">]</span>
      
      <span class="k">case</span> <span class="n">element</span>
      <span class="k">when</span> <span class="s2">"["</span>
        <span class="n">jump_forward</span> <span class="k">if</span> <span class="n">cell_value</span><span class="p">.</span><span class="nf">zero?</span>

        <span class="n">consume</span>
        <span class="n">element</span> <span class="o">=</span> <span class="vi">@chars</span><span class="p">[</span><span class="vi">@index</span><span class="p">]</span>
      <span class="k">when</span> <span class="s2">"]"</span>
        <span class="k">if</span> <span class="n">cell_value</span><span class="p">.</span><span class="nf">zero?</span>
          <span class="k">while</span> <span class="n">element</span> <span class="o">==</span> <span class="s2">"]"</span>
            <span class="n">consume</span>
            <span class="n">element</span> <span class="o">=</span> <span class="vi">@chars</span><span class="p">[</span><span class="vi">@index</span><span class="p">]</span>
            <span class="n">validate_index</span>
          <span class="k">end</span>
        <span class="k">else</span>
          <span class="n">jump_back</span>
          <span class="n">consume</span>
          <span class="n">element</span> <span class="o">=</span> <span class="vi">@chars</span><span class="p">[</span><span class="vi">@index</span><span class="p">]</span>
        <span class="k">end</span>
      <span class="k">end</span>
      
      <span class="n">consume</span>
      <span class="n">element</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Steve pointed out that the <code class="highlighter-rouge">Scanner#next</code> method was really doing more of a tokenizing operation, and that most of the scanning work was actually being done by the various private methods that were being used to traverse the underlying string. He prepared a patch which made this relationship explicit by introducing a <code class="highlighter-rouge">Tokenizer</code> object which would provide a method to replace <code class="highlighter-rouge">Scanner#next</code>. His newly introduced object allowed for a re-purposing of the <code class="highlighter-rouge">Scanner</code> object which allowed its methods to become public:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">TuringTarpit</span>
  <span class="k">class</span> <span class="nc">Tokenizer</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="n">cell_value</span><span class="p">)</span>
      <span class="n">scanner</span><span class="p">.</span><span class="nf">validate_index</span>

      <span class="n">element</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">current_char</span>

      <span class="k">case</span> <span class="n">element</span>
      <span class="k">when</span> <span class="s2">"["</span>
        <span class="n">scanner</span><span class="p">.</span><span class="nf">jump_forward</span> <span class="k">if</span> <span class="n">cell_value</span><span class="p">.</span><span class="nf">zero?</span>

        <span class="n">scanner</span><span class="p">.</span><span class="nf">consume</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">current_char</span>
      <span class="k">when</span> <span class="s2">"]"</span>
        <span class="k">if</span> <span class="n">cell_value</span><span class="p">.</span><span class="nf">zero?</span>
          <span class="k">while</span> <span class="n">element</span> <span class="o">==</span> <span class="s2">"]"</span>
            <span class="n">scanner</span><span class="p">.</span><span class="nf">consume</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">current_char</span>
            <span class="n">scanner</span><span class="p">.</span><span class="nf">validate_index</span>
          <span class="k">end</span>
        <span class="k">else</span>
          <span class="n">scanner</span><span class="p">.</span><span class="nf">jump_back</span>
          <span class="n">scanner</span><span class="p">.</span><span class="nf">consume</span>
          <span class="n">element</span> <span class="o">=</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">current_char</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">scanner</span><span class="p">.</span><span class="nf">consume</span>
      <span class="n">element</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The thing in particular I liked about this patch is that it abstracted away some of the tedious index operations that were originally present in <code class="highlighter-rouge">Scanner#next</code>. As much as possible I prefer to isolate anything that can cause off-by-one errors or other such nonsense, and this refactoring did a good job of addressing that issue.</p>

<p>The interesting thing about this refactoring is that while I intended to work on the same area of the code if no one else patched it, I had planned to approach it in a very different way. My original idea was to implement some sort of generic stream datastructure and reuse it in both <code class="highlighter-rouge">Scanner</code> and <code class="highlighter-rouge">Tape</code>. However, seeing that Steve’s patch at least partly addressed my concerns while possibly opening some new avenues as well, I abandoned that idea and merged his work instead.</p>

<h3 id="act-ii-building-a-better-horse">Act II. Building a better horse</h3>

<p>After applying the various patches from the folks who participated in this challenge, the code was in a much better place than where it started. However, much work was still left to be done!</p>

<p>In particular, the code responsible for turning Brainfuck syntax into a stream of operations still needed a lot of work. The <code class="highlighter-rouge">Tokenizer</code> class that Steve introduced was an improvement, but without further revisions would simply serve as a layer of indirection rather than as an abstraction. Zed Shaw describes the difference between these two concepts very eloquently in his essay <a href="http://zedshaw.com/essays/indirection_is_not_abstraction.html">Indirection Is Not Abstraction</a> by stating that <em>“Abstraction is used to reduce complexity. Indirection is used to reduce coupling or dependence.”</em></p>

<p>As far as the <code class="highlighter-rouge">Tokenizer</code> object goes, Steve’s patch reducing coupling somewhat by pushing some of the implementation details down into the <code class="highlighter-rouge">Scanner</code> object. However, the procedure is pretty much identical with the exception of the lack of explicit indexing code, and so the baseline complexity actually increases because what was once done by one object is now split across two objects.</p>

<p>To address this problem, the dividing lines between the two objects needed to be leveraged so that they could interact with each other at a higher level. It took me a while to think through the problem, but in doing so I realized that I could now push more functionality down into the <code class="highlighter-rouge">Scanner</code> object so that <code class="highlighter-rouge">Tokenizer#next</code> ended up with fewer moving parts. After some major gutting and re-arranging, I ended up with a method that looked like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">TuringTarpit</span>
  <span class="k">class</span> <span class="nc">Tokenizer</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="n">cell_value</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">scanner</span><span class="p">.</span><span class="nf">next_char</span>
      <span class="k">when</span> <span class="no">Scanner</span><span class="o">::</span><span class="no">FORWARD_JUMP</span>
        <span class="k">if</span> <span class="n">cell_value</span><span class="p">.</span><span class="nf">zero?</span>
          <span class="n">scanner</span><span class="p">.</span><span class="nf">jump_forward</span>
        <span class="k">else</span>
          <span class="n">scanner</span><span class="p">.</span><span class="nf">next_char</span>
        <span class="k">end</span>
      <span class="k">when</span> <span class="no">Scanner</span><span class="o">::</span><span class="no">BACKWARD_JUMP</span>
        <span class="k">if</span> <span class="n">cell_value</span><span class="p">.</span><span class="nf">zero?</span>
          <span class="n">scanner</span><span class="p">.</span><span class="nf">skip_while</span><span class="p">(</span><span class="no">Scanner</span><span class="o">::</span><span class="no">BACKWARD_JUMP</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">scanner</span><span class="p">.</span><span class="nf">jump_back</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">scanner</span><span class="p">.</span><span class="nf">current_char</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>After this refactoring, the <code class="highlighter-rouge">Tokenizer#next</code> method was a good deal more abstract in a number of ways:</p>

<ul>
  <li>
    <p>It expected the <code class="highlighter-rouge">Scanner</code> to handle validations itself rather than telling it when to check the index</p>
  </li>
  <li>
    <p>It no longer referenced Brainfuck syntax and instead used constants provided by the <code class="highlighter-rouge">Scanner</code></p>
  </li>
  <li>
    <p>It eliminated a lot of cumbersome assignments by reworking its algorithm so that <code class="highlighter-rouge">Scanner#current_char</code> always referenced the right character at the end of the scanning routine.</p>
  </li>
  <li>
    <p>It expected the <code class="highlighter-rouge">Scanner</code> to remain internally consistent, rather than handling edge cases itself.</p>
  </li>
</ul>

<p>These reductions in complexity made a hugely positive impact on the readability and understandability of the <code class="highlighter-rouge">Tokenizer#next</code> method. While all of these changes could have technically been made before the split between the <code class="highlighter-rouge">Scanner</code> and <code class="highlighter-rouge">Tokenizer</code> happened, cutting the knot into two pieces certainly made untangling things easier. This is why indirection and abstraction often go hand in hand, despite the fact that they are very different concepts from one another.</p>

<h3 id="act-iii-mountains-are-once-again-merely-mountains">Act III. Mountains are once again merely mountains</h3>

<p>After building on top of Steve’s work to simplify the syntax-processing code even further, I finally felt like that part of the project was in decent shape. I then decided to turn my attention back to the <code class="highlighter-rouge">Interpreter</code> object, since it had not received any love from the challenge participants. The original code for it looked something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">TuringTarpit</span>
  <span class="k">class</span> <span class="nc">Interpreter</span>
    <span class="k">def</span> <span class="nf">run</span>
      <span class="kp">loop</span> <span class="k">do</span>
        <span class="k">case</span> <span class="n">tokenizer</span><span class="p">.</span><span class="nf">next</span><span class="p">(</span><span class="n">tape</span><span class="p">.</span><span class="nf">cell_value</span><span class="p">)</span>
        <span class="k">when</span> <span class="s2">"+"</span>
          <span class="n">tape</span><span class="p">.</span><span class="nf">increment_cell_value</span>
        <span class="k">when</span> <span class="s2">"-"</span>
          <span class="n">tape</span><span class="p">.</span><span class="nf">decrement_cell_value</span>
        <span class="k">when</span> <span class="s2">"&gt;"</span>
          <span class="n">tape</span><span class="p">.</span><span class="nf">increment_pointer</span>
        <span class="k">when</span> <span class="s2">"&lt;"</span>
          <span class="n">tape</span><span class="p">.</span><span class="nf">decrement_pointer</span>
        <span class="k">when</span> <span class="s2">"."</span>
          <span class="nb">putc</span><span class="p">(</span><span class="n">tape</span><span class="p">.</span><span class="nf">cell_value</span><span class="p">)</span>
        <span class="k">when</span> <span class="s2">","</span>
          <span class="n">value</span> <span class="o">=</span> <span class="no">STDIN</span><span class="p">.</span><span class="nf">getch</span><span class="p">.</span><span class="nf">bytes</span><span class="p">.</span><span class="nf">first</span>
          <span class="k">next</span> <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">zero?</span>

          <span class="n">tape</span><span class="p">.</span><span class="nf">cell_value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>While this implementation wasn’t too bad, there were two things I didn’t like about it. The first issue was that it directly referenced Brainfuck syntax, which sort of defeated the purpose of having the tokenizer be syntax independent. The second problem was that I found the case statement to feel a bit brittle and limiting. What I really wanted was a dynamic dispatcher similar to the following method:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">operation</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">.</span><span class="nf">next</span><span class="p">(</span><span class="n">evaluator</span><span class="p">.</span><span class="nf">cell_value</span><span class="p">)</span>
      <span class="n">tape</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In order to introduce this kind of functionality, I’d need to find a place to introduce a simple mapping from Brainfuck syntax to operation names. I already had the keys and values in mind, I just needed to find a place to put them:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">OPERATIONS</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"+"</span> <span class="o">=&gt;</span> <span class="ss">:increment_cell_value</span><span class="p">,</span>
               <span class="s2">"-"</span> <span class="o">=&gt;</span> <span class="ss">:decrement_cell_value</span><span class="p">,</span>
               <span class="s2">"&gt;"</span> <span class="o">=&gt;</span> <span class="ss">:increment_pointer</span><span class="p">,</span>
               <span class="s2">"&lt;"</span> <span class="o">=&gt;</span> <span class="ss">:decrement_pointer</span><span class="p">,</span>
               <span class="s2">"."</span> <span class="o">=&gt;</span> <span class="ss">:output_cell_value</span><span class="p">,</span>
               <span class="s2">","</span> <span class="o">=&gt;</span> <span class="ss">:input_cell_value</span> <span class="p">}</span>
</code></pre>
</div>

<p>Figuring out how to make this work was surprisingly challenging. I found that the extra layers of indirection between the <code class="highlighter-rouge">Tape</code> and the <code class="highlighter-rouge">Scanner</code> meant that any change made too far down the chain would need to be echoed all the way up it, and that changes made towards the top felt tacked on and out of place. This eventually led me to question what the separation between <code class="highlighter-rouge">Scanner</code> and <code class="highlighter-rouge">Tokenizer</code> was really gaining me, as well as the separation between <code class="highlighter-rouge">Interpreter</code> and <code class="highlighter-rouge">Tape</code>.</p>

<p>After a fair amount of ruminating, I decided to take my four objects and join them together at the seams so that only two remained. The <code class="highlighter-rouge">Scanner</code> and <code class="highlighter-rouge">Tokenizer</code> ended up getting joined back together to form a new <code class="highlighter-rouge">Interpreter</code> class. The job of the <code class="highlighter-rouge">Interpreter</code> is to take Brainfuck syntax and turn it into a stream of operations. You can get a rough idea of how it all came together by checking out the following code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">TuringTarpit</span>
  <span class="k">class</span> <span class="nc">Interpreter</span>
    <span class="nc">FORWARD_JUMP</span> <span class="o">=</span> <span class="s2">"["</span>
    <span class="no">BACKWARD_JUMP</span> <span class="o">=</span> <span class="s2">"]"</span>

    <span class="no">OPERATIONS</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"+"</span> <span class="o">=&gt;</span> <span class="ss">:increment_cell_value</span><span class="p">,</span>
                   <span class="s2">"-"</span> <span class="o">=&gt;</span> <span class="ss">:decrement_cell_value</span><span class="p">,</span>
                   <span class="s2">"&gt;"</span> <span class="o">=&gt;</span> <span class="ss">:increment_pointer</span><span class="p">,</span>
                   <span class="s2">"&lt;"</span> <span class="o">=&gt;</span> <span class="ss">:decrement_pointer</span><span class="p">,</span>
                   <span class="s2">"."</span> <span class="o">=&gt;</span> <span class="ss">:output_cell_value</span><span class="p">,</span>
                   <span class="s2">","</span> <span class="o">=&gt;</span> <span class="ss">:input_cell_value</span> <span class="p">}</span>

    <span class="k">def</span> <span class="nf">next_operation</span><span class="p">(</span><span class="n">cell_value</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">next_char</span>
      <span class="k">when</span> <span class="no">FORWARD_JUMP</span>
        <span class="k">if</span> <span class="n">cell_value</span><span class="p">.</span><span class="nf">zero?</span>
          <span class="n">jump_forward</span>
        <span class="k">else</span>
          <span class="n">skip_while</span><span class="p">(</span><span class="no">FORWARD_JUMP</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">when</span> <span class="no">BACKWARD_JUMP</span>
        <span class="k">if</span> <span class="n">cell_value</span><span class="p">.</span><span class="nf">zero?</span>
          <span class="n">skip_while</span><span class="p">(</span><span class="no">BACKWARD_JUMP</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">jump_back</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="no">OPERATIONS</span><span class="p">[</span><span class="n">current_char</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="c1"># ... lots of private methods are back, but now fine-tuned.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The old <code class="highlighter-rouge">Interpreter</code> object and <code class="highlighter-rouge">Tape</code> object were also merged together, forming a single object I ended up calling <code class="highlighter-rouge">Evaluator</code>. The job of the <code class="highlighter-rouge">Evaluator</code> object is to take a stream of operations provided by the newly defined <code class="highlighter-rouge">Interpreter</code> object and then execute them against a Turing Machine like data structure. In essence, the <code class="highlighter-rouge">Evaluator</code> object is nothing more than the original <code class="highlighter-rouge">Tape</code> object I implemented along with a few extra methods which account for the things the original <code class="highlighter-rouge">Interpreter</code> object was meant to do:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">TuringTarpit</span>
  <span class="k">class</span> <span class="nc">Evaluator</span> 
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">run</span><span class="p">(</span><span class="n">interpreter</span><span class="p">)</span>
      <span class="n">evaluator</span> <span class="o">=</span> <span class="kp">new</span>

      <span class="kp">loop</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">=</span> <span class="n">interpreter</span><span class="p">.</span><span class="nf">next_operation</span><span class="p">(</span><span class="n">evaluator</span><span class="p">.</span><span class="nf">cell_value</span><span class="p">)</span>
          <span class="n">evaluator</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">output_cell_value</span>
      <span class="nb">putc</span><span class="p">(</span><span class="n">cell_value</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">input_cell_value</span>
      <span class="n">value</span> <span class="o">=</span> <span class="vg">$stdin</span><span class="p">.</span><span class="nf">getch</span><span class="p">.</span><span class="nf">ord</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="nf">zero?</span>

      <span class="nb">self</span><span class="p">.</span><span class="nf">cell_value</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">end</span>

    <span class="c1"># other methods same as original Tape methods</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I had mixed feelings about recombining these objects, because to some extent it felt like a step backwards to me. In particular, I think this refactoring resulted in some minor violations of the <a href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a>, and increased the overall coupling of the system somewhat. However, the independence of the four different objects the system previously consisted of seemed artificial at best. To the extent that they could be changed easily or swapped out for one another, I could not think of a single practical reason why I’d actually want that kind of flexibility. In this particular situation it turned out that recombining the objects greatly reduced their communications overhead, and so was worth the loss in generality.</p>

<h3 id="epilogue-sending-the-ship-out-to-sea">Epilogue. Sending the ship out to sea</h3>

<p>I was really tempted to keep noodling on the design of this project, because even in my final version of the code I still felt that I could have done better. But at a certain point I decided that I could end up getting caught in this trap forever, and the only way to free myself from it was to wrap up my work and just ship the damn thing. This ultimately meant that I had to take care of several chores that neither I nor the various participants in this challenge bothered to work on earlier:</p>

<ul>
  <li>
    <p>I added a <a href="https://github.com/elm-city-craftworks/turing_tarpit/blob/act3/test/integration/evaluator_test.rb">set of integration tests</a> which ran the <code class="highlighter-rouge">Evaluator</code> against a couple sample Brainfuck programs to make sure we had some decent end-to-end testing support. Found a couple bugs that way.</p>
  </li>
  <li>
    <p>I set up and ran <a href="https://github.com/colszowka/simplecov">simplecov</a> to check whether my tests were at least <em>running</em> all the implementation code, and ended up spotting a faulty test which wasn’t actually getting run.</p>
  </li>
  <li>
    <p>I added a <a href="https://github.com/elm-city-craftworks/turing_tarpit/blob/act3/bin/turing_tarpit">bin/turing_tarpit</a> file so that you can execute Brainfuck programs without building a Ruby shim first.</p>
  </li>
  <li>
    <p>Did the usual gemspec + Gemfile dance and pushed a 1.0.0 gem to rubygems.org. Typically I’d call a project in its early stages a 0.1.0 release, but I honestly don’t see myself working on this much more so I might as well call it ‘production ready’.</p>
  </li>
</ul>

<p>After I wrapped up all these chores, I decided to go back and check out what my <a href="https://github.com/seattlerb/flog">flog</a> complexity scores were for each stage in this process. It turns out that the final version was the least complex, with the lowest overall score, lowest average score, and lowest top-score by method. The original implementation came in second place, and the other two iterations were in a distant third and fourth place. While that gave me some reassurances, it doesn’t mean much except for that Flog seems to really hate external method calls.</p>

<h3 id="reflections">Reflections</h3>

<p>This has been one of my favorite articles to write for Practicing Ruby so far. It forced me to look at the refactoring process in a much more introspective way than I have typically done in the past, and gave me a chance to interact with some of our awesome readers. I do think it ended up raising more questions and challenges in my mind than it did give me answers and reassurances, but I suppose that’s a sign that learning happened.</p>

<p>While I found it very hard to summarize the refactoring lifecycle for this project, my hope is that I’ve at least given you a glimpse of the spiral staircase metaphor I chose to name this article after. If it didn’t end up making you feel too dizzy, I’d love to hear your thoughts about this exercise as well as what your own process is like when it comes to refactoring code.</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
