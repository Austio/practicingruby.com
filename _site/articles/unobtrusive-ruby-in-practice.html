<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>&quot;Unobtrusive Ruby&quot; in Practice</title>
  <meta name="description" content="When Mike Burns outlined his vision of Unobtrusive Ruby, I initially thought it was going to be a hit with the community. However, a lack of specific example...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/unobtrusive-ruby-in-practice">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">"Unobtrusive Ruby" in Practice</h1>
    <p class="post-meta"><time datetime="2011-10-04T00:00:00-04:00" itemprop="datePublished">Oct 4, 2011</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>When Mike Burns outlined his vision of <a href="http://robots.thoughtbot.com/post/10125070413/unobtrusive-ruby">Unobtrusive Ruby</a>, I initially thought it was going to be a hit with the community. However, a lack of specific examples led to a backlash of criticism and caused the post to generate more heat than light. This is unfortunate, because the ideas he outlined are quite valuable and shouldn’t be overlooked.</p>

<p>In this article I share my own interpretation of what Unobtrusive Ruby means, based on the the points that Mike outlined. I can’t guarantee that my take on this is what Mike had in mind, but it should be interesting to those who wanted a more well defined roadmap than what he provided. To get this most out of this article, I recommend going back and <a href="http://robots.thoughtbot.com/post/10125070413/unobtrusive-ruby">reading what Mike wrote</a> before continuing on. Try to think about what these concepts mean to you, and then compare them to what I’ve outlined here.</p>

<p>The following guidelines are the ones Mike laid out, but I’ve replaced his explanations with my own in the hopes that attacking these ideas from a second angle will be useful.</p>

<h2 id="take-objects-not-classes">Take Objects, Not Classes</h2>

<p>Because Ruby lets us pass classes around like any other object, we have a way to do dependency injection that isn’t as common in other languages. For example, we can write something like the following code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Roster</span>
 <span class="k">def</span> <span class="nf">initialize</span>          
    <span class="vi">@participants</span> <span class="o">=</span> <span class="p">[]</span>  
  <span class="k">end</span>  
  
  <span class="k">def</span> <span class="nf">&lt;&lt;</span><span class="p">(</span><span class="n">new_participant</span><span class="p">)</span>  
    <span class="vi">@participants</span> <span class="o">&lt;&lt;</span> <span class="n">new_participant</span>  
  <span class="k">end</span>  
  
  <span class="k">def</span> <span class="nf">participant_names</span>  
    <span class="vi">@participants</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">full_name</span> <span class="p">}</span>  
  <span class="k">end</span>  
  
  <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="n">printer</span><span class="o">=</span><span class="no">RosterPrinter</span><span class="p">)</span>
    <span class="n">printer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">participant_names</span><span class="p">).</span><span class="nf">print</span>
  <span class="k">end</span>    
<span class="k">end</span>

<span class="k">class</span> <span class="nc">RosterPrinter</span>  
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">participant_names</span><span class="p">)</span>  
    <span class="vi">@participant_names</span> <span class="o">=</span> <span class="n">participant_names</span>  
  <span class="k">end</span>  
  
  <span class="k">def</span> <span class="nf">print</span>
    <span class="nb">puts</span> <span class="s2">"Participants:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span>  
    <span class="vi">@participant_names</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="s2">"* </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span> <span class="p">}.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>  
  <span class="k">end</span>  
<span class="k">end</span> 
</code></pre>
</div>

<p>This feels clever, but this form of dependency injection is more brittle than it
needs to be. A <a href="http://blog.rubybestpractices.com/posts/gregory/055-issue-23-solid-design.html#comment-317367342">recent conversation with Derick
Bailey</a>
on my <a href="http://blog.rubybestpractices.com/posts/gregory/055-issue-23-solid-design.html">SOLID
article</a>
about a very similar example made me realize just how much we tend to pass
classes around unnecessarily when we could be directly passing the objects our
class depends on. With that in mind, Derick helped me refactor the previous example to the more flexible design shown below.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Roster</span>
 <span class="k">def</span> <span class="nf">initialize</span>          
    <span class="vi">@participants</span> <span class="o">=</span> <span class="p">[]</span>  
  <span class="k">end</span>  
  
  <span class="k">def</span> <span class="nf">&lt;&lt;</span><span class="p">(</span><span class="n">new_participant</span><span class="p">)</span>  
    <span class="vi">@participants</span> <span class="o">&lt;&lt;</span> <span class="n">new_participant</span>  
  <span class="k">end</span>  
  
  <span class="k">def</span> <span class="nf">participant_names</span>  
    <span class="vi">@participants</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">full_name</span> <span class="p">}</span>  
  <span class="k">end</span>  
  
  <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="n">printer</span><span class="o">=</span><span class="no">RosterPrinter</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
    <span class="n">printer</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="vi">@participants</span><span class="p">)</span>
  <span class="k">end</span>    
<span class="k">end</span>

<span class="k">class</span> <span class="nc">RosterPrinter</span>    
  <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="n">participant_names</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Participants:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span>  
    <span class="n">participant_names</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="s2">"* </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span> <span class="p">}.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>  
  <span class="k">end</span>  
<span class="k">end</span> 
</code></pre>
</div>

<p>While this is a subtle change, it has a major impact on the way <code class="highlighter-rouge">Roster</code> and its printer object relate to one another. The <code class="highlighter-rouge">Roster#print</code> method originally had a dependency on both the constructor of its printer object as well as its <code class="highlighter-rouge">print()</code> instance method. Our new code reduces that coupling by depending only on the existence of a <code class="highlighter-rouge">print()</code> method in the general case. The examples below demonstrate the added flexibility that this new approach offers us.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1"># does not provide a .new() method</span>
<span class="k">module</span> <span class="nn">FunctionalPrinter</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">print</span><span class="p">(</span><span class="n">participant_names</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Participants:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span>  
    <span class="n">participant_names</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="s2">"* </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span> <span class="p">}.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>  
  <span class="k">end</span>
<span class="k">end</span>

<span class="nb">require</span> <span class="s2">"prawn"</span>

<span class="c1"># has a different constructor than RosterPrinter</span>
<span class="k">class</span> <span class="nc">PDFPrinter</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="vi">@document</span> <span class="o">=</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span>
    <span class="vi">@filename</span> <span class="o">=</span> <span class="n">filename</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="n">participant_names</span><span class="p">)</span>
    <span class="vi">@document</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="s2">"Participants"</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">16</span><span class="p">)</span>

    <span class="n">participant_names</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
      <span class="vi">@document</span><span class="p">.</span><span class="nf">text</span><span class="p">(</span><span class="s2">"- </span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="vi">@document</span><span class="p">.</span><span class="nf">render_file</span><span class="p">(</span><span class="vi">@filename</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">roster</span> <span class="o">=</span> <span class="no">Roster</span><span class="p">.</span><span class="nf">new</span>
<span class="n">roster</span> <span class="o">&lt;&lt;</span> <span class="s2">"Gregory Brown"</span> <span class="o">&lt;&lt;</span> <span class="s2">"Jia Wu"</span> <span class="o">&lt;&lt;</span> <span class="s2">"Jordan Byron"</span>

<span class="nb">puts</span> <span class="s2">"USING DEFAULT"</span>
<span class="n">roster</span><span class="p">.</span><span class="nf">print</span>

<span class="nb">puts</span> <span class="s2">"USING FUNCTIONAL PRINTER"</span>
<span class="n">roster</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="no">FunctionalPrinter</span><span class="p">)</span>

<span class="nb">puts</span> <span class="s2">"USING PDF PRINTER (see roster.pdf)"</span>
<span class="n">roster</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="no">PDFPrinter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"roster.pdf"</span><span class="p">))</span>
</code></pre>
</div>

<p>Both the <code class="highlighter-rouge">FunctionalPrinter</code> and <code class="highlighter-rouge">PDFPrinter</code> demonstrate corner cases that our original code did not account for. By following the guideline of accepting objects rather than classes as the arguments to our methods, our new design can accomodate these types of objects without modification of the <code class="highlighter-rouge">Roster#print</code> code. As we see from these examples, this makes life easier for us.</p>

<h2 id="never-require-inheritance">Never Require Inheritance</h2>

<p>Some libaries we use strongly encourages us to create subclasses of the objects they provide, while others downright force us to do so. <code class="highlighter-rouge">ActiveRecord</code> is an example of a library that is almost useless without inheritance, but is very complicated and would be hard to use as an example. The code below is a much simpler example of a tool which expects you to use subclasses of its provided <code class="highlighter-rouge">Plugin</code> class to get the job done.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Inspector</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="no">Plugin</span><span class="p">.</span><span class="nf">registered_plugins</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Plugin</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">inherited</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
      <span class="n">registered_plugins</span> <span class="o">&lt;&lt;</span> <span class="n">base</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">registered_plugins</span>
      <span class="vi">@registered_plugins</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">WordCountPlugin</span> <span class="o">&lt;</span> <span class="no">Inspector</span><span class="o">::</span><span class="no">Plugin</span>
  <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">word_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">).</span><span class="nf">length</span>
    <span class="nb">puts</span> <span class="s2">"Content contained </span><span class="si">#{</span><span class="n">word_count</span><span class="si">}</span><span class="s2"> words"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">WordLengthPlugin</span> <span class="o">&lt;</span> <span class="no">Inspector</span><span class="o">::</span><span class="no">Plugin</span>
  <span class="k">def</span> <span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">longest</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">length</span> <span class="p">}.</span><span class="nf">max</span>
    <span class="nb">puts</span> <span class="s2">"Longest word contained </span><span class="si">#{</span><span class="n">longest</span><span class="si">}</span><span class="s2"> characters"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Inspector</span><span class="p">.</span><span class="nf">analyze</span><span class="p">(</span><span class="s2">"This is a test of the watcher plugins"</span><span class="p">)</span>

<span class="c1">## OUTPUTS</span>
<span class="no">Content</span> <span class="n">contained</span> <span class="mi">8</span> <span class="n">words</span>
<span class="no">Longest</span> <span class="n">word</span> <span class="n">contained</span> <span class="mi">7</span> <span class="n">characters</span>   
</code></pre>
</div>

<p>Using the <code class="highlighter-rouge">inherited</code> hook is a clever way to implictly register plugins, but comes with a number of downsides. For example, you are forced to make all your plugins inherit from <code class="highlighter-rouge">Inspector::Plugin</code>, which means your class can’t be a subclass of anything else. Additionally, you need to use a class even if a module would make more sense. This is a direct consequence of the “interface taking classes rather than ordinary objects” issue, and cannot be easily avoided. If you throw in things like having to be aware of possible Liskov Substitution Principle violations, it becomes clear that an API which forces you to use subclassing is not exactly flexible.</p>

<p>The code below shows a much more flexible alternative, which completely removes the dependency on class inheritance.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Inspector</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">registered_plugins</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">registered_plugins</span>
    <span class="vi">@registered_plugins</span> <span class="o">||=</span> <span class="p">[]</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">WordCountPlugin</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">word_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">).</span><span class="nf">length</span>
    <span class="nb">puts</span> <span class="s2">"Content contained </span><span class="si">#{</span><span class="n">word_count</span><span class="si">}</span><span class="s2"> words"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">WordLengthPlugin</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">longest</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">length</span> <span class="p">}.</span><span class="nf">max</span>
    <span class="nb">puts</span> <span class="s2">"Longest word contained </span><span class="si">#{</span><span class="n">longest</span><span class="si">}</span><span class="s2"> characters"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Inspector</span><span class="p">.</span><span class="nf">registered_plugins</span> <span class="o">&lt;&lt;</span> <span class="no">WordCountPlugin</span> <span class="o">&lt;&lt;</span> <span class="no">WordLengthPlugin</span>
<span class="no">Inspector</span><span class="p">.</span><span class="nf">analyze</span><span class="p">(</span><span class="s2">"This is a test of the watcher plugins"</span><span class="p">)</span>
</code></pre>
</div>

<p>Now any object that has a valid <code class="highlighter-rouge">analyze</code> method will work as a plugin, as long as you explicitly register it with <code class="highlighter-rouge">Inspector</code>. This results in much cleaner looking code for this trivial implementation, but the general strategy can also can be used in situations where inheritance is still a part of the picture. The code below shows plugins which inherit from a parent class coexisting with plugins built from scratch.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Inspector</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">registered_plugins</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">e</span><span class="p">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">registered_plugins</span>
    <span class="vi">@registered_plugins</span> <span class="o">||=</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Plugin</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">verify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">validations</span> <span class="o">&lt;&lt;</span> <span class="n">block</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">validations</span>
      <span class="vi">@validations</span> <span class="o">||=</span> <span class="p">[]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">analyze</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">define_method</span> <span class="ss">:analyze</span> <span class="k">do</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span>
        <span class="n">validate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
        <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
      <span class="k">raise</span> <span class="k">unless</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">validations</span><span class="p">.</span><span class="nf">all?</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">WordCountPlugin</span> <span class="o">&lt;</span> <span class="no">Inspector</span><span class="o">::</span><span class="no">Plugin</span>
  <span class="n">verify</span> <span class="p">{</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span> <span class="n">data</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">String</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">analyze</span> <span class="k">do</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span>
    <span class="n">word_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">).</span><span class="nf">length</span>
    <span class="nb">puts</span> <span class="s2">"Content contained </span><span class="si">#{</span><span class="n">word_count</span><span class="si">}</span><span class="s2"> words"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">WordLengthPlugin</span>
  <span class="c1"># same as before, not inheriting from anything</span>
<span class="k">end</span>

<span class="no">Inspector</span><span class="p">.</span><span class="nf">registered_plugins</span> <span class="o">&lt;&lt;</span> <span class="no">WordCountPlugin</span><span class="p">.</span><span class="nf">new</span> <span class="o">&lt;&lt;</span> <span class="no">WordLengthPlugin</span>
<span class="no">Inspector</span><span class="p">.</span><span class="nf">analyze</span><span class="p">(</span><span class="s2">"This is a test of the watcher plugins"</span><span class="p">)</span>
</code></pre>
</div>

<p>This small change makes a big difference in flexibility, and leaves some of the decision making up to your users rather than forcing them down a particular path. Using the default approach of inheriting from <code class="highlighter-rouge">Inspector::Plugin</code> will feel nearly identical to an inheritance-only approach to the user. However, if more customizations are needed, this design provides an easy way to build plugins from scratch. Because it is so easy to implement this pattern, it is probably worth doing even if your immediate needs don’t call for such flexibility.</p>

<h2 id="inject-dependencies">Inject Dependencies</h2>

<p>I covered dependency injection and the dependency inversion principle at length in <a href="http://blog.rubybestpractices.com/posts/gregory/055-issue-23-solid-design.html">Practicing Ruby 1.23</a>. Rather than repeating those details here, I’d like you to read that article as well as the comments from <a href="http://blog.rubybestpractices.com/posts/gregory/055-issue-23-solid-design.html#comment-317367342">Derick Bailey</a>. My conversation with Derick taught me a thing or two about the subtle distinctions between dependency injection (a technique) and dependency inversion (a design principle) that are hard to summarize but still well worth working through if you want to solidify your understanding of these two very important concepts.</p>

<p>As an example of some practical code which uses dependency injection, we can look at the Highline command line library. In ordinary usage, Highline outputs everything to <code class="highlighter-rouge">STDIN</code> and <code class="highlighter-rouge">STDOUT</code>. You can install HighLine via RubyGems and run the example below to get a feel for how it works.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"highline"</span>

<span class="n">console</span> <span class="o">=</span> <span class="no">HighLine</span><span class="p">.</span><span class="nf">new</span>
<span class="nb">name</span>    <span class="o">=</span> <span class="n">console</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"What is your name?"</span><span class="p">)</span> 
<span class="n">console</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">"Hello </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre>
</div>

<p>In ordinary cases, this is exactly what we want: ordinary input and output from your console. However, to test HighLine, we made it possible to inject input and output objects to use in place of <code class="highlighter-rouge">STDIN</code> and <code class="highlighter-rouge">STDOUT</code>. The example below shows the use of <code class="highlighter-rouge">StringIO</code> objects, which is what we use in our unit tests.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"stringio"</span>
<span class="nb">require</span> <span class="s2">"highline"</span>

<span class="n">input</span>   <span class="o">=</span> <span class="no">StringIO</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Gregory</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="n">input</span><span class="p">.</span><span class="nf">rewind</span> <span class="c1"># set seek pos back to 0</span>

<span class="n">output</span>  <span class="o">=</span> <span class="no">StringIO</span><span class="p">.</span><span class="nf">new</span>

<span class="n">console</span> <span class="o">=</span> <span class="no">HighLine</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
<span class="nb">name</span> <span class="o">=</span> <span class="n">console</span><span class="p">.</span><span class="nf">ask</span><span class="p">(</span><span class="s2">"What is your name?"</span><span class="p">)</span>
<span class="n">console</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">"Hello </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">!"</span><span class="p">)</span>

<span class="n">output</span><span class="p">.</span><span class="nf">rewind</span>
<span class="nb">puts</span> <span class="n">output</span><span class="p">.</span><span class="nf">read</span>
</code></pre>
</div>

<p>Interestingly enough, this ‘feature’ of HighLine has caused it to be used in a number of contexts that we didn’t anticipate. For example, it is occasionally used in GUI programs for its input validation features, and sometimes used in non-interactive scripts for its text formatting features. If we had directly worked against <code class="highlighter-rouge">STDIN</code> and <code class="highlighter-rouge">STDOUT</code>, these ways of using HighLine would not be possible without ugly hacks.</p>

<h2 id="unit-tests-are-fast">Unit Tests Are Fast</h2>

<p>Personally, I am not obsessive about unit test performance. Many Rubyists care a lot about this, and advocate the heavy use of mock objects to speed up your tests. Mike points out in his article that the combination of “mock objects, a lack of inheritance, and injected dependencies” will make your tests fast, and that’s basically true.</p>

<p>Dependency injection does facilitate the use of mock objects, and our HighLine example demonstrates why that is the case. A lack of inheritance might imply that your method call chains are shorter and that you have fewer dependencies, but it’s not as strong of a metric as he makes it seem. Eventually, object composition can end up being more-or-less the same as inheritance in complexity, and in those cases you may still end up with slow tests. But the fact that composed object systems are easier to decouple is probably what he’s getting at here.</p>

<p>For some practical examples of how you can use mocks to decouple your tests from your code and speed things up a bit, see <a href="http://blog.rubybestpractices.com/posts/gregory/052-issue-20-thoughts-on-mocking.html">Practicing Ruby 1.20</a>. If you read through that article, you’ll find out why I don’t care so much about limiting my dependencies to only the object under test. But when all else is considered equal, fewer dependencies means less code, which probably means faster tests.</p>

<p>Having a performant test suite is certainly ideal, it’s just a matter of weighing out the costs of fine tuning your test suite vs. the benefits that faster test runs provide. Personally I felt that Mike came on a bit too strong about this particular point, but many well known Rubyists would disagree with me on this one.</p>

<h2 id="require-no-interface">Require No Interface</h2>

<p>Mike suggests that your library code should allow your user to be able to name their methods however they want, and should be designed to consume rather than be consumed. He then recognizes that this may not always be possible, and concedes that if you need the user to implement certain features, that you should limit it to one or two methods at the most. This is great general advice, and if you look at Ruby itself, we can find some good examples.</p>

<p>The <code class="highlighter-rouge">Enumerable</code> module is capable of providing the vast majority of its features if the user implements only an <code class="highlighter-rouge">each</code> method. If you want to use things like <code class="highlighter-rouge">sort</code>, you only need the yielded elements to implement a <code class="highlighter-rouge">&lt;=&gt;</code> method. This means that all features in <code class="highlighter-rouge">Enumerable</code> can be supported by “one or two methods” implemented by the user, which makes it a very good API considering the great wealth of functionality it provides.</p>

<p>However, <code class="highlighter-rouge">Enumerator</code> takes things a step farther by requiring no interface at all. You can name the methods of the target collection anything you want, you simply need to tell <code class="highlighter-rouge">Enumerator</code> which method it should delegate its <code class="highlighter-rouge">each</code> method to when you initialize an <code class="highlighter-rouge">Enumerator</code>. See the example below to see how flexible this approach is.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">RandomInfiniteList</span>
  <span class="k">def</span> <span class="nf">generate</span>
    <span class="kp">loop</span> <span class="k">do</span>
      <span class="k">yield</span> <span class="nb">rand</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">enum</span> <span class="o">=</span> <span class="no">Enumerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">RandomInfiniteList</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="ss">:generate</span><span class="p">)</span>
<span class="nb">p</span> <span class="n">enum</span><span class="p">.</span><span class="nf">next</span>
<span class="nb">p</span> <span class="n">enum</span><span class="p">.</span><span class="nf">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre>
</div>

<p>In this way, <code class="highlighter-rouge">Enumerator</code> can be made to turn any object with an iterator method into an <code class="highlighter-rouge">Enumerable</code> object, regardless what the name of that method is. This can be useful when you’re working with unidiomatic Ruby objects which provide an iterator but do not mix in <code class="highlighter-rouge">Enumerable</code>.</p>

<p>We can also look at a bit less abstract of an example. If we look back at our <code class="highlighter-rouge">Inspector</code> example that we were using to discuss how to avoid hard inheritance requirements, we can see that it requires only a small interface for plugins to conform to. While it isn’t so bad that each plugin needed an <code class="highlighter-rouge">analyze</code> method in our last iteration, we can make some modifications to make it so that it depends on no interface at all, which may bring us a step closer to what Mike was hinting at.</p>

<p>The example below shows what an <code class="highlighter-rouge">Inspector</code> class which implements a “expects no interface” API style might look like. To keep things interesting, I’ve left implementing this class up to you. If you get stuck, feel free to leave a comment asking for hints on how to build this out.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1"># delegates to the WordLengthPlugin module</span>
<span class="no">Inspector</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Word Length"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span>
  <span class="no">WordLengthPlugin</span><span class="p">.</span><span class="nf">analyze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># implements the report as an inline function</span>
<span class="no">Inspector</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Word Count"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">data</span><span class="o">|</span>
  <span class="n">word_count</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sr">/ /</span><span class="p">).</span><span class="nf">length</span>
  <span class="nb">puts</span> <span class="s2">"Content contained </span><span class="si">#{</span><span class="n">word_count</span><span class="si">}</span><span class="s2"> words"</span>
<span class="k">end</span>

<span class="no">Inspector</span><span class="p">.</span><span class="nf">analyze</span><span class="p">(</span><span class="s2">"This is a test of the watcher plugins"</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="data-not-action">Data, Not Action</h2>

<p>This guideline seems to boil down to the idea that your API calls should be simple ‘data in, data out’ operations whenever that level of simplicity is easily within reach. After thinking about this concept a bit, I realized that a pair of common Ruby operations serve as perfect examples.</p>

<p>Suppose that you want to open a binary file and read its contents into a <code class="highlighter-rouge">String</code>. You could write the following code and it will get the job done.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">file</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"foo.jpg"</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">)</span>
<span class="n">image_data</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="nf">read</span>
<span class="n">file</span><span class="p">.</span><span class="nf">close</span>
</code></pre>
</div>

<p>But this approach is only the correct way to do things if you want to explicitly work with the <code class="highlighter-rouge">File</code> object and control exactly when it gets opened and closed. If all you want to do is read the contents of a binary file, this is three actions for what should be one “data in, data out” operation. Fortunately, Ruby recognizes this as a common use case and provides a nicer API that you can use instead.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">image_data</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">binread</span><span class="p">(</span><span class="s2">"foo.jpg"</span><span class="p">)</span>
</code></pre>
</div>

<p>In this example, we pass the filename and get back the contents of that file data. While we have less control over the overall process, we also get to ignore irrelevant details like exactly when the file is opened and closed. This is what I think that Mike probably meant when he said “data, not action”, and can be applied when designing your own APIs. To drive the point home further, we can look at one example.</p>

<p>The code below shows the generic form of doing a GET request via the <code class="highlighter-rouge">Net::HTTP</code> standard library. It is not the most terse way to use <code class="highlighter-rouge">Net::HTTP</code>, but one of the most common.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'net/http'</span>

<span class="n">url</span> <span class="o">=</span> <span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s1">'http://www.google.com'</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="n">url</span><span class="p">.</span><span class="nf">port</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">http</span><span class="o">|</span>
  <span class="n">http</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">res</span><span class="p">.</span><span class="nf">body</span>
</code></pre>
</div>

<p>There is a whole lot going on here, including explicit <code class="highlighter-rouge">URI</code> parsing and explicit calls to <code class="highlighter-rouge">get()</code>. But as we saw with <code class="highlighter-rouge">File.open</code> vs. <code class="highlighter-rouge">File.binread</code>, Ruby provides a convenient alternative for this very common operation. The open-uri standard library makes it possible to write the following code instead.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"open-uri"</span>

<span class="nb">puts</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"http://google.com"</span><span class="p">).</span><span class="nf">read</span>
</code></pre>
</div>

<p>Once again, we see a series of complex actions being converted into a simple “data in, data out” operation. In this case, we are converting a string which represents a URI into an IO object via the globally available <code class="highlighter-rouge">open()</code> method. This makes it possible for us to not think about explicitly parsing our string into a <code class="highlighter-rouge">URI</code> object, and lets us ignore the details about starting a HTTP connection and explicitly making a GET request. When all we want is the source of a web page, it’s great to be able to ignore these details.</p>

<h2 id="always-be-coding">Always Be Coding</h2>

<p>As I reflect back on Mike’s guidelines for “Unobtrusive Ruby”, it all seems to come down to making life easier for your users by limited the amount of impact your system has on them. Give your users small, flexible APIs that do not demand much of their systems, and they will have better luck using your code. This seems like a noble set of goals to me, and hopefully my examples demonstrate the same spirit that Mike wanted to encourage in his post.</p>

<p>However, I always worry about using design guidelines like these as some sort of absolute set of commandments. There were a whole lot of words like “always” and “never” in the original “Unobtrusive Ruby” post which if left unchecked, could cause more harm than good. For me, context is king, and these ideas seem much more important for those who are writing code that is intended for widespread reuse than they might be for ordinary application development. That having been said, the examples I’ve shown here demonstrate that you can often be on the right side of these guidelines with little to no additional effort. This means that if we can keep the ideas behind “Unobtrusive Ruby” in the back of our mind and apply them when it’s an easy fit, we may well end up improving our code for the better.</p>

<p>This article is meant to be a conversation starter, and is not meant to be taken as gospel. Please share your own thoughts on what “Unobtrusive Ruby” means to you, either via a comment here or on your own blog. I think it’s a conversation worth having, even if we haven’t quite nailed down all the definitions yet. If we end up getting an interesting discussion going, I’ll invite Mike to check out what we’ve discussed and see what he thinks about it.</p>

<p>So what do you think? Was my code unobtrusive enough for you? If not, why not? ;)</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
