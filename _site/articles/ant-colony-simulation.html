<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Simulating the emergent behavior of ant colonies</title>
  <meta name="description" content="This article is based on a heavily modified Ruby port of Rich Hickey’s Clojure ant simulator. Although I didn’t directly collaborate with Rich on this issue ...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/ant-colony-simulation">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
          <a class="page-link" href="/about">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Simulating the emergent behavior of ant colonies</h1>
    <p class="post-meta"><time datetime="2012-11-27T00:00:00-05:00" itemprop="datePublished">Nov 27, 2012</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><em>This article is based on a <a href="https://github.com/elm-city-craftworks/practicing-ruby-examples/tree/master/v5/009">heavily modified Ruby port</a> 
of Rich Hickey’s <a href="https://gist.github.com/1093917">Clojure ant simulator</a>. Although I didn’t directly collaborate with Rich on this issue of 
Practicing Ruby, I learned a lot from his code and it provided
me with a great foundation to start from.</em></p>

<p>Watch as a small ant colony identifies and completely consumes its four nearest
food sources:</p>

<div align="center">
<iframe width="720" height="480" src="//www.youtube.com/embed/f2IX1Y5o6pc?rel=0" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>While this search effort may seem highly organized, it is the
result of very simple decisions made by individual ants. On each
tick of the simulation, each ant decides its next action based only on its
current location and the three adjacent locations ahead of it. But 
because ants can indirectly communicate via their environment, complex 
behavior arises in the aggregate.</p>

<p>Emergence and self-organization are popular concepts in programming, but far too many
developers start and end their explorations into these ideas with <a href="http://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Conway’s Game of Life</a>. 
In this article, I will help you see these fascinating properties in a new
light by demonstrating the role they play in <a href="http://en.wikipedia.org/wiki/Ant_colony_optimization">ant colony optimization (ACO)</a> algorithms.</p>

<blockquote>
  <p><strong>NOTE:</strong> There are many ways to simulate ant behavior, some of which can be quite useful
for a wide range of search applications. For this article, I have built
a fairly naïve simulation that is meant to loosely mimic the kind of ant
behavior you can observe in the natural world. This article <em>may</em> be useful as a 
brief introduction to ACO, but be sure to dig deeper if you are interested in
practical applications. My goal is to provide a great example of emergent 
behavior, NOT a great reference for nature-inspired search algorithms.</p>
</blockquote>

<h2 id="modeling-the-state-of-an-ant-colony">Modeling the state of an ant colony</h2>

<p>This simulated world consists of many cells: some are food sources, 
some are part of the colony’s nest, and the rest are an
open field that needs to be traversed. Each cell can contain a single 
ant facing in one of the eight directions you’d find on a compass. 
As the ants move around the world, they mark the cells they visit with
a trail of pheromones that helps them find their way between their 
nest and nearby food sources. Pheromones accumulate as more ants 
travel across a given trail, but they also gradually evaporate. 
The combination of these two properties of pheromones helps 
ants find efficient paths to nearby food sources.</p>

<p>Subtle changes to any of these rules can yield very different outcomes, 
and finding an optimal result will necessarily involve some
experimentation. Knowing that, it makes sense for the simulator to 
have a data model that is divorced from its domain logic. Many
behavioral changes can be made without altering the
underlying data model, and that allows the <code class="highlighter-rouge">Ant</code>, <code class="highlighter-rouge">Cell</code>, and <code class="highlighter-rouge">World</code> constructs to
be defined as simple value objects as shown below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">AntSim</span> 
  <span class="k">class</span> <span class="nc">Ant</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">direction</span> <span class="o">=</span> <span class="n">direction</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">location</span>  <span class="o">=</span> <span class="n">location</span>
    <span class="k">end</span>

    <span class="kp">attr_accessor</span> <span class="ss">:food</span><span class="p">,</span> <span class="ss">:direction</span><span class="p">,</span> <span class="ss">:location</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Cell</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">food</span><span class="p">,</span> <span class="n">home_pheremone</span><span class="p">,</span> <span class="n">food_pheremone</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">food</span>           <span class="o">=</span> <span class="n">food</span> 
      <span class="nb">self</span><span class="p">.</span><span class="nf">home_pheremone</span> <span class="o">=</span> <span class="n">home_pheremone</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">food_pheremone</span> <span class="o">=</span> <span class="n">food_pheremone</span>
    <span class="k">end</span>

    <span class="kp">attr_accessor</span> <span class="ss">:food</span><span class="p">,</span> <span class="ss">:home_pheremone</span><span class="p">,</span> <span class="ss">:food_pheremone</span><span class="p">,</span> <span class="ss">:ant</span><span class="p">,</span> <span class="ss">:home</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">World</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">world_size</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">size</span> <span class="o">=</span> <span class="n">world_size</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">data</span> <span class="o">=</span> <span class="n">size</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">size</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="no">Cell</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
      <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">location</span>

      <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">sample</span>
      <span class="n">data</span><span class="p">[</span><span class="nb">rand</span><span class="p">(</span><span class="n">size</span><span class="p">)][</span><span class="nb">rand</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">each</span>
      <span class="n">data</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">col</span><span class="p">,</span><span class="n">x</span><span class="o">|</span> 
        <span class="n">col</span><span class="p">.</span><span class="nf">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">cell</span><span class="p">,</span> <span class="n">y</span><span class="o">|</span> 
          <span class="k">yield</span> <span class="p">[</span><span class="n">cell</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]]</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="kp">attr_accessor</span> <span class="ss">:data</span><span class="p">,</span> <span class="ss">:size</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>These classes are somewhat peculiar in that they are very state-centric and 
do not encapsulate any interesting domain logic. Although it won’t win us
object-oriented style points, designing things this way decouples the state of 
the simulated world from both the events that happen within it and the 
optimization algorithms that run against it. These objects
represent only the nouns of our system, leaving it up to their collaborators 
to supply the verbs.</p>

<h2 id="moving-around-the-world">Moving around the world</h2>

<p>The ants in this system are surprisingly limited in their behavior. On each 
and every iteration, their entire decision making process can result 
in exactly one of the following outcomes:</p>

<p><img src="http://i.imgur.com/VsBkn.png" alt="Ant movement rules" /></p>

<p>Most of these actions are extremely localized. Turning does not affect any
cells, while moving only affects the cell the ant currently occupies
and the one immediately in front of it. However, taking or dropping food
triggers a pheromone update, affecting every cell the ant has 
visited since the last time it updated its trails. This can have far-reaching
effects on the behavior of the rest of the colony, even though each individual
ant can only sense the pheromone levels of its own cell and the three cells
directly in front of it. While natural ants must drop pheromone
continuously as they walk, artificial ants can improve upon nature by
updating entire paths instantaneously.</p>

<p>An object that implements these behaviors needs to know about the structure of
the <code class="highlighter-rouge">Ant</code>, <code class="highlighter-rouge">Cell</code>, and <code class="highlighter-rouge">World</code> objects, but it still does not
need to know much about the core domain logic of the simulator. What we want is
an <code class="highlighter-rouge">Actor</code> that understands its world and how to play specific roles within it, 
but does not attempt to define the broader story arc:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"set"</span>

<span class="k">module</span> <span class="nn">AntSim</span>
  <span class="k">class</span> <span class="nc">Actor</span>
    <span class="nc">DIR_DELTA</span>   <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">ant</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">world</span>   <span class="o">=</span> <span class="n">world</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">ant</span>     <span class="o">=</span> <span class="n">ant</span>

      <span class="nb">self</span><span class="p">.</span><span class="nf">history</span> <span class="o">=</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span>
    <span class="k">end</span>

    <span class="kp">attr_reader</span> <span class="ss">:ant</span>

    <span class="k">def</span> <span class="nf">turn</span><span class="p">(</span><span class="n">amt</span><span class="p">)</span>
      <span class="n">ant</span><span class="p">.</span><span class="nf">direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">ant</span><span class="p">.</span><span class="nf">direction</span> <span class="o">+</span> <span class="n">amt</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span>

      <span class="nb">self</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">move</span>
      <span class="n">history</span> <span class="o">&lt;&lt;</span> <span class="n">here</span>

      <span class="n">new_location</span> <span class="o">=</span> <span class="n">neighbor</span><span class="p">(</span><span class="n">ant</span><span class="p">.</span><span class="nf">direction</span><span class="p">)</span>

      <span class="n">ahead</span><span class="p">.</span><span class="nf">ant</span> <span class="o">=</span> <span class="n">ant</span>
      <span class="n">here</span><span class="p">.</span><span class="nf">ant</span>  <span class="o">=</span> <span class="kp">nil</span>

      <span class="n">ant</span><span class="p">.</span><span class="nf">location</span> <span class="o">=</span> <span class="n">new_location</span>

      <span class="nb">self</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">drop_food</span>
      <span class="n">here</span><span class="p">.</span><span class="nf">food</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">ant</span><span class="p">.</span><span class="nf">food</span>   <span class="o">=</span> <span class="kp">false</span>

      <span class="nb">self</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">take_food</span>
      <span class="n">here</span><span class="p">.</span><span class="nf">food</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="n">ant</span><span class="p">.</span><span class="nf">food</span>   <span class="o">=</span> <span class="kp">true</span>

      <span class="nb">self</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">mark_food_trail</span>
      <span class="n">history</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">old_cell</span><span class="o">|</span>
        <span class="n">old_cell</span><span class="p">.</span><span class="nf">food_pheremone</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">unless</span> <span class="n">old_cell</span><span class="p">.</span><span class="nf">food</span> <span class="o">&gt;</span> <span class="mi">0</span> 
      <span class="k">end</span>

      <span class="n">history</span><span class="p">.</span><span class="nf">clear</span>

      <span class="nb">self</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">mark_home_trail</span>
      <span class="n">history</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">old_cell</span><span class="o">|</span>
        <span class="n">old_cell</span><span class="p">.</span><span class="nf">home_pheremone</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">unless</span> <span class="n">old_cell</span><span class="p">.</span><span class="nf">home</span>
      <span class="k">end</span>

      <span class="n">history</span><span class="p">.</span><span class="nf">clear</span>

      <span class="nb">self</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">foraging?</span>
      <span class="o">!</span><span class="n">ant</span><span class="p">.</span><span class="nf">food</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">here</span>
      <span class="n">world</span><span class="p">[</span><span class="n">ant</span><span class="p">.</span><span class="nf">location</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">ahead</span>
      <span class="n">world</span><span class="p">[</span><span class="n">neighbor</span><span class="p">(</span><span class="n">ant</span><span class="p">.</span><span class="nf">direction</span><span class="p">)]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">ahead_left</span>
      <span class="n">world</span><span class="p">[</span><span class="n">neighbor</span><span class="p">(</span><span class="n">ant</span><span class="p">.</span><span class="nf">direction</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">ahead_right</span>
      <span class="n">world</span><span class="p">[</span><span class="n">neighbor</span><span class="p">(</span><span class="n">ant</span><span class="p">.</span><span class="nf">direction</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">nearby_places</span>
      <span class="p">[</span><span class="n">ahead</span><span class="p">,</span> <span class="n">ahead_left</span><span class="p">,</span> <span class="n">ahead_right</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">neighbor</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
      <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">ant</span><span class="p">.</span><span class="nf">location</span>

      <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="no">DIR_DELTA</span><span class="p">[</span><span class="n">direction</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span>

      <span class="p">[(</span><span class="n">x</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span> <span class="o">%</span> <span class="n">world</span><span class="p">.</span><span class="nf">size</span><span class="p">,</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span> <span class="o">%</span> <span class="n">world</span><span class="p">.</span><span class="nf">size</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="kp">attr_accessor</span> <span class="ss">:world</span><span class="p">,</span> <span class="ss">:history</span>
    <span class="kp">attr_writer</span>   <span class="ss">:ant</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Of course, now that we have crossed the line from pure data models to an object
which actually does something, it is impossible to implement meaningful behavior
without making certain assumptions that will affect the capabilities of the 
rest of the system. The <code class="highlighter-rouge">Actor</code> class draws two significant lines in the sand that
are easy to overlook on a quick glance:</p>

<ol>
  <li>
    <p>Storing history data in a <code class="highlighter-rouge">Set</code> rather than an <code class="highlighter-rouge">Array</code> makes it so
that when this object updates pheromone trails, it only takes into account
what cells were visited, not how many times they were visited or in what order
they were traversed.</p>
  </li>
  <li>
    <p>The modular arithmetic performed in the <code class="highlighter-rouge">neighbor</code> function treats the world
as if it were a <a href="http://en.wikipedia.org/wiki/Torus">torus</a>, instead of a plane. This means that the
leftmost column and the rightmost column of the map are adjacent to one 
another, as are the top and bottom rows. This allows ants to easily wrap around
the edges of the map, but also establishes connections between cells that you
may not intuitively think of as being close to one another. Without a
three-dimensional visualization, it is hard to show that the top right corner of
the map and the bottom left corner are actually adjacent to one another.</p>
  </li>
</ol>

<p>Of course, the purpose of the <code class="highlighter-rouge">Actor</code> class is to hide these details from
the rest of the system. As long as its collaborators can operate within these 
constraints, the <code class="highlighter-rouge">Actor</code> object can be treated as a magic black box that knows
how to make ants move around the world and do interesting things. To see why
that is useful, check out the <code class="highlighter-rouge">Simulator#iterate</code> function which drives the
simulator’s main event loop:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">AntSim</span>
  <span class="k">class</span> <span class="nc">Simulator</span>
    <span class="c1"># ... other functions ...</span>

    <span class="k">def</span> <span class="nf">iterate</span>
      <span class="n">actors</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">actor</span><span class="o">|</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="no">Optimizer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">actor</span><span class="p">.</span><span class="nf">here</span><span class="p">,</span> <span class="n">actor</span><span class="p">.</span><span class="nf">nearby_places</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">actor</span><span class="p">.</span><span class="nf">foraging?</span>
          <span class="n">action</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">seek_food</span>
        <span class="k">else</span>
          <span class="n">action</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">.</span><span class="nf">seek_home</span>
        <span class="k">end</span>

        <span class="k">case</span> <span class="n">action</span>
        <span class="k">when</span> <span class="ss">:drop_food</span>
          <span class="n">actor</span><span class="p">.</span><span class="nf">drop_food</span><span class="p">.</span><span class="nf">mark_food_trail</span><span class="p">.</span><span class="nf">turn</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">when</span> <span class="ss">:take_food</span>
          <span class="n">actor</span><span class="p">.</span><span class="nf">take_food</span><span class="p">.</span><span class="nf">mark_home_trail</span><span class="p">.</span><span class="nf">turn</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">when</span> <span class="ss">:move_forward</span>
          <span class="n">actor</span><span class="p">.</span><span class="nf">move</span>
        <span class="k">when</span> <span class="ss">:turn_left</span>
          <span class="n">actor</span><span class="p">.</span><span class="nf">turn</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">when</span> <span class="ss">:turn_right</span>
          <span class="n">actor</span><span class="p">.</span><span class="nf">turn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="n">action</span><span class="p">.</span><span class="nf">inspect</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="nb">sleep</span> <span class="no">ANT_SLEEP</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Here we can see that the <code class="highlighter-rouge">Simulator</code> acts as a bridge that translates
the <code class="highlighter-rouge">Optimizer</code> object’s very abstract suggestions into concrete
actions for the <code class="highlighter-rouge">Actor</code> to carry out. The design of the <code class="highlighter-rouge">Actor</code> object gives the
<code class="highlighter-rouge">Simulator</code> just enough control to make some small adjustments to the process,
but not so much that it needs to be bogged down with the details.</p>

<h2 id="finding-food-and-bringing-it-home">Finding food and bringing it home</h2>

<p>Now that we know the state of the world and how it can be manipulated, it is
time to discuss how to produce the kind of behavior that you saw in the
video at the beginning of this article. Perhaps unsurprisingly, the life of the
everyday worker ant is actually fairly mundane.</p>

<p>Every ant in this simulation is always either searching for food to bring back
to the nest, or trying to return home with the food it found. As soon 
an ant accomplishes one of these tasks, it immediately transitions to the other,
not bothering to take even a moment to bask in fruits of its labor. The
following outline describes what the ants in this simulation are “thinking” 
at any given point in time, assuming that they haven’t managed to 
become self-aware…</p>

<p><strong>When searching for food:</strong></p>

<ol>
  <li>
    <p>If the current cell has food in it and it is NOT part of the nest, 
pick up some food.</p>
  </li>
  <li>
    <p>Otherwise, check the cell directly in front of me. If it has food in it, is
not part of the nest, and it is not occupied by another ant, move there.</p>
  </li>
  <li>
    <p>If not, rank the three adjacent cells in front of me based
on the amount of food they contain, and how intense their <code class="highlighter-rouge">food_pheremone</code>
levels are. I will <em>usually</em> choose to move or turn towards the cell with
highest ranking, but I will randomly deviate from this pattern on occasion
so that I can explore some uncharted territory.</p>
  </li>
</ol>

<p><strong>When searching for the nest:</strong></p>

<ol>
  <li>
    <p>If the current cell is part of the nest, drop the food I am carrying.</p>
  </li>
  <li>
    <p>Otherwise, check the cell directly in front of me. If it is part of the nest,
and it is not occupied by another ant, move there.</p>
  </li>
  <li>
    <p>If not, rank the three adjacent cells in front of me based
on whether or not they are part of the nest, and how intense their <code class="highlighter-rouge">home_pheremone</code>
levels are. I will <em>usually</em> choose to move or turn towards the cell with
highest ranking, but I will randomly deviate from this pattern on occasion
so that I can explore some uncharted territory.</p>
  </li>
</ol>

<p>Translating these ideas into code is very straightforward, especially
if you treat the underlying mathematical formulas as a black box:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">AntSim</span>
  <span class="k">class</span> <span class="nc">Optimizer</span>
    <span class="c1"># ...</span>

    <span class="k">def</span> <span class="nf">seek_food</span>
      <span class="k">if</span> <span class="n">here</span><span class="p">.</span><span class="nf">food</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span> <span class="n">here</span><span class="p">.</span><span class="nf">home</span><span class="p">)</span>
        <span class="ss">:take_food</span>
      <span class="k">elsif</span> <span class="n">ahead</span><span class="p">.</span><span class="nf">food</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span> <span class="n">ahead</span><span class="p">.</span><span class="nf">home</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span> <span class="n">ahead</span><span class="p">.</span><span class="nf">ant</span> <span class="p">)</span>
        <span class="ss">:move_forward</span>
      <span class="k">else</span>
        <span class="n">food_ranking</span> <span class="o">=</span> <span class="n">rank_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">cell</span><span class="o">|</span> <span class="n">cell</span><span class="p">.</span><span class="nf">food</span> <span class="p">}</span>
        <span class="n">pher_ranking</span> <span class="o">=</span> <span class="n">rank_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">cell</span><span class="o">|</span> <span class="n">cell</span><span class="p">.</span><span class="nf">food_pheremone</span> <span class="p">}</span>

        <span class="n">ranks</span> <span class="o">=</span> <span class="n">combined_ranks</span><span class="p">(</span><span class="n">food_ranking</span><span class="p">,</span> <span class="n">pher_ranking</span><span class="p">)</span>
        <span class="n">follow_trail</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">seek_home</span>
      <span class="k">if</span> <span class="n">here</span><span class="p">.</span><span class="nf">home</span>
        <span class="ss">:drop_food</span>
      <span class="k">elsif</span> <span class="n">ahead</span><span class="p">.</span><span class="nf">home</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span> <span class="n">ahead</span><span class="p">.</span><span class="nf">ant</span><span class="p">)</span>
        <span class="ss">:move_forward</span>
      <span class="k">else</span>
        <span class="n">home_ranking</span> <span class="o">=</span> <span class="n">rank_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">cell</span><span class="o">|</span> <span class="n">cell</span><span class="p">.</span><span class="nf">home</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
        <span class="n">pher_ranking</span> <span class="o">=</span> <span class="n">rank_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">cell</span><span class="o">|</span> <span class="n">cell</span><span class="p">.</span><span class="nf">home_pheremone</span> <span class="p">}</span>

        <span class="n">ranks</span> <span class="o">=</span> <span class="n">combined_ranks</span><span class="p">(</span><span class="n">home_ranking</span><span class="p">,</span> <span class="n">pher_ranking</span><span class="p">)</span>
        <span class="n">follow_trail</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">follow_trail</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>
      <span class="n">choice</span> <span class="o">=</span> <span class="n">wrand</span><span class="p">([</span> <span class="n">ahead</span><span class="p">.</span><span class="nf">ant</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">ranks</span><span class="p">[</span><span class="n">ahead</span><span class="p">],</span>
                       <span class="n">ranks</span><span class="p">[</span><span class="n">ahead_left</span><span class="p">],</span>
                       <span class="n">ranks</span><span class="p">[</span><span class="n">ahead_right</span><span class="p">]])</span>

      <span class="p">[</span><span class="ss">:move_forward</span><span class="p">,</span> <span class="ss">:turn_left</span><span class="p">,</span> <span class="ss">:turn_right</span><span class="p">][</span><span class="n">choice</span><span class="p">]</span>
    <span class="k">end</span>
    

    <span class="c1"># ...</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If you understand the general idea behind this algorithm, don’t worry about the
exact computations that the <code class="highlighter-rouge">Optimizer</code> uses unless you are
planning on researching Ant Colony Optimization in much greater detail. While I
understand what my own code is doing, I’ll admit that I mostly 
cargo-cult copied the probabilistic methods 
from <a href="https://gist.github.com/1093917">Rich Hickey’s simulator</a> while sprinkling in a few minor tweaks 
here and there. That said, if you want to see exactly how I hacked things
together, feel free to check out 
the <a href="https://github.com/elm-city-craftworks/practicing-ruby-examples/blob/master/v5/009/lib/ant_sim/optimizer.rb">full Optimizer class definition</a>.</p>

<p>What I personally find much more interesting than the nuts and bolt of
<em>how</em> this algorithm works is to think about <em>why</em> it works.</p>

<h2 id="how-the-hive-mind-emerges">How the hive mind emerges</h2>

<p>As we discussed in the previous section, ants are attracted to pheromone, and
that makes them more likely to follow the trails left behind by other ants than
they are to venture out on their own. However, when ants first start exploring
a new space, there are no trails to follow and so they are forced to wander
around randomly until a food source is found.</p>

<p>Generally speaking, ants that take a shorter path from the nest to a food
source will arrive there sooner than ants that take a longer path. If they
follow their own pheromone trail back to the nest, they will also return home
sooner than those who are traversing longer paths. By the time ants who have
taken a longer path return home, the ants on the shortest paths have already
went back out in search of additional food, which increases the pheromone levels
on their trails.</p>

<p>This process on its own would bias the ant colony to prefer shorter paths over
longer ones, but the optimization would be somewhat sluggish and might tend to
produce solutions that work well locally but aren’t nearly as attractive
globally. To get better results, the system needs a bit of entropy thrown into
the mix.</p>

<p>Because the behavior of ants has a certain amount of randomness to it,
the occasional deviation from established paths are fairly common. Even if the
fluctuations are small, each tiny shortcut that allows an ant to get between two
points along a path in a shorter amount of time ultimately contributes to
finding an optimal solution. This means that even an ant who goes wildly off
course and starves to death nowhere near the nest can make a meaningful
contribution to the colony if even some tiny segment of its path serves to
shorten an existing well-worn trail.</p>

<p>When you add in the fact that pheromones are volatile and tend to evaporate over
time, an upper limit emerges for how much a bad path or a local optimization can
influence the colony’s decision making. Evaporation is also a key part of what
allows the ants to change course when a food source is exhausted, or an obstacle
stands in the way of an established path.</p>

<p>Pheromone decay is something that can be modeled in many ways, but the easiest
way of simulating it is to gradually reduce the pheromone at every cell in the 
world on a regular interval. For an example of this approach, check out
<code class="highlighter-rouge">Simulator#evaporate</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">AntSim</span>
  <span class="k">class</span> <span class="nc">Simulator</span>
    <span class="k">def</span> <span class="nf">evaporate</span>
      <span class="n">world</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cell</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">|</span> 
        <span class="n">cell</span><span class="p">.</span><span class="nf">home_pheremone</span> <span class="o">*=</span> <span class="no">EVAP_RATE</span> 
        <span class="n">cell</span><span class="p">.</span><span class="nf">food_pheremone</span> <span class="o">*=</span> <span class="no">EVAP_RATE</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>So if you take the basic positive feedback loop caused by pheromone attraction
and mix in a bit of probabilistic exploration and the gradual evaporation of trails, you end
up with a fairly robust optimization process. It truly is remarkable that 
these basic factors can combine to create a very
effective search heuristic, especially when you consider the fact that what
we’ve discussed here is only a crude approximation of the tip of the iceberg
when it comes to <a href="http://en.wikipedia.org/wiki/Ant_colony_optimization">Ant Colony Optimization</a>.</p>

<h2 id="reflections">Reflections</h2>

<p>Emergent behaviors in computing problems have always fascinated me, even though I
have not spent nearly enough time studying them to understand them well. I feel
similarly about a lot of other things in life, ranging from the board game Go,
to the spread of memes throughout communities both online and offline.</p>

<p>There is something deep and almost spiritual in the realization that the
extremely complex behaviors can emerge from very simple systems with very few
rules, and a complete lack of central organization. It forces us to call into
question everything we experience and to wonder whether there is some elegant
explanation for it all!</p>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
