<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Making incremental improvements to legacy systems</title>
  <meta name="description" content="When you look at this photograph of highway construction, what do you see?If your answer was “ugly urban decay”, then you are absolutely right! But because t...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/improving-legacy-systems">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Making incremental improvements to legacy systems</h1>
    <p class="post-meta"><time datetime="2013-09-05T00:00:00-04:00" itemprop="datePublished">Sep 5, 2013</time> • Jordan Byron and Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>When you look at this photograph of highway construction, what do you see?</p>

<p><img src="http://i.imgur.com/eej11xZ.jpg" alt="" /></p>

<p>If your answer was “ugly urban decay”, then you are absolutely right! But because this construction project is only a few miles away from my house, I can tell you a few things about it that reveal a far more interesting story:</p>

<ul>
  <li>
    <p>On the far left side of the photo, you can see the first half of a newly constructed suspension bridge. At the time this picture was taken, it was serving five lanes of northbound traffic.</p>
  </li>
  <li>
    <p>Directly next to that bridge, cars are driving southbound on what was formerly the northbound side of our old bridge, serving 3 lanes of traffic.</p>
  </li>
  <li>
    <p>Dominating the rest of the photograph is the mostly deconstructed southbound side of our old bridge, a result of several months of active work.</p>
  </li>
</ul>

<p>So with those points in mind, what you are looking at here is an <em>incremental improvement</em> to a critical traffic bottleneck along the main route between New York City and Boston. This work was accomplished with hardly any service interruptions, despite the incredibly tight constraints on the project. This is legacy systems work at the highest level, and there is much we can learn from it that applies equally well to code as it does to concrete.</p>

<h2 id="case-study-improving-one-of-practicing-rubys-oldest-features">Case study: Improving one of Practicing Ruby’s oldest features</h2>

<p>Now that we’ve set the scene with a colorful metaphor, it is time to see how these ideas can influence the way we work on software projects. To do that, I will walk you through a major change we made to practicingruby.com that involved a fair amount of legacy coding headaches. You will definitely see some ugly code along the way, but hopefully a bit of cleverness will shine through as well.</p>

<p>The improvement that we will discuss is a complete overhaul of Practicing Ruby’s content sharing features. Although I’ve encouraged our readers to share our articles openly since our earliest days, several awkward implementation details made this a confusing process:</p>

<ul>
  <li>
    <p>You couldn’t just copy-paste links to articles. You needed to explictly click a share button that would generate a public share link for you.</p>
  </li>
  <li>
    <p>If you did copy-paste an internal link from the website rather than explicitly generating a share link, those who clicked on that link would be immediately asked for registration information without warning. This behavior was a side-effect of how we did authorization and not an intentional “feature”, but it was super annoying to folks who encountered it.</p>
  </li>
  <li>
    <p>If you visited a public share link while logged in, you’d see the guest view rather than the subscriber view, and you’d need to click a “log in” button to see the comments, navbar, etc.</p>
  </li>
  <li>
    <p>Both internal paths and share paths were completely opaque (e.g. “articles/101” and “/articles/shared/zmkztdzucsgv”), making it hard to know what a URL pointed to without
visiting it.</p>
  </li>
</ul>

<p>Despite these flaws, subscribers did use Practicing Ruby’s article sharing mechanism. They also made use of the feature in ways we didn’t anticipate – for example, it became the standard workaround for using Instapaper to read our content offline. As time went on, we used this feature for internal needs as well, whether it was to give away free samples, or to release old content to the public. To make a long story short, one of our most awkward features eventually also became one of the most important.</p>

<p>We avoided changing this system for quite a long while because we always had something else to work on that seemed more urgent. But after enough time had passed, we decided to pay down our debts. In particular, we wanted to make the following changes:</p>

<ul>
  <li>
    <p>We wanted to switch to subscriber-based share tokens rather than generating a new share token for each and every article. As long as a token was associated with an active subscriber, it could then be used to view any of our articles.</p>
  </li>
  <li>
    <p>We wanted to clean up and unify our URL scheme. Rather than having internal path like “/articles/101” and share path like “/articles/shared/zmkztdzucsgv”, we would have a single path for both purposes that looked like this:</p>
  </li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>/articles/improving-legacy-systems?u=dc2ab0f9bb
</code></pre>
</div>

<ul>
  <li>
    <p>We wanted to make sure to be smart about authorization. Guests who visited a link with a valid share key would always see the “guest view” of that article, and logged in subscribers would always see the “subscriber view”. If a key was invalid or missing, the guest would be explicitly told that the page was protected, rather than dropped into our registration process without warning.</p>
  </li>
  <li>
    <p>We wanted to make sure to make our links easy to share by copy-paste, whether it was from anywhere within our web interface, from the browser location bar, or even in the emails we send to subscribers. This meant making sure we put your share token pretty much anywhere you might click on an article link.</p>
  </li>
</ul>

<p>Laying out this set of requirements helped us figure out where the destination was, but we knew intuitively that the path to get there would be a long and winding road. The system we initially built for sharing articles did not take any of these concepts into account, and so we would need to find a way to shoehorn them in without breaking old behavior in any significant way. We also would need to find a way to do this <em>incrementally</em>, to avoid releasing a ton of changes to our system at once that could be difficult to debug and maintain. The rest of this article describes how we went on to do exactly that, one pull request at a time.</p>

<blockquote>
  <p><strong>NOTE:</strong> Throughout this article, I link to the “files changed” view of pull requests to give you a complete picture of what changed in the code, but understanding every last detail is not important. It’s fine to dig deep into some pull requests while skimming or skipping others.</p>
</blockquote>

<h2 id="step-1-deal-with-authorization-failures-gracefully">Step 1: Deal with authorization failures gracefully</h2>

<p>When we first started working on practicingruby.com, we thought it would be convenient to automatically handle Github authentication behind the scenes so that subscribers rarely needed to explicitly click a “sign in” button in order to read articles. This is a good design idea, but we only really considered the happy path while building and testing it.</p>

<p>Many months down the line, we realized that people would occasionally share internal links to our articles by accident, rather than explicitly generating public links. Whenever that happened, the visitor would be put through our entire registration process without warning, including:</p>

<ul>
  <li>Approving our use of Github to authorize their account</li>
  <li>Going through an email confirmation process</li>
  <li>Getting prompted for credit card information</li>
</ul>

<p>Most would understandably abandon this process part of the way through. In the best case scenario, our application’s behavior would be seen as very confusing, though I’m sure for many it felt downright rude and unpleasant. It’s a shame that such a bad experience could emerge from what was actually good intentions both on our part and on whoever shared a link to our content in the first place. Think of what a different experience it might have been if the visitor had been redirected to our landing page where they could see the following message:</p>

<p><img src="http://i.imgur.com/kA3ePJI.png" alt="" /></p>

<p>Although that wouldn’t be quite as nice as getting free access to an article that someone wanted to share with them, it would at least avoid any confusion about what had just happened. My first attempt at introducing this kind of behavior into the system looked like what you see below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ...</span>
  
  <span class="k">def</span> <span class="nf">authenticate</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">current_authorization</span> 
   
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> 
      <span class="s2">"That page is protected. Please sign in or sign up to continue"</span>
      
    <span class="n">store_location</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span> 
</code></pre>
</div>

<p>We deployed this code and for a few days, it seemed to be a good enough stop-gap measure for resolving this bug, even if it meant that subscribers might need to click a “sign in” button a little more often. However, I realized that it was a bit too naive of a solution when I received an email asking why it was necessary to click “sign in” in order to make the “subscribe” button work. My quick fix had broken our registration system. :cry:</p>

<p>Upon hearing that bad news, I immediately pulled this code out of production after writing a test that proved this problem existed on my feature branch but not in master. A few days later, I put together a quick fix that got my tests passing. My solution was to extract a helper method that decided how to handle authorization failures. The default behavior would be to redirect to the root page and display an error message as we did above, but during registrations, we would automatically initiate a Github authentication as we had done in the past:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ...</span>
  
  <span class="k">def</span> <span class="nf">authenticate</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">current_authorization</span> 
   
    <span class="n">store_location</span>
    <span class="n">redirect_on_auth_failure</span>
  <span class="k">end</span>
  
  <span class="k">def</span> <span class="nf">redirect_on_auth_failure</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> 
      <span class="s2">"That page is protected. Please sign in or sign up to continue"</span>
      
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
 <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">RegistrationController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
  
  <span class="k">def</span> <span class="nf">redirect_on_auth_failure</span>
    <span class="n">redirect_to</span> <span class="n">login_path</span> 
  <span class="k">end</span>
<span class="k">end</span> 
</code></pre>
</div>

<p>This code, though not especially well designed, seemed to get the job done without too much trouble. It also served as a useful reminder that I should be on the lookout for holes in the test suite, which in retrospect should have been obvious given the awkward behavior of the original code. As they say, hindsight is 20/20!</p>

<blockquote>
  <p>HISTORY: Deployed 2013-07-26 and then reverted a few days later due to the registration bug mentioned above. Redeployed on 2013-08-06, then merged three days later.</p>

  <p><a href="https://github.com/elm-city-craftworks/practicing-ruby-web/pull/145/files">View complete diff</a></p>
</blockquote>

<h2 id="step-2-add-article-slugs">Step 2: Add article slugs</h2>

<p>When we first started working on practicingruby.com, we didn’t put much thought to what our URLs looked like. In the first few weeks, we were rushing to get features like syntax highlighting and commenting out the door while keeping up with the publication schedule, and so we didn’t have much energy to think about the minor details.</p>

<p>Even if it made sense at the time, this is one decision I came to regret. In particular, I  disliked the notion that the paths that subscribers saw (e.g. “/articles/101”) were completely different than the ones we generated for public viewing (e.g. “/articles/shared/zmkztdzucsgv”), with no direct way to associate the two. When you add in the fact that both of these URL schemes are opaque, it definitely stood out as a poor design decision on our part.</p>

<p>Technically speaking, it would be possible to unify the two different schemes using subscriber tokens without worrying about the descriptiveness of the URLs, perhaps using paths like “/articles/101?u=dc20f9bb”. However, since we would need to be messing around with article path generation as it was, it seemed like a good idea to make those paths much more attractive by adding slugs. The goal was to have a path like: “/articles/improving-legacy-systems?u=dc2ab0f9bb”.</p>

<p>Because we knew article slugs would be easy to implement, we decided to build and ship them before moving on to the more complicated changes we had planned to make. The pair of methods below are the most interesting implementation details from this changeset:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ...</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">[]</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">find_by_slug</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">||</span> <span class="n">find_by_id</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_param</span>
    <span class="k">if</span> <span class="n">slug</span><span class="p">.</span><span class="nf">present?</span>
      <span class="n">slug</span>
    <span class="k">else</span>
      <span class="nb">id</span><span class="p">.</span><span class="nf">to_s</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">Article[]</code> method is a drop-in replacement for <code class="highlighter-rouge">Article.find</code> that allows lookup by slug or by id. This means that both <code class="highlighter-rouge">Article[101]</code> and <code class="highlighter-rouge">Article['improving-legacy-code']</code> are valid calls, each of them returning an <code class="highlighter-rouge">Article</code> object. Because we only call <code class="highlighter-rouge">Article.find()</code> in a few places in our codebase, it was easy to swap those calls out to use <code class="highlighter-rouge">Article[]</code> instead.</p>

<p>The <code class="highlighter-rouge">Article#to_params</code> method is used internally by Rails to generate paths. So wherever <code class="highlighter-rouge">article_url</code> or <code class="highlighter-rouge">article_path</code> get called with an <code class="highlighter-rouge">Article</code> object, this method will be called to determine what gets returned. If the article has a slug associated, it’ll return something like “/articles/improving-legacy-code”. If it doesn’t have a slug set yet, it will return the familiar opaque database ids, i.e. “/articles/101”.</p>

<p>There is a bit of an inconsistency in this design worth noting: I chose to override the <code class="highlighter-rouge">to_params</code> method, but not the <code class="highlighter-rouge">find</code> method on my model. However, since the former is a method that is designed to be overridden and the latter might be surprising to override, I felt somewhat comfortable with this design decision.</p>

<p>Although it’s not worth showing the code for it, I also added a redirect to the new style URLs whenever a slug existed for an article. By doing this, I was able to effectively deprecate the old URL style without breaking existing links. While we won’t ever disable lookup by database ID, this at least preserves some consistency at the surface level of the application.</p>

<blockquote>
  <p>HISTORY: Deployed 2013-08-16 and then merged the next day. Adding slugs to articles was a manual process that I completed a few days after the feature shipped.</p>

  <p><a href="https://github.com/elm-city-craftworks/practicing-ruby-web/pull/155/files">View complete diff</a></p>
</blockquote>

<h2 id="step-3-add-subscriber-share-tokens">Step 3: Add subscriber share tokens</h2>

<p>In theory it should have been nearly trivial to implement subscriber-based share tokens. After all, we were simply generating a random string for each subscriber and then appending it to the end of article URLs as a GET parameter (e.g. “u=dc20f9bb”). In practice, there were many edge cases that would complicate our implementation.</p>

<p>The ideal situation would be to override the <code class="highlighter-rouge">article_path</code> and <code class="highlighter-rouge">article_url</code> methods to add the currently logged in user’s share token to any article links throughout the application. However, we weren’t able to find a single place within the Rails call chain where such a global override would make sense. It would easy enough to get this kind of behavior in both our views and controllers by putting the methods in a helper and then mixing that helper into our ApplicationController, but it wasn’t easy to take the same approach in our tests and mailers. To make matters worse, some of the places we wanted to use these path helpers would have access to the ones rails provided by default, but would not include our overrides, and so we’d silently lose the behavior we wanted to add.</p>

<p>We were unable to find an elegant solution to this problem, but eventually settled on a compromise. We built a low level object for generating the URLs with subscriber tokens, as shown below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArticleLink</span>
  <span class="kp">include</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">url_helpers</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">article</span> <span class="o">=</span> <span class="n">article</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">params</span> <span class="o">=</span> <span class="n">params</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">article_path</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">params_with_token</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">params_with_token</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="kp">attr_accessor</span> <span class="ss">:params</span><span class="p">,</span> <span class="ss">:article</span>

  <span class="k">def</span> <span class="nf">params_with_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:u</span> <span class="o">=&gt;</span> <span class="n">token</span><span class="p">}.</span><span class="nf">merge</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Then in our <code class="highlighter-rouge">ApplicationHelper</code>, we added the following bits of glue code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">ApplicationHelper</span>
  <span class="k">def</span> <span class="nf">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">return</span> <span class="k">super</span> <span class="k">unless</span> <span class="n">current_user</span>

    <span class="no">ArticleLink</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">params</span><span class="p">).</span><span class="nf">url</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">share_token</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">article_path</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">return</span> <span class="k">super</span> <span class="k">unless</span> <span class="n">current_user</span>

    <span class="no">ArticleLink</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">article</span><span class="p">,</span> <span class="n">params</span><span class="p">).</span><span class="nf">path</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">share_token</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Adding these simple shims made it so that we got the behavior we wanted in the ordinary use cases of <code class="highlighter-rouge">article_url</code> and <code class="highlighter-rouge">article_path</code>, which were in our controllers and views. In our mailers and tests, we opted to use the <code class="highlighter-rouge">ArticleLink</code> object directly, because we needed to explicitly pass in tokens in those areas anyway. Because it was impossible for us to make this code completely DRY, this convention-based design was the best we could come up with.</p>

<p>As part of this changeset, I modified the redirection code that I wrote when we were introducing slugs to also take tokens into account. If a subscriber visited a link that didn’t include a share token, it would rewrite the URL to include their token. This was yet another attempt at introducing a bit of consistency where there previously was none.</p>

<blockquote>
  <p>HISTORY: Deployed code to add tokens upon visiting an article on 2013-08-20, then did a second deploy to update the archives and library links the next day, merged on 2013-08-23.</p>

  <p><a href="https://github.com/elm-city-craftworks/practicing-ruby-web/pull/158/files">View complete diff</a></p>
</blockquote>

<h2 id="step-4-redesign-and-improve-broadcast-mailer">Step 4: Redesign and improve broadcast mailer</h2>

<p>I use a very basic web form in our admin panel to send email announcements out to Practicing Ruby subscribers. Originally, this feature relied on sending messages in batches, which was the simple thing to do when we assumed we’d be sending an identical message to everyone:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BroadcastMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">deliver_broadcast</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="p">{})</span>
    <span class="vi">@body</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="ss">:body</span><span class="p">]</span>

    <span class="n">user_batches</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">users</span><span class="o">|</span>
      <span class="n">mail</span><span class="p">(</span>
        <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s2">"gregory@practicingruby.com"</span><span class="p">,</span>
        <span class="ss">:bcc</span> <span class="o">=&gt;</span> <span class="n">users</span><span class="p">,</span>
        <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">message</span><span class="p">[</span><span class="ss">:subject</span><span class="p">]</span>
      <span class="p">).</span><span class="nf">deliver</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">user_batches</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">yield</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="ss">:to</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">return</span> <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="ss">:commit</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Test"</span>

    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:notify_updates</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">to_notify</span><span class="p">.</span>
      <span class="nf">find_in_batches</span><span class="p">(</span><span class="ss">:batch_size</span> <span class="o">=&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">group</span><span class="o">|</span>
        <span class="k">yield</span> <span class="n">group</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:contact_email</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Despite being a bit of a hack, this code served us well enough for a fairly long time. It even supported a basic “test mode” that allowed me to send a broadcast email to myself before sending it out everyone. However, the design would need to change greatly if we wanted to include share tokens in the article links we emailed to subscribers. We’d need to send out individual emails rather than sending batched messages, and we’d also need to implement some sort of basic mail merge functionality to handle article link generation.</p>

<p>I don’t want to get too bogged down in details here, but this changeset turned out to be far more complicated than I expected. For starters, the way we were using <code class="highlighter-rouge">ActionMailer</code> in our original code was incorrect, and we were relying on undefined behavior without realizing it. Because the <code class="highlighter-rouge">BroadcastMailer</code> had been working fine for us in production and its (admittedly mediocre) tests were passing, we didn’t notice the problem until we attempted to change its behavior. After attempting to introduce code that looked like this, I started to get all sorts of confusing test failures:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BroadcastMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># NOTE: this is an approximation, but it captures the basic idea...</span>
  <span class="k">def</span> <span class="nf">deliver_broadcast</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="p">{})</span>
    <span class="vi">@body</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="ss">:body</span><span class="p">]</span>

    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:notify_updates</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">to_notify</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="n">mail</span><span class="p">(</span><span class="ss">:to</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="p">.</span><span class="nf">contact_email</span><span class="p">,</span> <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">message</span><span class="p">[</span><span class="ss">:subject</span><span class="p">]).</span><span class="nf">deliver</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Even though this code appeared to work as expected in development (sending individual emails to each recipient), in my tests, <code class="highlighter-rouge">ActionMailer::Base.deliveries</code> was returning N copies of the first email sent in this loop. After some more playing around with ActionMailer and semi-fruitless internet searches, I concluded that this was because we weren’t using the mailers in the officially sanctioned way. We’d need to change our code so that the mailer returned a <code class="highlighter-rouge">Mail</code> object, rather than handling the delivery for us.</p>

<p>Because I didn’t want that logic to trickle up into the controller, and because I expected things might get more complicated as we kept adding more features to this object, I decided to introduce an intermediate service object to handle some of the work for us, and then greatly simplify the mailer object. I also wanted to make the distinction between sending a test message and sending a message to everyone more explicit, so I took the opportunity to do that as well. The resulting code ended up looking something similar to what you see below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Broadcaster</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">notify_subscribers</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="no">BroadcastMailer</span><span class="p">.</span><span class="nf">recipients</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">email</span><span class="o">|</span>
      <span class="no">BroadcastMailer</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">email</span><span class="p">).</span><span class="nf">deliver</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">notify_testers</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="no">BroadcastMailer</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:to</span><span class="p">]).</span><span class="nf">deliver</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">BroadcastMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">recipients</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:notify_updates</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">to_notify</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:contact_email</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">:to</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">,</span>
         <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">message</span><span class="p">[</span><span class="ss">:subject</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>With this code in place, I had successfully converted the batch email delivery to individual emails. It was time to move on to adding a bit of code that would give me mail-merge functionality. I decided to use Mustache for this purpose, which would allow me to write emails that look like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Here is an awesome article I wrote:

improving-legacy-systems
</code></pre>
</div>

<p>Mustache would then run some code behind the scenes and turn that message body into the following output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Here is an awesome article I wrote:

http://practicingruby.com/articles/improving-legacy-systems?u=dc20f9bb
</code></pre>
</div>

<p>As a proof of concept, I wrote a bit of code that handled the article link expansion, but didn’t handle share tokens yet. It only took two extra lines in <code class="highlighter-rouge">BroadcastMailer#broadcast</code> to add this support:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BroadcastMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ...</span>
  
  <span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
    <span class="n">article_finder</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="n">article_url</span><span class="p">(</span><span class="no">Article</span><span class="p">[</span><span class="n">e</span><span class="p">])</span> <span class="p">}</span>

    <span class="vi">@body</span> <span class="o">=</span> <span class="no">Mustache</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="ss">:body</span><span class="p">],</span> <span class="ss">:article</span> <span class="o">=&gt;</span> <span class="n">article_finder</span><span class="p">)</span>

    <span class="n">mail</span><span class="p">(</span><span class="ss">:to</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">,</span>
         <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">message</span><span class="p">[</span><span class="ss">:subject</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>I deployed this code in production and sent myself a couple test emails, verifying that the article links were getting expanded as I expected them to. I had planned to work on adding the user tokens immediately after running those live tests, but at that moment realized that I had overlooked an important issue related to performance.</p>

<p>Previous to this changeset, the <code class="highlighter-rouge">BroadcastMailer</code> was responsible for sending about 16 emails at a time (25 people per email). But now, it would be sending about 400 of them! Even though we use a DelayedJob worker to handle the actual delivery of the messages, it might take some significant amount of time to insert 400 custom-generated emails into the queue. Rather than investigating that problem right away, I decided to get myself some rest and tackle it the next day with Jordan.</p>

<blockquote>
  <p>HISTORY: Deployed on 2013-08-22, and then merged the next day.</p>

  <p><a href="https://github.com/elm-city-craftworks/practicing-ruby-web/pull/162/files">View complete diff</a></p>
</blockquote>

<h2 id="step-5-test-broadcast-mailers-performance">Step 5: Test broadcast mailer’s performance</h2>

<p>Before we could go any farther with our work on the broadcast mailer, we needed to check the performance implications of switching to non-batched emails. We didn’t need to do a very scientific test – we just needed to see how severe the slowdown was. Because our previous code ran without a noticeable delay, pretty much anything longer than a second or two would be concerning to us.</p>

<p>To conduct our test, we first populated our development environment with 2000 users (about 5x as many active users as we had on Practicing Ruby at the time). Then, we posted a realistic email in the broadcast mailer form, and kept an eye on the messages that were getting queued up via the Rails console. After several seconds we hadn’t even queued up 100 jobs, so it became clear that performance very well could be a concern.</p>

<p>To double check our estimates, and to form a more realistic test, we temporarily disabled our DelayedJob worker on the server and then ran the broadcast mailer in our live environment. Although the mailer did finish up queuing its messages without the request timing out, it took about half a minute to do so. With this information in hand, we cleared out the test jobs so that they wouldn’t actually be delivered, and then spent a bit of time lost in thought.</p>

<p>Ultimately, we learned several important things from this little experiment:</p>

<ol>
  <li>The mail building and queuing process was definitely slow enough to worry us.</li>
  <li>In the worst case scenario, I would be able to deal with a 30 second delay in delivering broadcasts, but we would need to fix this problem if we wanted to unbatch other emails of ours, such as comment notifications.</li>
  <li>The most straightforward way to deal with this problem would be to run the entire mail building and queuing process in the background.</li>
</ol>

<p>The first two points were not especially surprising to us, but the third concerned us a bit. While we have had good luck using DelayedJob in conjunction with the MailHopper gem to send email, we had some problems in the past with trying to handle arbitrary jobs with it. We suspected this had to do with some of our dependencies being outdated, but never had time to investigate properly. With our fingers crossed, we decided to hope for the best and plan for the worst.</p>

<h2 id="step-6-process-broadcast-mails-using-delayedjob">Step 6: Process broadcast mails using DelayedJob</h2>

<p>Our first stab at backgrounding the work done by
<code class="highlighter-rouge">Broadcaster.notify_subscribers</code>  was to simply change the call to
<code class="highlighter-rouge">Broadcaster.delay.notify_subscribers</code>.</p>

<p>In theory, this small change should have done the
trick: the method is conceptually nothing more than a “fire and forget”
function that did not need to interact in any way with its caller. But after
spending a long time staring at an incredibly confusing error log, we
realized that it wasn’t safe to assume that DelayedJob would cleanly serialize
a Rails <code class="highlighter-rouge">params</code> hash. Constructing our own hash to pass into the
<code class="highlighter-rouge">Broadcaster.notify_subscribers</code> method resolved those issues, and we ended up
with the following code in <code class="highlighter-rouge">BroadcastsController</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Admin</span>
  <span class="k">class</span> <span class="nc">BroadcastsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">create</span>
      <span class="c1"># ...</span>

      <span class="c1"># build our own hash to avoid DelayedJob serialization issues</span>
      <span class="n">message</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="p">[</span><span class="ss">:subject</span><span class="p">],</span>
                  <span class="ss">:body</span>    <span class="o">=&gt;</span> <span class="n">params</span><span class="p">[</span><span class="ss">:body</span><span class="p">]</span> <span class="p">}</span> 

      <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="ss">:commit</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Test"</span>
        <span class="n">message</span><span class="p">[</span><span class="ss">:to</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:to</span><span class="p">]</span>

        <span class="no">Broadcaster</span><span class="p">.</span><span class="nf">notify_testers</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="no">Broadcaster</span><span class="p">.</span><span class="nf">delay</span><span class="p">.</span><span class="nf">notify_subscribers</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="c1"># ...</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>After tweaking our test suite slightly to take this change into account, we
were back to green fairly quickly. We experimented with the delayed broadcasts
locally and found that it resolved our slowness issue in the UI. The worker
would still take a little while to build all those mails and get them queued
up, but since it was being done in the background it no longer was much of a
concern to us.</p>

<p>We were cautiously optimistic that this small change might fix our issues, so
we deployed the code to production and did another live test. Unfortunately,
this lead us to a new error condition, and so we had to go back to the drawing board. 
Eventually we came across <a href="https://github.com/collectiveidea/delayed_job/issues/350">this Github issue</a>, which hinted (indirectly) that we might be running into one of the many issues with YAML parsing on Ruby 1.9.2.</p>

<p>We could have attempted to do yet another workaround to avoid updating our
Ruby version, but we knew that this was not the first, second, or even third time that we had been bitten by the fact that we were still running an ancient
and poorly supported version of Ruby. In fact, we realized that wiping the
slate clean and provisioning a whole new VPS might be the way to go, because
that way we could upgrade all of our platform dependencies at once.</p>

<p>So with that in mind, Jordan went off to work on getting us a new production
environment set up, and we temporarily put this particular changeset on hold.
There was still plenty of work for me to do that didn’t rely on upgrading our
production environment, so I kept working against our old server while he tried to spin up a new one.</p>

<blockquote>
  <p>HISTORY: Deployed for live testing on 2013-08-23 but then immediately pulled
from production upon failure. Redeployed to our new server on 2013-08-30,
then merged the following day.</p>

  <p><a href="https://github.com/elm-city-craftworks/practicing-ruby-web/pull/164">View complete diff</a></p>
</blockquote>

<h2 id="step-7-support-share-tokens-in-broadcast-mailer">Step 7: Support share tokens in broadcast mailer</h2>

<p>Now that we had investigated the performance issues with the mailer and had a plan in place to fix them, it was time for me to finish what I had planned to work on in the first place: adding share tokens to article links in emails.</p>

<p>The changes to <code class="highlighter-rouge">BroadcastMailer</code> were fairly straightforward: pass a <code class="highlighter-rouge">User</code> rather than an email address into the <code class="highlighter-rouge">broadcast</code> method, and then use <code class="highlighter-rouge">ArticleLink</code> to generate a customized link based on the subscriber’s share token:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BroadcastMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">recipients</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">:notify_updates</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">).</span><span class="nf">to_notify</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">broadcast</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">subscriber</span><span class="p">)</span>
    <span class="n">article_finder</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span> 
      <span class="no">ArticleLink</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Article</span><span class="p">[</span><span class="n">e</span><span class="p">]).</span><span class="nf">url</span><span class="p">(</span><span class="n">subscriber</span><span class="p">.</span><span class="nf">share_token</span><span class="p">)</span> 
    <span class="p">}</span>

    <span class="vi">@body</span> <span class="o">=</span> <span class="no">Mustache</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="ss">:body</span><span class="p">],</span> <span class="ss">:article</span> <span class="o">=&gt;</span> <span class="n">article_finder</span><span class="p">)</span>

    <span class="n">mail</span><span class="p">(</span><span class="ss">:to</span> <span class="o">=&gt;</span> <span class="n">subscriber</span><span class="p">.</span><span class="nf">contact_email</span><span class="p">,</span>
         <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">message</span><span class="p">[</span><span class="ss">:subject</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The only complication of rewiring <code class="highlighter-rouge">BroadcastMailer</code> this way is that it broke our test mailer functionality. Because the test mailer could send a message to any email address (whether there was an account associated with it or not), we wouldn’t be able to look up a valid <code class="highlighter-rouge">User</code> record to pass to the <code class="highlighter-rouge">BroadcastMailer</code>. The code below shows my temporary solution to this API compatibility problem:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Broadcaster</span>
   <span class="c1"># ...</span>
   
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">notify_testers</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">subscriber</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:contact_email</span><span class="p">,</span> <span class="ss">:share_token</span><span class="p">)</span>
                       <span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:to</span><span class="p">],</span> <span class="s2">"testtoken"</span><span class="p">)</span>

    <span class="no">BroadcastMailer</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">subscriber</span><span class="p">).</span><span class="nf">deliver</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Using a <code class="highlighter-rouge">Struct</code> object to generate an interface shim as I’ve done here is not the most elegant solution, but it gets the job done. A better solution would be to create a container object that could be used by both <code class="highlighter-rouge">notify_subscribers</code> and <code class="highlighter-rouge">notify_testers</code>, but I wasn’t ready to make that design decision yet.</p>

<p>With these changes in place, I was able to do some live testing to verify that we had managed to get share tokens into our article links. Now all that remained was to add the logic that would allow these share tokens to permit guest access to articles.</p>

<blockquote>
  <p>HISTORY: Deployed 2013-08-24, then merged on 2013-08-29.</p>

  <p><a href="https://github.com/elm-city-craftworks/practicing-ruby-web/pull/165">View complete diff</a></p>
</blockquote>

<h2 id="step-8-allow-guest-access-to-articles-via-share-tokens">Step 8: Allow guest access to articles via share tokens</h2>

<p>With all the necessary underplumbing in place, I was finally ready to model the new sharing mechanism. The end goal was to support the following behavior:</p>

<ul>
  <li>Subscribers see the full article w. comments whenever they are logged in</li>
  <li>With a valid token in the URL, guests see our “shared article” view.</li>
  <li>Without a valid token, guests see the “protected page” error</li>
  <li>Links that use a token from an expired account are disabled</li>
  <li>Old-style share links redirect to the new-style subscriber token links</li>
</ul>

<p>The main challenge was that there wasn’t an easy way to separate these concepts from each other, at least not in a meaningful way. However, we were able to reuse large chunks of existing code to do this, so most of the work was just tedious rewiring of controller actions while layering in a few more tests here and there.</p>

<p>The changes that needed to be made to support these behaviors were not that hard to make, but I did feel concerned about how complicated our <code class="highlighter-rouge">ArticlesController#show</code> action was getting. Including the relevant filters, here is what it looked like after all the changes were made (skim it, but don’t bother trying to understand it!):</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:find_article</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:share</span><span class="p">]</span>
  <span class="n">before_filter</span> <span class="ss">:update_url</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:show</span><span class="p">]</span>
  <span class="n">before_filter</span> <span class="ss">:validate_token</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:show</span><span class="p">]</span>

  <span class="n">skip_before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:shared</span><span class="p">,</span> <span class="ss">:samples</span><span class="p">]</span>
  <span class="n">skip_before_filter</span> <span class="ss">:authenticate_user</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:shared</span><span class="p">,</span> <span class="ss">:samples</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="n">store_location</span>
    <span class="n">decorate_article</span>

    <span class="k">if</span> <span class="n">current_user</span>
      <span class="n">mixpanel</span><span class="p">.</span><span class="nf">track</span><span class="p">(</span><span class="s2">"Article Visit"</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">subject</span><span class="p">,</span>
                                      <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">hashed_id</span><span class="p">)</span>

      <span class="vi">@comments</span> <span class="o">=</span> <span class="no">CommentDecorator</span><span class="p">.</span><span class="nf">decorate</span><span class="p">(</span><span class="vi">@article</span><span class="p">.</span><span class="nf">comments</span>
                                                    <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s2">"created_at"</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="n">shared_by</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by_share_token</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:u</span><span class="p">]).</span><span class="nf">hashed_id</span>

      <span class="n">mixpanel</span><span class="p">.</span><span class="nf">track</span><span class="p">(</span><span class="s2">"Shared Article Visit"</span><span class="p">,</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">subject</span><span class="p">,</span>
                                            <span class="ss">:shared_by</span> <span class="o">=&gt;</span> <span class="n">shared_by</span><span class="p">)</span>

      <span class="n">render</span> <span class="s2">"shared"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">find_article</span>
    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]]</span>

    <span class="n">render_http_error</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span> <span class="k">unless</span> <span class="vi">@article</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update_url</span>
    <span class="n">slug_needs_updating</span> <span class="o">=</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">slug</span><span class="p">.</span><span class="nf">present?</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="o">!=</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">slug</span>
    <span class="n">missing_token</span> <span class="o">=</span> <span class="n">current_user</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="p">[</span><span class="ss">:u</span><span class="p">].</span><span class="nf">blank?</span>

    <span class="n">redirect_to</span><span class="p">(</span><span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">))</span> <span class="k">if</span> <span class="n">slug_needs_updating</span> <span class="o">||</span> <span class="n">missing_token</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">validate_token</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">try</span><span class="p">(</span><span class="ss">:active?</span><span class="p">)</span>

    <span class="k">unless</span> <span class="n">params</span><span class="p">[</span><span class="ss">:u</span><span class="p">].</span><span class="nf">present?</span> <span class="o">&amp;&amp;</span> 
           <span class="no">User</span><span class="p">.</span><span class="nf">find_by_share_token_and_status</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:u</span><span class="p">],</span> <span class="s2">"active"</span><span class="p">)</span>
      <span class="n">attempt_user_login</span> <span class="c1"># helper that calls authenticate + authenticate_user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This is clearly not a portrait of healthy code! In fact, it looks suspiciously similiar to the code samples that “lost the plot” in Avdi Grimm’s contributed article on <a href="https://practicingruby.com/articles/confident-ruby">confident coding</a>. That said, it’s probably more fair to say that there wasn’t much of a well defined plot when this code was written in the first place, and my attempts to modify it only muddied things further.</p>

<p>It was hard for me to determine whether or not I should attempt to refactor this code right away or wait until later. From a purely technical perspective, the answer was obvious that this code needed to be cleaned up. But looking at it from another angle, I wanted to make sure that the external behavior of the system was what I actually wanted before I invested more time into optimizing its implementation. I didn’t have insight at this point in time to answer that question, so I decided to leave the code messy for the time being until I had a chance to see how well the new sharing mechanism performed in production.</p>

<blockquote>
  <p>HISTORY: Deployed on 2013-08-26 and then merged on 2013-08-29.</p>

  <p><a href="https://github.com/elm-city-craftworks/practicing-ruby-web/pull/173">View complete diff</a></p>
</blockquote>

<h2 id="step-9-get-practicingrubycom-running-on-our-new-vps">Step 9: Get practicingruby.com running on our new VPS</h2>

<p>While I kept working on the sharing mechanism, Jordan was busy setting up a new production environment for us. We set up a temporary subdomain new.practicingruby.com for this purpose, and that allowed us to do some live testing while he got everything up and running.</p>

<p>Technically speaking, we only need to upgrade our Ruby version in order to fix the problems we encountered with DelayedJob, so spinning up a new VPS instance purely for that purpose might sound a bit overkill at first glance. However, starting with a blank slate environment allowed us to upgrade the rest of our serverside dependencies at a relaxed pace, without worrying about potentially causing large amounts of site downtime. Spinning up the new environment in parallel before decommissioning the old one also meant that we could always switch back to our old environment if we encountered any problems during the migration to the new server.</p>

<p>On 2013-08-30, we decided to migrate to the new environment. The first step was to pull in the delayed broadcast mailer code and do live tests similar to the ones we had done earlier. After we found that those went smoothly, we decided to do a complete end-to-end test by using the new system to deliver an announcement about the planned maintenance downtime. That worked without any issues, and so at that time we were ready to perform the cut over.</p>

<p>We made sure to copy over all the data from our old environment immediately after putting it into maintenance mode, and then we updated our DNS entries to point practicingruby.com at the new server. After the DNS records propagated, we used a combination of watching our logs and our analytics dashboard (Mixpanel) to see how things were going. There were only two minor hiccups before everything got back to normal:</p>

<ul>
  <li>
    <p>We had a small issue with our Oauth configuration on Github, but resolving it was trivial after we realized that it was not in fact a DNS-related problem, but an issue on our end.</p>
  </li>
  <li>
    <p>We realized as soon as we spun up our cron jobs on the new server that our integration with Mailchimp’s API had broken. The gem we were using was not Ruby 2.0 compatible, but we never realized this in development because we use it only in a tiny cleanup script that runs behind the scenes on the server. Thankfully because we had isolated this dependency from our application code, <a href="https://github.com/elm-city-craftworks/practicing-ruby-web/pull/177/files">changing it was very easy</a>.</p>
  </li>
</ul>

<p>These two issues were the only problems we needed to debug under pressure throughout all the work we described in this article. Given how much we changed under the hood, I am quite proud of that fact.</p>

<h2 id="reflections">Reflections</h2>

<p>The state of practicingruby.com immediately after our server migration was roughly comparable to that of the highway construction photograph that you saw at the beginning of this article: some improvements had been made, but there was still plenty of old cruft left around, and lots of work left to be done before things could be considered finished. My goal in writing this article was not to show a beautiful end result, but instead to illustrate a process that is seldom discussed.</p>

<p>In the name of preserving realism, I dragged you through some of our oldest and worst code, and also showed you some newer code that isn’t much nicer looking than our old stuff. Along the way, we used countless techniques that feel more like plumbing work than interesting programming work. Each step along the way, we used a different technique to glue one bit of code to another bit of code without breaking old behaviors, because there was no good one-size fits all solution to turn to. We got the job done, but we definitely got our hands dirty in the process.</p>

<p>I feel fairly confident that some of the changes I showed in this article are ones that I will be thankful for in the long haul, while others I will come to regret. The trouble of course is knowing which will be which, and only time and experience can get me there. But hopefully by sharing my own experiences with you, you can learn something from my mistakes, too!</p>

<blockquote>
  <p>Special thanks goes to Jordan Byron (the maintainer of practicingruby.com) for collaborating with me on this article, and for helping Practicing Ruby run smoothly over the years.</p>
</blockquote>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
