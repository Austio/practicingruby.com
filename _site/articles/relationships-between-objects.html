<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Understanding the relationships between objects</title>
  <meta name="description" content="  CREDIT: Although this article is my own work, it is based on ideas I got froma very different but interesting early draft from Practicing Ruby readerMike S...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/relationships-between-objects">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Understanding the relationships between objects</h1>
    <p class="post-meta"><time datetime="2012-10-28T00:00:00-04:00" itemprop="datePublished">Oct 28, 2012</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <blockquote>
  <p><strong>CREDIT:</strong> Although this article is my own work, it is based on ideas I got from
a very different but interesting <a href="http://www.subelsky.com/2012/11/ruby-dependencies-notifications-and.html">early draft</a> from Practicing Ruby reader
<a href="http://www.subelsky.com/">Mike Subelsky</a>. I owe him a huge hat tip for suggesting that we cover
this topic and for helping me get started with it.</p>
</blockquote>

<p>The challenge of sensibly connecting a set of objects together to perform a
complex task is one that confounds programmers of all skill levels. In fact, 
it is hard to reason about the relationships between objects without getting 
trapped by analysis paralysis. With that in mind, it is no surprise that so
many of us struggle with this particular aspect of object-oriented programming.</p>

<p>But like so many other problems we encounter in our work, this one can
be simplified greatly by introducing a common vocabulary and some rough
heuristics that make thinking and communicating about our code easier.
For reasoning about this particular design challenge, the 
“Object Peer Stereotypes” described in <a href="http://www.growing-object-oriented-software.com/">Growing Object-Oriented Software, Guided
by Tests</a> give us some very useful conceptual tools 
to work with.</p>

<p>In this article, we will explore the three stereotypical relationships 
between an object and its peers that were described in GOOS: 
dependencies, notifications, and adjustments. Taken together, these 
rough categorizations do a good job of identifying the kinds of
connections that exist between objects, which makes it easier
to develop a more nuanced view of how they communicate with each other.</p>

<p>The specific examples in this article are based on code from 
<a href="https://github.com/elm-city-craftworks/newman">Newman</a> (my experimental email-based microframework), but the
general concepts that we’ll discuss are relevant to all object-oriented 
software. If you keep your own projects in the back of your mind as you
read on, you’ll easily find similarities between Newman’s design 
challenges and your own.</p>

<h2 id="dependencies">Dependencies</h2>

<blockquote>
  <p>Services that the object requires from its peers so it can perform its
responsibilities. The object cannot function without these services. It should
not be possible to create the object without them. (GOOS, pg. 52)</p>
</blockquote>

<p>Whether they are internal or external, dependency relationships need to be
carefully managed in order to prevent brittleness. 
Alistair Cockburn’s <a href="http://alistair.cockburn.us/Hexagonal+architecture">ports and adapters</a> pattern provides
one way of dealing with this problem: define abstract <em>ports</em> in the 
application’s domain language that covers slices of functionality, and then build 
implementation-specific <em>adapters</em> with compatible interfaces. This approach allows dependencies 
to be reasoned about at a higher level of abstraction and makes it so that systems 
can be easily changed.</p>

<p>We applied this pattern (albeit without recognizing it by name) when thinking
through how Newman should handle its email dependency. We knew from the outset
that we’d need to support some sort of test mailer and that it should be a
drop-in replacement for its real mailer. We also anticipated that down the line
we might want to support delivery mechanisms other than the <code class="highlighter-rouge">mail</code> gem and
figured that some sort of adapter-based approach would be a good fit.</p>

<p>Constructing a port involves thinking through the various ways a 
subsystem will be used within your application and then 
mapping a protocol to those use cases. In Newman, we expected that
our email dependency would need to support the following requirements:</p>

<p>1) Read configuration data from a <code class="highlighter-rouge">Newman::Settings</code> object if necessary.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">mailer</span> <span class="o">=</span> <span class="no">AnyMailAdapter</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</code></pre>
</div>

<p>2) Retrieve all messages from an inbox, deleting them from the server in the
process.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">mailer</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">do_something_exciting</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> 
<span class="k">end</span>
</code></pre>
</div>

<p>3) Construct a complete message and deliver it immediately.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">mailer</span><span class="p">.</span><span class="nf">deliver_message</span><span class="p">(</span><span class="ss">:to</span>      <span class="o">=&gt;</span> <span class="s2">"test@test.com"</span><span class="p">,</span>
                       <span class="ss">:from</span>    <span class="o">=&gt;</span> <span class="s2">"gregory@practicingruby.com"</span><span class="p">,</span>
                       <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="s2">"A special offer for you!!!"</span><span class="p">,</span>
                       <span class="ss">:body</span>    <span class="o">=&gt;</span> <span class="s2">"Send me your credit card number, plz!"</span><span class="p">)</span>
</code></pre>
</div>

<p>4) Construct a message incrementally and then deliver it later, if at all.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">message</span> <span class="o">=</span> <span class="n">mailer</span><span class="p">.</span><span class="nf">new_message</span><span class="p">(</span><span class="ss">:to</span>   <span class="o">=&gt;</span> <span class="s2">"test@test.com"</span><span class="p">,</span>
                             <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="s2">"gregory@practicingruby.com"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">bank_account</span><span class="p">.</span><span class="nf">balance</span> <span class="o">&lt;</span> <span class="mi">1_000_000_000</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="s2">"Can I interest you in some prescription painkillers?"</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">body</span>    <span class="o">=</span> <span class="s2">"Best prices anywhere on the internets!!!"</span>
  <span class="n">messsage</span><span class="p">.</span><span class="nf">deliver</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Although you can make an educated guess about how to implement adapters
for this port based on the previous examples, there are many
unanswered questions lurking just beneath the surface. This is where
the difference between <em>interfaces</em> and <em>protocols</em> becomes important:</p>

<blockquote>
  <p>An interface defines whether two things can fit together, a protocol 
defines whether two things can <em>work together</em> (GOOS, pg. 58)</p>
</blockquote>

<p>If you revisit the code examples shown above, you’ll notice that the interface
requirements for a Newman-compatible mail adapter are roughly as follows:</p>

<ul>
  <li>The constructor accepts one argument (the settings object).</li>
  <li>The <code class="highlighter-rouge">messages</code> method returns an collection that responds to <code class="highlighter-rouge">each</code> and yields
an object for each message in the inbox.</li>
  <li>The <code class="highlighter-rouge">deliver_message</code> accepts one argument (a parameters hash).</li>
  <li>The <code class="highlighter-rouge">new_message</code> method accepts a parameters hash and returns
an object representing the message. At a minimum, the object allows certain fields
to be set (i.e., <code class="highlighter-rouge">subject</code> and <code class="highlighter-rouge">body</code>) and responds to a <code class="highlighter-rouge">deliver</code> method.</li>
</ul>

<p>Building an object that satisfies these requirements is trivial, but there is
no guarantee that doing so will result in an adapter that conforms to the
<em>protocol</em> that Newman expects. Unfortunately, protocols are much harder
to reason about and define than interfaces are.</p>

<p>Like many Ruby libraries, Newman relies on loose <a href="http://en.wikipedia.org/wiki/Duck_typing">duck typing</a> 
rather than a formal behavioral contract to determine whether one adapter can 
serve as a drop-in replacement for another. The <code class="highlighter-rouge">Newman::Mailer</code> object is used
by default, so it defines the canonical implementation that 
other adapters are expected to mimic at the functional level – even if they 
handle things very differently under the hood. This implicit contract makes 
it possible for <code class="highlighter-rouge">Newman::TestMailer</code> to stand in for 
a <code class="highlighter-rouge">Newman::Mailer</code> object, even though it stores all incoming and 
outgoing messages in memory rather than relying on SMTP and IMAP. Because
the two objects respond to the same messages in similar ways, the systems
that depend on them are unaware of their differences in implementation – they
are just two different adapters that both fit in the same port.</p>

<p>If you read through the source of the <a href="http://elm-city-craftworks.github.com/newman/lib/newman/mailer.html">Newman::Mailer</a> 
and <a href="http://elm-city-craftworks.github.com/newman/lib/newman/test_mailer.html">Newman::TestMailer</a> objects, you will find that
several compromises have been made for the sake of convenience:</p>

<ol>
  <li>
    <p>Arguments for the <code class="highlighter-rouge">new_message</code> and <code class="highlighter-rouge">deliver_message</code> methods on both 
adapters are directly delegated to the <code class="highlighter-rouge">Mail::Message</code> constructor, and the
return value of <code class="highlighter-rouge">messages</code> on both adapters is a collection 
of <code class="highlighter-rouge">Mail::Message</code> objects. This design implicitly ties the interface of those 
methods to the mail gem; it’s what GOOS calls a <em>hidden dependency</em>.</p>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">Newman::TestMailer</code> object is a singleton object, but it
implements a fake constructor in order to maintain interface compatibility 
with <code class="highlighter-rouge">Newman::Mailer</code>. This is an example of how constraints 
from dependencies can spill over into client code.</p>
  </li>
  <li>
    <p>Configuration data is completely ignored by <code class="highlighter-rouge">Newman::TestMailer</code>. Because
all of its operations are done in memory, it has no need for SMTP and IMAP
settings, but it needs to accept the settings object anyway for the 
sake of maintaining interface compatibility.</p>
  </li>
</ol>

<p>All of these warts stem from protocol issues. The first issue is due to
underspecification: Newman has a clear protocol for creating, retrieving, and
sending messages, but it does not clearly define what it expects the messages
themselves to look like. The coupling between the interface of <code class="highlighter-rouge">Newman::Mailer</code>
and that of <code class="highlighter-rouge">Mail::Message</code> makes it so that other adapters must also inherit
this hidden dependency. Because <code class="highlighter-rouge">Newman::TestMailer</code> also explicitly depends 
upon <code class="highlighter-rouge">Mail::Message</code>, this constraint does not complicate its implementation,
but it certainly does make it harder to build adapters that aren’t dependent 
on the mail gem.</p>

<p>On the flip side, the second and third issues are a result of 
overspecification. We didn’t want to make <code class="highlighter-rouge">Newman::TestMailer</code> a singleton, 
but because the underlying <code class="highlighter-rouge">Mail::TestMailer</code> is implemented that way,
we didn’t have much of a choice. Our decision to implement a fake constructor
in order to maintain compatibility with <code class="highlighter-rouge">Newman::Mailer</code> is something I was
never happy with, but I also couldn’t think of a better
alternative. I am somewhat less concerned about <code class="highlighter-rouge">Mailer::TestMailer</code> having to
accept a settings object that it doesn’t actually use, but it does feel like one
extra hoop to jump through simply for the sake of consistency.</p>

<p>Despite these rough edges, Newman’s way of handling its email dependency is a
good example of the <a href="http://alistair.cockburn.us/Hexagonal+architecture">ports and adapters</a> pattern in the 
wild. If anything, it serves as a reminder that the hard part of writing loosely
coupled code is not in the creation of duck-typed adapters, but in clearly
defining the protocol for our ports. This concept takes us beyond the idea of “coding to
an interface rather than an implementation” and is worth ruminating
over.</p>

<h2 id="notifications">Notifications</h2>

<blockquote>
  <p>Peers that need to be kept up to date with the object’s activity. The object
will notify interested peers whenever it changes state or performs a
significant action. Notifications are ‘fire and forget’; the object neither
knows nor cares which peers are listening. (GOOS, pg. 52)</p>
</blockquote>

<p>Because Ruby is a message-oriented programming language, it is easy to model
many kinds of object relationships as notifications. Doing so greatly reduces
the coupling between objects and helps establish a straight-line flow from a 
system’s inputs to its outputs.</p>

<p>Notification-based modeling is especially useful when designing framework code,
because it is important for frameworks to know as little as possible about the
applications that are built on top of them. The general design of
the extremely popular <a href="http://rack.github.com/">rack web server interface</a> leverages these ideas to
great effect; it assumes that its applications implement a meaningful
<code class="highlighter-rouge">call</code> method, but otherwise remains blissfully ignorant of their behaviors.</p>

<p>We have designed Newman using a similar
strategy, and the general idea can be understood by tracing the execution of
the <code class="highlighter-rouge">Newman::Server#tick</code> method:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Newman</span>
  <span class="k">class</span> <span class="nc">Server</span>
    <span class="c1"># NOTE: the mailer, apps, logger, and settings dependencies</span>
    <span class="c1"># are initialized when a Server instance is instantiated</span>

    <span class="k">def</span> <span class="nf">tick</span>
      <span class="n">mailer</span><span class="p">.</span><span class="nf">messages</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">request</span><span class="o">|</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">mailer</span><span class="p">.</span><span class="nf">new_message</span><span class="p">(</span><span class="ss">:to</span>   <span class="o">=&gt;</span> <span class="n">request</span><span class="p">.</span><span class="nf">from</span><span class="p">,</span>
                                      <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="n">settings</span><span class="p">.</span><span class="nf">service</span><span class="p">.</span><span class="nf">default_sender</span><span class="p">)</span>

        <span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">response</span><span class="p">.</span><span class="nf">deliver</span>
      <span class="k">end</span>

      <span class="c1"># ... error handling code omitted</span>
    <span class="k">end</span>


    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
      <span class="n">apps</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
        <span class="n">app</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">:request</span>  <span class="o">=&gt;</span> <span class="n">request</span><span class="p">,</span>
                 <span class="ss">:response</span> <span class="o">=&gt;</span> <span class="n">response</span><span class="p">,</span>
                 <span class="ss">:settings</span> <span class="o">=&gt;</span> <span class="n">settings</span><span class="p">,</span>
                 <span class="ss">:logger</span>   <span class="o">=&gt;</span> <span class="n">logger</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">return</span> <span class="kp">true</span>

      <span class="c1"># ... error handling code omitted</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Did you figure out how it works? Let’s walk through the process step by step to
confirm:</p>

<ol>
  <li>
    <p>The <code class="highlighter-rouge">tick</code> method walks over each incoming message currently queued by the
<code class="highlighter-rouge">mailer</code> object (i.e., the <code class="highlighter-rouge">request</code>).</p>
  </li>
  <li>
    <p>A <code class="highlighter-rouge">response</code> message is constructed and addressed to the sender of
the <code class="highlighter-rouge">request</code>.</p>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">process_request</code> method is called, which iterates over a
collection, executing the <code class="highlighter-rouge">call</code> method on each element and passing along
several dependencies that can be used to finish building a meaningful
<code class="highlighter-rouge">response</code> message.</p>
  </li>
  <li>
    <p>Once <code class="highlighter-rouge">process_request</code> completes successfully, the response is delivered.</p>
  </li>
</ol>

<p>Because <code class="highlighter-rouge">Newman::Server</code> has a notification-based relationship with its
<code class="highlighter-rouge">apps</code> collection, it does not know or care about the structure of those
objects. In fact, the contract is so simple that a trivial <code class="highlighter-rouge">Proc</code> object 
can serve as a fully functioning Newman application:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">Greeter</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">params</span><span class="o">|</span> <span class="n">params</span><span class="p">[</span><span class="ss">:response</span><span class="p">].</span><span class="nf">subject</span> <span class="o">=</span> <span class="s2">"Hello World!"</span> <span class="p">}</span>

<span class="n">server</span><span class="p">.</span><span class="nf">apps</span> <span class="o">=</span> <span class="p">[</span><span class="no">Greeter</span><span class="p">]</span>
<span class="n">server</span><span class="p">.</span><span class="nf">tick</span>
</code></pre>
</div>

<p>If we wanted to make things a bit more interesting, we could add request
and response logging into the mix, using Newman’s built-in features:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">Greeter</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">params</span><span class="o">|</span> <span class="n">params</span><span class="p">[</span><span class="ss">:response</span><span class="p">].</span><span class="nf">subject</span> <span class="o">=</span> <span class="s2">"Hello World!"</span> <span class="p">}</span>

<span class="n">server</span><span class="p">.</span><span class="nf">apps</span> <span class="o">=</span> <span class="p">[</span><span class="no">Newman</span><span class="o">::</span><span class="no">RequestLogger</span><span class="p">,</span> <span class="no">Greeter</span><span class="p">,</span> <span class="no">Newman</span><span class="o">::</span><span class="no">ResponseLogger</span><span class="p">]</span>
<span class="n">server</span><span class="p">.</span><span class="nf">tick</span>
</code></pre>
</div>

<p>These objects make use of a mixin that simplifies email logging, but as you can
see from the following code, they have no knowledge of the <code class="highlighter-rouge">Newman::Server</code>
object and rely entirely on the parameters being passed into their <code class="highlighter-rouge">#call</code>
method:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Newman</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="no">RequestLogger</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
    <span class="kp">include</span> <span class="no">EmailLogger</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">log_email</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:logger</span><span class="p">],</span> <span class="s2">"REQUEST"</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:request</span><span class="p">])</span> 
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="no">ResponseLogger</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
    <span class="kp">include</span> <span class="no">EmailLogger</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="n">log_email</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:logger</span><span class="p">],</span> <span class="s2">"RESPONSE"</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:response</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Taken together, these four objects combined form a cohesive workflow:</p>

<ol>
  <li>
    <p>The server receives incoming emails and passes them on to its <code class="highlighter-rouge">apps</code> for
processing, along with a placeholder <code class="highlighter-rouge">response</code> object.</p>
  </li>
  <li>
    <p>The request logger inspects the incoming email and records debugging 
information.</p>
  </li>
  <li>
    <p>The greeter sets the subject of the outgoing response to “Hello World”.</p>
  </li>
  <li>
    <p>The response logger inspects the outgoing email and records debugging
information.</p>
  </li>
  <li>
    <p>The server sends the response email.</p>
  </li>
</ol>

<p>The remarkable thing is not this semimundane process, but that the
objects involved know virtually nothing about their collaborators and are unaware of their position in the sequence of events. Context-independence
(<em>GOOS, pg. 54</em>) is a powerful thing, because it allows each object to be reasoned
about, tested, and developed in isolation.</p>

<p>The implications of notification-based modeling extend far beyond
context independence, but it wouldn’t be easy to summarize them in 
a few short sentences. Fortunately, this topic has been covered 
extensively in other Practicing Ruby articles, particularly in 
<a href="https://practicingruby.com/articles/64">Issue 4.11</a> and <a href="https://practicingruby.com/articles/71">Issue 5.2</a>. Be sure to
read those articles if you haven’t already; they are among the finest in our
collection.</p>

<h2 id="adjustments">Adjustments</h2>

<blockquote>
  <p>Peers that adjust the object’s behavior to the wider needs of the system. This
includes policy objects that make decisions on the object’s behalf . . . and
component parts of the object if it’s a composite. (GOOS, pg. 52)</p>
</blockquote>

<p>Adjustment relationships are hard to summarize, because they can exist in so 
many forms. But regardless of the form they take on, adjustments tend to be
used to bridge the gap between different levels of abstraction. Some are used
to raise the level of abstraction by wrapping a specific object in a more
generic interface, and others are designed to do the opposite.</p>

<p>For an example of climbing down the ladder of abstraction, consider 
<code class="highlighter-rouge">Newman::EmailLogger</code>. It is implemented as a module in Newman for convenience,
but it could easily be reimagined as a stateless peer object of <code class="highlighter-rouge">RequestLogger</code>
and <code class="highlighter-rouge">ResponseLogger</code>. Such a redesign would yield something similar to the
following code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Newman</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="no">EmailLogger</span> <span class="o">=</span> <span class="no">Object</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">log_email</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"</span><span class="se">\n</span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span> <span class="n">email_summary</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">email_summary</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
      <span class="p">{</span> <span class="ss">:from</span>     <span class="o">=&gt;</span> <span class="n">email</span><span class="p">.</span><span class="nf">from</span><span class="p">,</span>
        <span class="ss">:to</span>       <span class="o">=&gt;</span> <span class="n">email</span><span class="p">.</span><span class="nf">to</span><span class="p">,</span>
        <span class="ss">:bcc</span>      <span class="o">=&gt;</span> <span class="n">email</span><span class="p">.</span><span class="nf">bcc</span><span class="p">,</span>
        <span class="ss">:subject</span>  <span class="o">=&gt;</span> <span class="n">email</span><span class="p">.</span><span class="nf">subject</span><span class="p">,</span>
        <span class="ss">:reply_to</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">.</span><span class="nf">reply_to</span> <span class="p">}</span>
    <span class="k">end</span>    
  <span class="k">end</span>

  <span class="no">RequestLogger</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>  
    <span class="no">EmailLogger</span><span class="p">.</span><span class="nf">log_email</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:logger</span><span class="p">],</span> <span class="s2">"REQUEST"</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:request</span><span class="p">])</span>
  <span class="p">}</span>

  <span class="no">ResponseLogger</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="no">EmailLogger</span><span class="p">.</span><span class="nf">log_email</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:logger</span><span class="p">],</span> <span class="s2">"RESPONSE"</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:response</span><span class="p">])</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Though this is a subtle change, it lifts up and centralizes the concept of
“email logging” into a single object, rather than mixing helper methods into
various objects that need that functionality. This adjustment helps define the borders
between distinct concepts within the code and establishes <code class="highlighter-rouge">EmailLogger</code> as an
adjustment to the much more general <code class="highlighter-rouge">Logger</code> object it depends upon.</p>

<p>The philosophical distinction between these two objects is what matters here. 
A <code class="highlighter-rouge">Logger</code> has very abstract responsibilities: it must record arbitrary strings 
at various levels of severity and then format and output them to various 
streams. <code class="highlighter-rouge">EmailLogger</code>, on the other hand, is extremely concrete in its
responsibilities: it uses a <code class="highlighter-rouge">Logger</code> to report debugging information about
an email message. The details of how the actual logging happens are hidden from
<code class="highlighter-rouge">EmailLogger</code>’s clients, making it easier to treat as a black box.</p>

<p>Simple designs can also emerge from climbing the ladder of abstraction, 
that is, moving from a very specific context to a much more general one. For
example, it might not be a bad idea to introduce an object into Newman 
that encapsulates the concept of an email message but leaves the exact
delivery mechanism up to the individual adapters:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1"># this code would be in an adapter or application code</span>
<span class="n">message</span> <span class="o">=</span> <span class="no">Newman</span><span class="o">::</span><span class="no">Message</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="o">|</span><span class="n">params</span><span class="o">|</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">).</span><span class="nf">deliver</span> <span class="p">}</span>

<span class="c1"># elsewhere, no knowledge of the dependency on the mail gem would be necessary:</span>
<span class="n">message</span><span class="p">.</span><span class="nf">to</span>      <span class="o">=</span> <span class="s2">"test@test.com"</span>
<span class="n">message</span><span class="p">.</span><span class="nf">from</span>    <span class="o">=</span> <span class="s2">"gregory@practicingruby.com"</span>
<span class="n">message</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="s2">"You have won twenty bazillion dollars!"</span>
<span class="n">message</span><span class="p">.</span><span class="nf">body</span>    <span class="o">=</span> <span class="s2">"Please send us a hair sample to confirm your ID"</span>

<span class="n">message</span><span class="p">.</span><span class="nf">deliver</span>
</code></pre>
</div>

<p>This kind of object is trivial to implement because it is nothing more
than a value object with a simple callback mechanism bolted on top of it:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Newman</span> 
  <span class="k">class</span> <span class="nc">Message</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delivery_callback</span><span class="p">)</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">delivery_callback</span> <span class="o">=</span> <span class="n">delivery_callback</span>
    <span class="k">end</span>

    <span class="kp">attr_accessor</span> <span class="ss">:to</span><span class="p">,</span> <span class="ss">:from</span><span class="p">,</span> <span class="ss">:subject</span><span class="p">,</span> <span class="ss">:body</span>

    <span class="k">def</span> <span class="nf">deliver</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span> <span class="k">unless</span> <span class="n">delivery_callback</span>

      <span class="n">delivery_callback</span><span class="o">.</span><span class="p">(</span><span class="ss">:to</span>      <span class="o">=&gt;</span> <span class="n">to</span><span class="p">,</span>      <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="n">from</span><span class="p">,</span> 
                         <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">body</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="kp">attr_accessor</span> <span class="ss">:delivery_callback</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Despite its simplicity, this object provides a useful benefit: it explicitly
separates the protocol of message delivery from its implementation. If all
mail adapters for Newman were expected to return only <code class="highlighter-rouge">Newman::Message</code> objects, 
then any message-processing code within Newman (either in the server or in
application code) would have a well-defined interface to work against. Although
this requirement would make adapters slightly more cumbersome to write, it would
completely eliminate the hidden dependency issue discussed earlier.</p>

<p>Regardless of which direction they are pointed in, adjustment relationships are
very closely related to the concept of object composition in general. With that
in mind, the authors of GOOS have a useful rule to consider when designing 
composite objects:</p>

<blockquote>
  <p>The API of a composite object should not be more complicated than that of any
of its components. (GOOS, pg. 54)</p>
</blockquote>

<p>Notice that in both the <code class="highlighter-rouge">Newman::EmailLogger</code> example and the <code class="highlighter-rouge">Newman::Message</code>
object, the result of composition is that a more complex system is being wrapped
by something with fewer methods and concepts to worry about. When applied
repeatedly, this kind of design causes software to become more simple as it
grows.</p>

<h2 id="reflections">Reflections</h2>

<p>The benefit I have gained from being able to explicitly label various 
object relationships as dependencies, notifications, and adjustments is that
it forces me to think about my code in a more fine-grained way. Each
kind of object relationship comes with benefits and costs that are easier to
reason about when you recognize them for what they are.</p>

<p>As with most ideas from <a href="http://www.growing-object-oriented-software.com/">Growing Object-Oriented Software, Guided by Tests</a>,
I have not yet had a chance to apply this particular set of heuristics
frequently enough to know the full extent of their usefulness. However, it never
hurts to have specific words to describe ideas that previously were hard for me
to express without relying heavily on intuition.</p>

<p>I would love to hear from you if you can think of ways to connect these ideas
back to your own projects or to the open source projects you’ve worked with. If
you have an interesting story to share, please leave a comment!</p>


  </div>

  <div style="text-align: center">
    <h3><a href="/">Want to keep reading? Check out our archives for more.</a></h3>

    <small>Practicing Ruby is proudly independent, open source, and advertising free.<br/>If you insist on being asked for something in return, check out <a href="/support">how to support my work</a>.</small>
  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
