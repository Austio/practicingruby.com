<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Infrastructure automation by example</title>
  <meta name="description" content="  This issue of Practicing Ruby was a collaboration with Mathias Lafeldt(@mlafeldt), an InfrastructureDeveloper living in Hamburg, Germany. If Mathias had to...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/infrastructure-automation">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Infrastructure automation by example</h1>
    <p class="post-meta"><time datetime="2013-11-12T00:00:00-05:00" itemprop="datePublished">Nov 12, 2013</time> • Mathias Lafeldt, Jordan Byron, and Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <blockquote>
  <p>This issue of Practicing Ruby was a collaboration with Mathias Lafeldt
(<a href="https://twitter.com/mlafeldt">@mlafeldt</a>), an Infrastructure
Developer living in Hamburg, Germany. If Mathias had to choose the one
Internet meme that best describes his work, it would certainly be
<em>Automate all the things!</em></p>
</blockquote>

<p>For at least as long as Ruby has been popular among web developers, it has also
been recognized as a useful tool for system administration work. Although it was
first used as a clean alternative to Perl for adhoc scripting, Ruby quickly
evolved to the point where it became an excellent platform for large scale 
infrastructure automation projects.</p>

<p>In this article, we’ll explore realistic code that handles various system
automation tasks, and discuss what benefits the automated approach has over 
doing things the old-fashioned way. We’ll also see first-hand what it means to treat
“infrastructure as code”, and the impact it has on building maintainable systems.</p>

<h2 id="prologue-why-does-infrastructure-automation-matter">Prologue: Why does infrastructure automation matter?</h2>

<p>Two massive infrastructure automation systems have been built in 
Ruby (<a href="http://projects.puppetlabs.com/projects/puppet">Puppet</a> and <a href="http://www.opscode.com/chef/">Chef</a>), both of which have entire open-source
ecosystems supporting them. But because these frameworks were built by and for
system administrators, infrastructure automation is often viewed as a
specialized skillset by Ruby programmers, rather than something that everyone
should learn. This is probably an incorrect viewpoint, but it is one that is
easy to hold without realizing the consequences.</p>

<p>Speaking from my own experiences, I had always assumed that infrastructure
automation was a problem that mattered mostly for large-scale public web
applications, internet service providers, and very complicated enterprise
projects. In those kinds of environments, the cost of manually setting up
servers would obviously be high enough to justify using a 
sophisticated automation framework. But because I never encountered those
scenarios in my own work, I was content to do things the old-fashioned way:
reading lots of “works for me” instructions from blog posts, manually typing
commands on the console, and swearing loudly whenever I broke something. For
things that really matter or tasks that seemed too tough for me to do on my own,
I’d find someone else to take care of it for me.</p>

<p>The fundamental problem was that my system-administration related pain wasn’t 
severe enough to motivate me to learn a whole new way of doing things. Because
I never got curious enough about the topic, I didn’t realize that infrastructure 
automation has other benefits beyond eliminating the costs
of doing repetitive and error-prone manual configuration work. In particular,
I vastly underestimated the value of treating “infrastructure as code”,
especially as it relates to creating systems that are abstract, modular,
testable, understandable, and utterly hackable. Narrowing the problem down to
the single issue of reducing repetitive labor, I had failed to see that
infrastructure automation has the potential to eliminate an entire class of
problems associated with manual system configuration.</p>

<p>To help me get unstuck from this particular viewpoint, Mathias Lafeldt offered
to demonstrate to me why infrastructure automation matters, even if you aren’t
maintaining hundreds of servers or spending dozens of hours a week babysitting
production systems. To teach me this lesson, Mathias built a <a href="https://github.com/elm-city-craftworks/practicing-ruby-cookbook/tree/1.0.8">Chef cookbook</a> to completely automate the process of building an environment suitable for running <a href="https://github.com/elm-city-craftworks/practicing-ruby-web">Practicing Ruby’s web application</a>, starting with nothing but a bare Ubuntu
Linux installation. The early stages of this process weren’t easy: Jordan and I
had to answer more questions about our system setup than I
ever thought would be necessary. But as things fell into place and
recipes started getting written, the benefits of being able to conceptualize a
system as code rather than as an amorphous blob of configuration files and
interconnected processes began to reveal themselves.</p>

<p>The purpose of this article is not to teach you how to get up and running with
Chef, nor is it meant to explain every last detail of the cookbook that
Mathias built for us. Instead, it will help you learn about the core concepts of
infrastructure automation the same way I did: by tearing apart a handful of real
use cases and seeing what you can understand about them. If you’ve never used
an automated system administration workflow before, or if you’ve only ever run
cookbooks that other people have provided for you, this article will give you a
much better sense of why the idea of treating “infrastructure as code” matters.
If you already know the answer to that question, you may still benefit from
looking at the problem from a beginner’s mindset. In either case, we have
a ton of code to work our way through, so let’s get started!</p>

<h2 id="a-recipe-for-setting-up-ruby">A recipe for setting up Ruby</h2>

<p>Let’s take a look at how Chef can be used 
to manage a basic Ruby installation. As you can see below, Chef
uses a pure Ruby domain-specific language for defining its recipes,
so it should be easy to read even if you’ve never worked with
the framework before:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s2">"ruby_build"</span>

<span class="n">ruby_version</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">"practicingruby"</span><span class="p">][</span><span class="s2">"ruby"</span><span class="p">][</span><span class="s2">"version"</span><span class="p">]</span>

<span class="n">ruby_build_ruby</span><span class="p">(</span><span class="n">ruby_version</span><span class="p">)</span> <span class="p">{</span> <span class="n">prefix_path</span> <span class="s2">"/usr/local"</span> <span class="p">}</span>

<span class="n">bash</span> <span class="s2">"update-rubygems"</span> <span class="k">do</span>
  <span class="n">code</span>   <span class="s2">"gem update --system"</span>
  <span class="n">not_if</span> <span class="s2">"gem list | grep -q rubygems-update"</span>
<span class="k">end</span>

<span class="n">gem_package</span> <span class="s2">"bundler"</span>
</code></pre>
</div>

<p>At the high level, this recipe is responsible for handling the following tasks:</p>

<ol>
  <li>Installing the <code class="highlighter-rouge">ruby-build</code> command line tool.</li>
  <li>Using <code class="highlighter-rouge">ruby-build</code> to compile and install Ruby to <code class="highlighter-rouge">/usr/local</code>.</li>
  <li>Updating RubyGems to the latest version.</li>
  <li>Installing the bundler gem.</li>
</ol>

<p>Under the hood, a lot more is happening. Let’s take a closer look at each
step to understand a bit more about how Chef recipes work.</p>

<p><strong>Installing ruby-build</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s2">"ruby_build"</span>
</code></pre>
</div>

<p>Including the default recipe from the <a href="https://github.com/fnichol/chef-ruby_build">ruby_build cookbook</a> 
in our own code takes care of installing the <code class="highlighter-rouge">ruby-build</code> command line utility, 
and also handles installing a bunch of low-level packages that are required to compile Ruby 
on an Ubuntu system. But all of this work happens behind the scenes – we just need 
to make use of the <code class="highlighter-rouge">ruby_build_ruby</code> command this cookbook provides and the rest will be 
taken care of for us.</p>

<p><strong>Compiling and installing Ruby</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">ruby_version</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">"practicingruby"</span><span class="p">][</span><span class="s2">"ruby"</span><span class="p">][</span><span class="s2">"version"</span><span class="p">]</span>

<span class="n">ruby_build_ruby</span><span class="p">(</span><span class="n">ruby_version</span><span class="p">)</span> <span class="p">{</span> <span class="n">prefix_path</span> <span class="s2">"/usr/local"</span> <span class="p">}</span>
</code></pre>
</div>

<p>In our recipe, the version of Ruby we want to install is not specified
explicitly, but instead set elsewhere using Chef’s attribute system.
In the cookbook’s <a href="https://github.com/elm-city-craftworks/practicing-ruby-cookbook/blob/1.0.8/attributes/default.rb">default attributes file</a>, you’ll find an entry that
looks like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">default</span><span class="p">[</span><span class="s2">"practicingruby"</span><span class="p">][</span><span class="s2">"ruby"</span><span class="p">][</span><span class="s2">"version"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"2.0.0-p247"</span>
</code></pre>
</div>

<p>Chef has a very flexible and very complicated <a href="http://docs.opscode.com/essentials_cookbook_attribute_files.html">attribute management system</a>, but its main purpose is the same as any configuration 
system: to keep source code as generic as possible by not hard-coding
application-specific values. By getting these values out of the
source file and into well-defined locations, it also makes it
easy to see all of our application-specific configuration 
data at once.</p>

<p><strong>Updating RubyGems</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">bash</span> <span class="s2">"update-rubygems"</span> <span class="k">do</span>
  <span class="n">code</span>   <span class="s2">"gem update --system"</span>
  <span class="n">not_if</span> <span class="s2">"gem list | grep -q rubygems-update"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In this code we make use of a couple shell commands, the 
first of which is obviously responsible for updating RubyGems.
The second command is a guard that prevents the gem update
command from running more than once.</p>

<p>Most actions in Chef have similar logic baked into them to
make sure operations are only carried out when necessary. These 
guard clauses are handled internally whenever there is a well defined 
condition to check for, so you don’t need to think about them often.
In the case of shell commands the operation is potentially arbitrary,
so a custom guard clause is necessary.</p>

<p><strong>Installing bundler</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">gem_package</span> <span class="s2">"bundler"</span>
</code></pre>
</div>

<p>This command is roughly equivalent to typing <code class="highlighter-rouge">gem install bundler</code> on the
command line. Because we installed Ruby into <code class="highlighter-rouge">/usr/local</code>, it will be used as
our system Ruby, and so we can use <code class="highlighter-rouge">gem_package</code> without any additional
settings. More complicated system setups would involve a bit more
code than what you see above, but for our purposes we’re able to keep 
things simple.</p>

<p>Putting all of these ideas together, we end up not just with an understanding of
how to go about installing Ruby using a Chef recipe, but also a glimpse
of a few of the benefits of treating “infrastructure as code”. As we
continue to work through more complicated examples, those benefits
will become even more obvious.</p>

<h2 id="a-recipe-for-setting-up-process-monitoring">A recipe for setting up process monitoring</h2>

<p>Now that we’ve tackled a simple example of a Chef recipe, let’s work through 
a more interesting one. The following code is what we use for installing
and configuring the <a href="http://godrb.com/">God</a> process monitoring framework:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s2">"practicingruby::_ruby"</span>

<span class="n">gem_package</span> <span class="s2">"god"</span>

<span class="n">directory</span> <span class="s2">"/etc/god"</span> <span class="k">do</span>
  <span class="n">owner</span> <span class="s2">"root"</span>
  <span class="n">group</span> <span class="s2">"root"</span>
  <span class="n">mode</span>  <span class="s2">"0755"</span>
<span class="k">end</span>

<span class="n">file</span> <span class="s2">"/etc/god/master.conf"</span> <span class="k">do</span>
  <span class="n">owner</span>    <span class="s2">"root"</span>
  <span class="n">group</span>    <span class="s2">"root"</span>
  <span class="n">mode</span>     <span class="s2">"0644"</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">"service[god]"</span>

  <span class="n">home</span>     <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">"practicingruby"</span><span class="p">][</span><span class="s2">"deploy"</span><span class="p">][</span><span class="s2">"home_dir"</span><span class="p">]</span> 
  <span class="n">god_file</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">home</span><span class="si">}</span><span class="s2">/current/config/delayed_job.god"</span>

  <span class="n">content</span> <span class="s2">"God.load('</span><span class="si">#{</span><span class="n">god_file</span><span class="si">}</span><span class="s2">') if File.file?('</span><span class="si">#{</span><span class="n">god_file</span><span class="si">}</span><span class="s2">')"</span>
<span class="k">end</span>

<span class="n">cookbook_file</span> <span class="s2">"/etc/init/god.conf"</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">"god.upstart"</span>
  <span class="n">owner</span>  <span class="s2">"root"</span>
  <span class="n">group</span>  <span class="s2">"root"</span>
  <span class="n">mode</span>   <span class="s2">"0644"</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">"god"</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Service</span><span class="o">::</span><span class="no">Upstart</span>
  <span class="n">action</span>   <span class="p">[</span><span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The short story about this recipe is that it handles the following tasks:</p>

<ol>
  <li>Installing the <code class="highlighter-rouge">god</code> gem.</li>
  <li>Setting up some configuration files for <code class="highlighter-rouge">god</code>.</li>
  <li>Registering <code class="highlighter-rouge">god</code> as a service to run at system boot.</li>
  <li>Starting the <code class="highlighter-rouge">god</code> service as soon as the recipe is run.</li>
</ol>

<p>But that’s just the 10,000 foot view – let’s get down in the weeds a bit.</p>

<p><strong>Installing god via RubyGems</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">include_recipe</span> <span class="s2">"practicingruby::_ruby"</span>

<span class="n">gem_package</span> <span class="s2">"god"</span>
</code></pre>
</div>

<p>God is distributed as a gem, so we need to make sure Ruby is installed
before we can make use of it. To do this, we include the Ruby installation
recipe that was shown earlier. If the Ruby recipe hasn’t run yet, it will
be executed now, but if it has already run then <code class="highlighter-rouge">include_recipe</code> will
do nothing at all. In either case, we can be sure that we have a
working Ruby configuration by the time the <code class="highlighter-rouge">gem_package</code> command is called.</p>

<p>The <code class="highlighter-rouge">gem_package</code> command itself works exactly the same way as it did when we
used it to install Bundler in the Ruby recipe, so there’s nothing new to say
about it.</p>

<p><strong>Setting up a master configuration file</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">directory</span> <span class="s2">"/etc/god"</span> <span class="k">do</span>
  <span class="n">owner</span> <span class="s2">"root"</span>
  <span class="n">group</span> <span class="s2">"root"</span>
  <span class="n">mode</span>  <span class="s2">"0755"</span>
<span class="k">end</span>

<span class="n">file</span> <span class="s2">"/etc/god/master.conf"</span> <span class="k">do</span>
  <span class="n">owner</span>    <span class="s2">"root"</span>
  <span class="n">group</span>    <span class="s2">"root"</span>
  <span class="n">mode</span>     <span class="s2">"0644"</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">"service[god]"</span>

  <span class="n">home</span>     <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">"practicingruby"</span><span class="p">][</span><span class="s2">"deploy"</span><span class="p">][</span><span class="s2">"home_dir"</span><span class="p">]</span> 
  <span class="n">god_file</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="n">home</span><span class="si">}</span><span class="s2">/current/config/delayed_job.god"</span>

  <span class="n">content</span> <span class="s2">"God.load('</span><span class="si">#{</span><span class="n">god_file</span><span class="si">}</span><span class="s2">') if File.file?('</span><span class="si">#{</span><span class="n">god_file</span><span class="si">}</span><span class="s2">')"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>A master configuration file is typically used with God to load
all of the process-specific configuration files for a whole system 
when God starts up. In our case, we only have one process to watch, 
so our master configuration is a simple one-line shim that points at the
<a href="https://github.com/elm-city-craftworks/practicing-ruby-web/blob/master/config/delayed_job.god">delayed_job.god</a> file that is deployed alongside our Rails 
application.</p>

<p>Because our <code class="highlighter-rouge">/etc/god/master.conf</code> file is so trivial, we directly specify 
its contents in the recipe itself rather than using one of Chef’s more
complicated mechanisms for dealing with configuration files. In this
particular case, manually creating the file would certainly involve
less work, but we’d lose some of the benefits that Chef is providing here.</p>

<p>In particular, it’s worth noticing that file permissions and ownership
are explicitly specified in the recipe, that the actual location
of the file is configurable, and that Chef will send a notification
to restart God whenever this file changes. All of these things
are the sort of minor details that are easily forgotten when
manually managing configuration files on servers.</p>

<p><strong>Running god as a system service</strong></p>

<p>God needs to be running at all times, so we want to make sure that it started on
system reboot and cleanly terminated when the system is shut down. To do that, we
can configure God to run as an Upstart service. To do that, we need to create
yet another configuration file:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">cookbook_file</span> <span class="s2">"/etc/init/god.conf"</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">"god.upstart"</span>
  <span class="n">owner</span>  <span class="s2">"root"</span>
  <span class="n">group</span>  <span class="s2">"root"</span>
  <span class="n">mode</span>   <span class="s2">"0644"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">cookbook_file</code> command used here is similar to the <code class="highlighter-rouge">file</code> command, but has a
specialized purpose: To copy files from a cookbook’s <code class="highlighter-rouge">files</code> directory to
some location on the system being automated. In this case, we’re
using the <code class="highlighter-rouge">files/default/god.upstart</code> cookbook file as our source, and it
looks like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>description "God is a monitoring framework written in Ruby"

start on runlevel [2345]
stop on runlevel [!2345]

pre-start exec god -c /etc/god/master.conf
post-stop exec god terminate
</code></pre>
</div>

<p>Here we can see exactly what commands are going to be used to start and 
shutdown God, as well as the runlevels that it will be started and
stopped on. We can also see that the <code class="highlighter-rouge">/etc/god/master.conf</code> file we
created earlier will be loaded by God whenever it starts up.</p>

<p>Now all that remains is to enable the service to run when the system
boots, and also tell it to start up right now:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">service</span> <span class="s2">"god"</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Provider</span><span class="o">::</span><span class="no">Service</span><span class="o">::</span><span class="no">Upstart</span>
  <span class="n">action</span>   <span class="p">[</span><span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>It’s worth mentioning here that if we didn’t explicitly specify the
<code class="highlighter-rouge">Service::Upstart</code> provider, Chef would expect the service
configuration file to be written as a <a href="https://raw.github.com/elm-city-craftworks/practicing-ruby-cookbook/37ca12dc6432dfee955a70b6f2cc288e40782733/files/default/god.sh">System-V init
script</a>, which are written at a much lower level of abstraction. There
isn’t anything wrong with doing things that way, but Upstart
scripts are definitely more readable.</p>

<p>By this point, we’ve already seen how Chef can be used to install packages,
manage configuration files, run arbitrary shell commands, 
and set up system services. That knowledge alone will take you far,
but let’s look at one more recipe to discover a few more 
advanced features before we wrap things up.</p>

<h2 id="a-recipe-for-setting-up-an-nginx-web-server">A recipe for setting up an Nginx web server</h2>

<p>The recipe we use for configuring Nginx is the most complicated one in
Practicing Ruby’s cookbook, but it mostly just combines and expands upon the
concepts we’ve already discussed. Try to see what you can
understand of it before reading the explanations that follow, but don’t
worry if every last detail isn’t immediately clear to you:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"worker_processes"</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">4</span>
<span class="n">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"worker_connections"</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">768</span>
<span class="n">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"default_site_enabled"</span><span class="p">]</span> <span class="o">=</span> <span class="kp">false</span>

<span class="n">include_recipe</span> <span class="s2">"nginx::default"</span>

<span class="n">ssl_dir</span> <span class="o">=</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"dir"</span><span class="p">],</span> <span class="s2">"ssl"</span><span class="p">)</span>
<span class="n">directory</span> <span class="n">ssl_dir</span> <span class="k">do</span>
  <span class="n">owner</span> <span class="s2">"root"</span>
  <span class="n">group</span> <span class="s2">"root"</span>
  <span class="n">mode</span>  <span class="s2">"0600"</span>
<span class="k">end</span>

<span class="n">domain_name</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">"practicingruby"</span><span class="p">][</span><span class="s2">"rails"</span><span class="p">][</span><span class="s2">"host"</span><span class="p">]</span>
<span class="n">bash</span> <span class="s2">"generate-ssl-files"</span> <span class="k">do</span>
  <span class="n">cwd</span>   <span class="n">ssl_dir</span>
  <span class="n">flags</span> <span class="s2">"-e"</span>
  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOS</span><span class="sh">
    DOM=</span><span class="si">#{</span><span class="n">domain_name</span><span class="si">}</span><span class="sh">
    openssl genrsa -out $DOM.key 4096
    openssl req -new -batch -subj "/CN=$DOM" -key $DOM.key -out $DOM.csr
    openssl x509 -req -days 365 -in $DOM.csr -signkey $DOM.key -out $DOM.crt
    rm $DOM.csr
</span><span class="no">  EOS</span>
  <span class="n">notifies</span> <span class="ss">:reload</span><span class="p">,</span> <span class="s2">"service[nginx]"</span>
  <span class="n">not_if</span>   <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ssl_dir</span><span class="p">,</span> <span class="n">domain_name</span> <span class="o">+</span> <span class="s2">".crt"</span><span class="p">))</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">template</span> <span class="s2">"</span><span class="si">#{</span><span class="n">node</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"dir"</span><span class="p">]</span><span class="si">}</span><span class="s2">/sites-available/practicingruby"</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">"nginx_site.erb"</span>
  <span class="n">owner</span>  <span class="s2">"root"</span>
  <span class="n">group</span>  <span class="s2">"root"</span>
  <span class="n">mode</span>   <span class="s2">"0644"</span>
  <span class="n">variables</span><span class="p">(</span><span class="ss">:domain_name</span> <span class="o">=&gt;</span> <span class="n">domain_name</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">nginx_site</span> <span class="s2">"practicingruby"</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>

<p>When you put all the pieces together, this recipe is responsible for the
following tasks:</p>

<ol>
  <li>Overriding some default Nginx configuration values.</li>
  <li>Installing Nginx and managing it as a service.</li>
  <li>Generating a self-signed SSL certificate based on a configurable domain name.</li>
  <li>Using a template to generate a site-specific configuration file.</li>
  <li>Enabling Nginx to serve up our Rails application.</li>
</ol>

<p>In this recipe even more than the others we’ve looked at, a lot of the details
are handled behind the scenes. Let’s dig a bit deeper to see what’s really
going on.</p>

<p><strong>Installing and configuring Nginx</strong></p>

<p>We rely on the nginx cookbook to do most of the hard work of 
setting up our web server for us. Apart
from overriding a few default attributes, we only need to include the
<code class="highlighter-rouge">nginx:default</code> recipe into our own code to install the relevant software 
packages, generate an <code class="highlighter-rouge">nginx.conf</code> file, and to provide all the necessary
init scripts to manage Nginx as a service. The following four lines
of code take care of all of that for us:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"worker_processes"</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">4</span>
<span class="n">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"worker_connections"</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">768</span>
<span class="n">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"default_site_enabled"</span><span class="p">]</span> <span class="o">=</span> <span class="kp">false</span>

<span class="n">include_recipe</span> <span class="s2">"nginx::default"</span>
</code></pre>
</div>

<p>The interesting thing to notice here is that unlike the typical server
configuration file, only the things we explicitly changed are visible here.
All the rest of the defaults are set automatically for us, and we don’t
need to be concerned with their values until the time comes when we decide we
need to change them. By hiding all the details that do not matter to us,
Chef recipes tend to be much more intention revealing than
the typical server configuration file.</p>

<p><strong>Generating SSL keys</strong></p>

<p>In a real production environment, we would probably copy SSL credentials
into place rather than generating them on the fly. However, since
this particular cookbook provides a blueprint for building an experimental testbed
rather than an exact clone of our live system, we handle this task internally to make the system a little bit more developer-friendly.</p>

<p>The basic idea behind the following code is that we want to generate an SSL
certificate and private key for whatever domain name you’d like, so that 
it is possible to serve up the application over SSL within a virtualized 
staging environment. But since that is somewhat of an obscure use case, you
can focus on what interesting Chef features are being used
in the following code rather than the particular shell code being executed:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">ssl_dir</span> <span class="o">=</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"dir"</span><span class="p">],</span> <span class="s2">"ssl"</span><span class="p">)</span>
<span class="n">directory</span> <span class="n">ssl_dir</span> <span class="k">do</span>
  <span class="n">owner</span> <span class="s2">"root"</span>
  <span class="n">group</span> <span class="s2">"root"</span>
  <span class="n">mode</span>  <span class="s2">"0600"</span>
<span class="k">end</span>

<span class="n">domain_name</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">"practicingruby"</span><span class="p">][</span><span class="s2">"rails"</span><span class="p">][</span><span class="s2">"host"</span><span class="p">]</span>
<span class="n">bash</span> <span class="s2">"generate-ssl-files"</span> <span class="k">do</span>
  <span class="n">cwd</span>   <span class="n">ssl_dir</span>
  <span class="n">flags</span> <span class="s2">"-e"</span>
  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOS</span><span class="sh">
    DOM=</span><span class="si">#{</span><span class="n">domain_name</span><span class="si">}</span><span class="sh">
    openssl genrsa -out $DOM.key 4096
    openssl req -new -batch -subj "/CN=$DOM" -key $DOM.key -out $DOM.csr
    openssl x509 -req -days 365 -in $DOM.csr -signkey $DOM.key -out $DOM.crt
    rm $DOM.csr
</span><span class="no">  EOS</span>
  <span class="n">notifies</span> <span class="ss">:reload</span><span class="p">,</span> <span class="s2">"service[nginx]"</span>
  <span class="n">not_if</span>   <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="o">::</span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">ssl_dir</span><span class="p">,</span> <span class="n">domain_name</span> <span class="o">+</span> <span class="s2">".crt"</span><span class="p">))</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>As you read through this code, you may have noticed that <code class="highlighter-rouge">::File</code> is used
instead of <code class="highlighter-rouge">File</code>, which looks a bit awkward. The problem here is that
Chef defines its own <code class="highlighter-rouge">File</code> class that ends up having a naming collision with
Ruby’s core class. So to safely make use of Ruby’s <code class="highlighter-rouge">File</code> class, we need to
explicitly do our constant lookup from the top-level namespace. This is just a
small side effect of how Chef’s recipe DSL is implemented, but it is
worth noting to clear up any confusion.</p>

<p>With that distraction out of the way, we can skip right over the <code class="highlighter-rouge">directory</code>
code which we’ve seen in earlier recipes, and turn our attention to the <code class="highlighter-rouge">bash</code>
command and its options. This example is far more interesting than the one we
used to update RubyGems earlier, because in addition to specifying a command to
execute and a <code class="highlighter-rouge">not_if</code> guard clause, it also does all of the following things:</p>

<ul>
  <li>Switches the working directory to the SSL directory we created within our Nginx directory.</li>
  <li>Sets the <code class="highlighter-rouge">-e</code> flag, which will abort the script if any command fails to run successfully.</li>
  <li>Uses a service notification to tell Nginx to reload its configuration files</li>
</ul>

<p>From this we see that executing shell code via a Chef recipe isn’t quite the
same thing as simply running some commands in a console. The entire surrounding
context is also specified and verified, making it a whole lot more likely
that things will work the way you expect them to. If these benefits were
harder to see in the Ruby installation recipe, they should be easier to
recognize now.</p>

<p><strong>Configuring Nginx to serve up Practicing Ruby</strong></p>

<p>Although the <a href="https://github.com/opscode-cookbooks/nginx">nginx cookbook</a> takes care 
of setting up our <code class="highlighter-rouge">nginx.conf</code> file for us, it does not manage site 
configurations for us. We need to take care of that ourselves and
tweak some settings dynamically, so that means telling our
recipe to make use of a template:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">template</span> <span class="s2">"</span><span class="si">#{</span><span class="n">node</span><span class="p">[</span><span class="s2">"nginx"</span><span class="p">][</span><span class="s2">"dir"</span><span class="p">]</span><span class="si">}</span><span class="s2">/sites-available/practicingruby"</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">"nginx_site.erb"</span>
  <span class="n">owner</span>  <span class="s2">"root"</span>
  <span class="n">group</span>  <span class="s2">"root"</span>
  <span class="n">mode</span>   <span class="s2">"0644"</span>
  <span class="n">variables</span><span class="p">(</span><span class="ss">:domain_name</span> <span class="o">=&gt;</span> <span class="n">domain_name</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The <a href="https://github.com/elm-city-craftworks/practicing-ruby-cookbook/blob/master/templates/default/nginx_site.erb">full template</a>
is a rather long file full of the typical Nginx boilerplate, but the small
excerpt below shows how it is customized using ERB to insert some dynamic
content:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server {
  listen 80;
  server_name <span class="cp">&lt;%=</span> <span class="s2">"</span><span class="si">#{</span><span class="vi">@domain_name</span><span class="si">}</span><span class="s2"> www.</span><span class="si">#{</span><span class="vi">@domain_name</span><span class="si">}</span><span class="s2">"</span> <span class="cp">%&gt;</span>;
  rewrite ^ https://$server_name$request_uri? permanent;
}
</code></pre>
</div>

<p>Once the configuration file is generated and stored in the right place, we
enable it using the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">nginx_site</span> <span class="s2">"practicingruby"</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Under the hood, the <a href="https://github.com/Dreyer/nxensite">nxensite</a> script is used 
to do the actual work of enabling the site, but that implementation detail is 
deliberately kept hidden from view.</p>

<p>At this point, we have studied enough features of Chef to establish a basic
literacy that will facilitate reading a wide range of recipes with only
a little bit of effort. At the very least, you now have enough
knowledge to make sense of every recipe in Practicing Ruby’s cookbook.</p>

<h2 id="a-cookbook-for-building-a-mostly-complete-rails-environment">A cookbook for building a (mostly) complete Rails environment</h2>

<p>The goal of this article was to give you a sense of what kinds of building
blocks that Chef recipes are made up of so that you could see various
infrastructure automation concepts in practice. If you feel like you’ve
made it that far, you may now be interested in looking at how a complete
automation project is sewn together.</p>

<p>The full <a href="https://github.com/elm-city-craftworks/practicing-ruby-cookbook/tree/1.0.8">Practicing Ruby cookbook</a> contains a total of eight recipes,
three of which we’ve already covered in this article. The five recipes
we did not discuss are responsible for handling the
following chores:</p>

<ul>
  <li>Creating and managing a deployment user account to be used by Capistrano.</li>
  <li>Installing PostgreSQL and configuring a database for use with our Rails app.</li>
  <li>Configuring Unicorn and managing it as an Upstart service.</li>
  <li>Setting up some folders and files needed to deploy our Rails app.</li>
  <li>Installing and managing MailCatcher as a service, to make email testing easier.</li>
</ul>

<p>If you are curious about how these recipes work, go ahead and read them! Many
are thin wrappers around external cookbook dependencies, and none of them use
any Chef features that we haven’t already discussed. Attempting to
make sense of how these recipes work would be a great way to test your 
understanding of what we covered in this article.</p>

<p>If you want to take things a step farther, you can actually try to provision a
production-like environment for Practicing Ruby on your own system. The
cookbook’s <a href="https://github.com/elm-city-craftworks/practicing-ruby-cookbook#readme">README file</a> is fairly detailed, and we have things set up to work within a
virtual machine that can run in isolation without having a negative impact
on your own development environment. We also simplify a few things to make
setup easier, such as swapping out GitHub authentication for OmniAuth developer
mode, making most service integrations optional, and other little tweaks that
make it possible to try things out without having to do a bunch of 
configuration work.</p>

<p>I absolutely recommend trying to run our cookbook on your own to learn a whole
lot more about Chef, but fair warning: to do so you will need to become familiar
with the complex network of underplumbing that we intentionally avoided
discussing in this article. It’s not too hard to work your way through, but
expect some turbulence along the way.</p>

<h2 id="epilogue-what-are-the-costs-of-infrastructure-automation">Epilogue: What are the costs of infrastructure automation?</h2>

<p>The process of learning from Practicing Ruby’s cookbook, and the act
of writing this article really convinced me that I had greatly underestimated
the potential benefits that infrastructure automation has to offer. However, it
is important to be very clear on one point: there’s no such thing as a 
free lunch.</p>

<p>At my current stage of understanding, I feel the same about Chef as I do about
Rails: impressed by its vast capabilities, convinced of its utility, and shocked
by its complexity. There are a tremendous amount of moving parts that you need
to understand before it becomes useful, and many layers of subsystems that need
to be wired up before you can actually get any of your recipes to run.</p>

<p>Another concern is that “infrastructure as code” comes with the drawbacks
associated with code and not just the benefits. Third-party cookbooks vary in
quality and sometimes need to be patched or hacked to get them to work the way
you want, and some abstractions are leaky and leave you doing some tedious work 
at a lower level than you’d want. Dependency management is also complicated: using external cookbooks means introducing at least one more fragile package 
installer into your life.</p>

<p>In the case of Chef in particular, it is also a bit strange that although its
interface is mostly ordinary Ruby code, it has developed in a somewhat parallel
universe where the user is assumed to know a lot about system administration,
and very little about Ruby. This leads to some design choices that aren’t
necessarily bad, but are at least surprising to an experienced Ruby developer.</p>

<p>And as for infrastructure automation as a whole, well… it doesn’t fully free
you from knowing quite a few details about the systems you are trying to manage.
It does allow you to express ideas at a higher level, but you still need to
be able to peel back the veneer and dive into some low level system
administration concepts whenever something doesn’t work the way you expect it
would or doesn’t support the feature you want to use via its high level
interface. In that sense, an automated system will not necessarily reduce
learning costs, it just has you doing a different kind of learning.</p>

<p>Despite all these concerns, I have to say that this is one skillset that I wish
I had picked up years ago, and I fully intend to look for opportunities
to apply these ideas in my own projects. I hope after reading this article,
you will try to do the same, and then share your stories about your experiences.</p>

<h2 id="recommendations-for-further-reading">Recommendations for further reading</h2>

<p>Despite having a very complex ecosystem, the infrastructure automation world
(and especially the Chef community) have a ton of useful documentation that is
freely available and easy to get started with. Here are a few resources to try
out if you want to continue exploring this topic on your own:</p>

<ul>
  <li>
    <p><a href="http://docs.opscode.com">Opscode Chef documentation</a>: The official Chef documentation; comprehensive and really well organized.</p>
  </li>
  <li>
    <p><a href="https://github.com/opscode-cookbooks">Opscode public cookbooks</a>: You can learn a lot by reading some of the most widely-used cookbooks in the Chef community. For complex examples, definitely check out the <a href="https://github.com/opscode-cookbooks/apache2">apache2</a> and <a href="https://github.com/opscode-cookbooks/mysql">mysql</a> cookbooks.</p>
  </li>
  <li>
    <p><a href="https://learnchef.opscode.com/">#learnchef</a>: A collection of tutorials and screencasts designed to help you learn Chef.</p>
  </li>
  <li>
    <p><a href="http://www.opscode.com/blog/2013/09/04/demystifying-common-idioms-in-chef-recipes/">Common Idioms in Chef Recipes</a>: Explanation of (possibly surprising) idioms that sometimes appear in recipe code.</p>
  </li>
  <li>
    <p><a href="http://mlafeldt.github.io/blog/2012/09/learning-chef">Learning Chef</a>: A friendly introduction to Chef written by Mathias.</p>
  </li>
</ul>

<p>If you’ve got some experience with infrastructure automation and have found
other tutorials or articles that you like which aren’t listed here, please leave
a comment. Mathias will also be watching the comments for this article, so
don’t be afraid to ask any general questions you have about infrastructure
automation or Chef, too.</p>

<p>Thanks for making it all the way to the end of this article, and happy automating!</p>


  </div>

  <div style="text-align: center">
    <h3><a href="/">Want to keep reading? Check out our archives for more.</a></h3>

    <small>Practicing Ruby is proudly independent, open source, and advertising free.<br/>If you insist on being asked for something in return, check out <a href="/support">how to support my work</a>.</small>
  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
