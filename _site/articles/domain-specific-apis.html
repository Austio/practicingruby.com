<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Domain specific API construction</title>
  <meta name="description" content="Many people are attracted to Ruby because of its flexible syntax. Through various tricks and techniques, it is possible for Ruby APIs to blend seamlessly int...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://yourdomain.com/articles/domain-specific-apis">
  <link rel="alternate" type="application/rss+xml" title="Practicing Ruby" href="http://yourdomain.com/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33127211-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Practicing Ruby</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Domain specific API construction</h1>
    <p class="post-meta"><time datetime="2011-11-02T00:00:00-04:00" itemprop="datePublished">Nov 2, 2011</time> • Gregory Brown</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Many people are attracted to Ruby because of its flexible syntax. Through various tricks and techniques, it is possible for Ruby APIs to blend seamlessly into a wide range of domains.</p>

<p>In this article, we will investigate how domain-specific APIs are constructed by implementing simplified versions of popular patterns seen in the wild. Hopefully, this exploration will give you a better sense of the tools you have at your disposal as well as a chance to see various Ruby metaprogramming concepts being used in context.</p>

<h3 id="implementing-attraccessor">Implementing <code class="highlighter-rouge">attr_accessor</code></h3>

<p>One of the first things every beginner to Ruby learns is how to use <code class="highlighter-rouge">attr_accessor</code>. It has the appearance of a macro or keyword, but is actually just an ordinary method defined at the module level. To illustrate that this is the case, we can easily implement it ourselves.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Module</span>
  <span class="k">def</span> <span class="nf">attribute</span><span class="p">(</span><span class="o">*</span><span class="n">attribs</span><span class="p">)</span>
    <span class="n">attribs</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">a</span><span class="o">|</span>
      <span class="n">define_method</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">"@</span><span class="si">#{</span><span class="n">a</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">define_method</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">a</span><span class="si">}</span><span class="s2">="</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">val</span><span class="o">|</span> <span class="nb">instance_variable_set</span><span class="p">(</span><span class="s2">"@</span><span class="si">#{</span><span class="n">a</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Person</span>
  <span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>

<span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">new</span>
<span class="n">person</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Gregory Brown"</span>

<span class="nb">p</span> <span class="n">person</span><span class="p">.</span><span class="nf">name</span> <span class="c1">#=&gt; "Gregory Brown"</span>
</code></pre>
</div>

<p>In order to understand what is going on here, you need to think a little bit about what a class object in Ruby actually is. A class object is an instance of the class called <code class="highlighter-rouge">Class</code>, which is in turn a subclass of the <code class="highlighter-rouge">Module</code> class. When an instance method is added to the <code class="highlighter-rouge">Module</code> class definition, that method becomes available as a class method on all classes.</p>

<p>At the class/module level, it is possible to call <code class="highlighter-rouge">define_method</code>, which will in turn add new instance methods to the class/module that it gets called on. So when the <code class="highlighter-rouge">attribute()</code> method gets called on <code class="highlighter-rouge">Person</code>, a pair of methods get defined on <code class="highlighter-rouge">Person</code> for each attribute. The end result is that functionally equivalent code to what is shown below gets dynamically generated:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span>
  <span class="k">def</span> <span class="nf">name</span>
    <span class="vi">@name</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">name</span><span class="o">=</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="n">val</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">email</span>
    <span class="vi">@email</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">email</span><span class="o">=</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="vi">@email</span> <span class="o">=</span> <span class="n">val</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This is powerful stuff. As soon as you recognize that things like <code class="highlighter-rouge">attr_accessor</code> are not some special keywords or macros that only the Ruby interpreter can define, a ton of possibilities open up.</p>

<h3 id="implementing-a-rails-style-beforefilter-construct">Implementing a Rails-style <code class="highlighter-rouge">before_filter</code> construct</h3>

<p>Rails uses class methods all over the place to make it look and feel like its own dialect of Ruby. As a single example, it is possible to register callbacks to be run before a given controller action is executed using the <code class="highlighter-rouge">before_filter</code> feature. The simplified example below is a rough approximation of what this functionality looks like in Rails.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">BasicController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span>

  <span class="k">def</span> <span class="nf">authenticate</span>
    <span class="nb">puts</span> <span class="s2">"authenticating current user"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">PeopleController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span> 
  <span class="n">before_filter</span> <span class="ss">:locate_person</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="nb">puts</span> <span class="s2">"showing a person's data"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="nb">puts</span> <span class="s2">"displaying a person edit form"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="nb">puts</span> <span class="s2">"committing updated person data to the database"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="nb">puts</span> <span class="s2">"creating a new person"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">locate_person</span>
    <span class="nb">puts</span> <span class="s2">"locating a person"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Suppose that <code class="highlighter-rouge">BasicController</code> provides us with the <code class="highlighter-rouge">before_filter</code> method as well as an <code class="highlighter-rouge">execute</code> method which will execute a given action, but first trigger any <code class="highlighter-rouge">before_filter</code> callbacks. Then we’d expect the <code class="highlighter-rouge">execute</code> method to have the following behavior.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">controller</span> <span class="o">=</span> <span class="no">PeopleController</span><span class="p">.</span><span class="nf">new</span>

<span class="nb">puts</span> <span class="s2">"EXECUTING SHOW"</span>
<span class="n">controller</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="ss">:show</span><span class="p">)</span>

<span class="nb">puts</span>

<span class="nb">puts</span> <span class="s2">"EXECUTING CREATE"</span>
<span class="n">controller</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="ss">:create</span><span class="p">)</span>

<span class="cm">=begin -- expected output --

EXECUTING SHOW
authenticating current user
locating a person
showing a person's data

EXECUTING CREATE
authenticating current user
creating a new person 

=end</span> 
</code></pre>
</div>

<p>Implementing this sort of behavior isn’t as trivial as implementing a clone of <code class="highlighter-rouge">attr_accessor</code>, because in this scenario we need to manipulate some class level data. Things are further complicated by the fact that we want filters to propagate down through the inheritance chain, allowing a given class to apply both its own filters as well as the filters of its ancestors. Fortunately, Ruby provides facilities to deal with both of these concerns, resulting in the following implementation of our <code class="highlighter-rouge">BasicController</code> class:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BasicController</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">before_filters</span>
    <span class="vi">@before_filters</span> <span class="o">||=</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">before_filter</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">before_filters</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">:callback</span> <span class="o">=&gt;</span> <span class="n">callback</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">inherited</span><span class="p">(</span><span class="n">child_class</span><span class="p">)</span>
    <span class="n">before_filters</span><span class="p">.</span><span class="nf">reverse_each</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">child_class</span><span class="p">.</span><span class="nf">before_filters</span><span class="p">.</span><span class="nf">unshift</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">matched_filters</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">before_filters</span><span class="p">.</span><span class="nf">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> 
      <span class="n">f</span><span class="p">[</span><span class="ss">:only</span><span class="p">].</span><span class="nf">nil?</span> <span class="o">||</span> <span class="n">f</span><span class="p">[</span><span class="ss">:only</span><span class="p">].</span><span class="nf">include?</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> 
    <span class="k">end</span>

    <span class="n">matched_filters</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">send</span> <span class="n">f</span><span class="p">[</span><span class="ss">:callback</span><span class="p">]</span> <span class="p">}</span>
    <span class="nb">send</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>In this code, we store our filters as an array of hashes on each class, and use the <code class="highlighter-rouge">before_filters</code> method as a way of lazily initializing that array. Whenever a subclass gets created, the parent class copies its filters to the front of list of filters that the child class will continue to build up. This allows downward propagation of filters through the inheritance chain. If that sounds confusing, exploring in irb a bit might help clear up what ends up happening as a result of this <code class="highlighter-rouge">inherited</code> hook.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt;&gt; BasicController.before_filters.map { |e| e[:callback] }
=&gt; []
&gt;&gt; ApplicationController.before_filters.map { |e| e[:callback] }
=&gt; [:authenticate]
&gt;&gt; PeopleController.before_filters.map { |e| e[:callback] }
=&gt; [:authenticate, :locate_person]
</code></pre>
</div>

<p>From here, it should be pretty easy to see how the <code class="highlighter-rouge">execute</code> method works. It simply looks up this list of filters and selects the ones relevant to the provided action. It then uses <code class="highlighter-rouge">send</code> to call each callback that was matched, and finally calls the target action.</p>

<p>While we’ve only gone through two examples of class level macros so far, the techniques used between the two of them cover most of what you’ll need to know to understand virtually all uses of this pattern in other scenarios. If we really wanted to dig in deeper, we could go over some other tricks such as using class methods to mix modules into classes on-demand (a common pattern in Rails plugins), but instead I’ll leave those concepts for you to explore on your own and move on to some other interesting patterns.</p>

<h3 id="implementing-a-cheap-counterfeit-of-mails-api">Implementing a cheap counterfeit of Mail’s API</h3>

<p>Historically, sending email in Ruby has always been an ugly and cumbersome process. However, the Mail gem changed all of that not too long ago. Using Mail, sending a message can be as simple as the code shown below.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="no">Mail</span><span class="p">.</span><span class="nf">deliver</span> <span class="k">do</span>
  <span class="n">from</span>    <span class="s2">"gregory.t.brown@gmail.com"</span>
  <span class="n">to</span>      <span class="s2">"test@test.com"</span>
  <span class="n">subject</span> <span class="s2">"Hello world"</span>
  <span class="n">body</span>    <span class="s2">"Hi there! This isn't spam, I swear"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The nice thing about Mail is that in addition to this convenient syntax, it is still possible to work with a more ordinary looking API as well.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">mail</span>         <span class="o">=</span> <span class="no">Mail</span><span class="o">::</span><span class="no">Message</span><span class="p">.</span><span class="nf">new</span>

<span class="n">mail</span><span class="p">.</span><span class="nf">from</span>    <span class="o">=</span> <span class="s2">"gregory.t.brown@gmail.com"</span>
<span class="n">mail</span><span class="p">.</span><span class="nf">to</span>      <span class="o">=</span> <span class="s2">"test@test.com"</span>
<span class="n">mail</span><span class="p">.</span><span class="nf">body</span>    <span class="o">=</span> <span class="s2">"Hi there! This isn't spam, I swear"</span>
<span class="n">mail</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="s2">"Hello world"</span>

<span class="n">mail</span><span class="p">.</span><span class="nf">deliver</span>
</code></pre>
</div>

<p>If we ignore the actual sending of email and focus on the interface to the object, implementing a dual purpose API like this is surprisingly easy. The code below defines a class that provides a matching API to the examples shown above.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FakeMail</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deliver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">mail</span><span class="p">.</span><span class="nf">deliver</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Message</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="k">if</span> <span class="n">block</span>
    <span class="k">end</span>

    <span class="kp">attr_writer</span> <span class="ss">:from</span><span class="p">,</span> <span class="ss">:to</span><span class="p">,</span> <span class="ss">:subject</span><span class="p">,</span> <span class="ss">:body</span>

    <span class="k">def</span> <span class="nf">from</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
      <span class="k">return</span> <span class="vi">@from</span> <span class="k">unless</span> <span class="n">text</span> 

      <span class="nb">self</span><span class="p">.</span><span class="nf">from</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
      <span class="k">return</span> <span class="vi">@to</span> <span class="k">unless</span> <span class="n">text</span>

      <span class="nb">self</span><span class="p">.</span><span class="nf">to</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">subject</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
      <span class="k">return</span> <span class="vi">@subject</span> <span class="k">unless</span> <span class="n">text</span>

      <span class="nb">self</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
      <span class="k">return</span> <span class="vi">@body</span> <span class="k">unless</span> <span class="n">text</span>

      <span class="nb">self</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">end</span>

    <span class="c1"># this is just a placeholder for a real delivery method</span>
    <span class="k">def</span> <span class="nf">deliver</span>
      <span class="nb">puts</span> <span class="s2">"Delivering a message from </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="s2"> "</span><span class="o">+</span>
      <span class="s2">"with the subject '</span><span class="si">#{</span><span class="n">subject</span><span class="si">}</span><span class="s2">' and "</span><span class="o">+</span>
      <span class="s2">"the body '</span><span class="si">#{</span><span class="n">body</span><span class="si">}</span><span class="s2">'"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>There are only two things that make this class definition different from that of the ordinary class definitions we see in elementary Ruby textbooks. The first is that the constructor for <code class="highlighter-rouge">FakeMail::Message</code> accepts an optional block to run through <code class="highlighter-rouge">instance_eval</code>, and the second is that the class provides accessor methods which can act as both a reader and a writer depending on whether an argument is given or not. These two special features go hand in hand, as the following example demonstrates:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  <span class="no">FakeMail</span><span class="p">.</span><span class="nf">deliver</span> <span class="k">do</span> 
    <span class="c1"># this looks ugly, but would be necessary if using ordinary attr_accessors</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">from</span> <span class="o">=</span> <span class="s2">"gregory.t.brown@gmail.com"</span>

  <span class="k">end</span>

  <span class="n">mail</span> <span class="o">=</span> <span class="no">FakeMail</span><span class="o">::</span><span class="no">Message</span><span class="p">.</span><span class="nf">new</span>

  <span class="c1"># when you strip away the syntactic sugar, this looks ugly too.</span>
  <span class="n">mail</span><span class="p">.</span><span class="nf">from</span> <span class="s2">"gregory.t.brown@gmail.com"</span>
</code></pre>
</div>

<p>This approach to implementing this pattern is fairly common and shows up in a lot of different Ruby projects, including my own libraries. By accepting a bit more complexity in our accessor code, we end up with a more palatable API in both scenarios, and it feels like a good trade. However, the dual purpose accessors always felt like a bit of a hack to me, and I recently found a different approach that is I think is a bit more solid. The code below shows how I would attack this problem in new projects:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FakeMail</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deliver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">MessageBuilder</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">).</span><span class="nf">message</span>
    <span class="n">mail</span><span class="p">.</span><span class="nf">deliver</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">MessageBuilder</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="vi">@message</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">new</span>
      <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="k">if</span> <span class="n">block</span>
    <span class="k">end</span>

    <span class="kp">attr_reader</span> <span class="ss">:message</span>

    <span class="k">def</span> <span class="nf">from</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
      <span class="n">message</span><span class="p">.</span><span class="nf">from</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">to</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
      <span class="n">message</span><span class="p">.</span><span class="nf">to</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">subject</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
      <span class="n">message</span><span class="p">.</span><span class="nf">subject</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
      <span class="n">message</span><span class="p">.</span><span class="nf">body</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Message</span>
    <span class="kp">attr_accessor</span> <span class="ss">:from</span><span class="p">,</span> <span class="ss">:to</span><span class="p">,</span> <span class="ss">:subject</span><span class="p">,</span> <span class="ss">:body</span>

    <span class="k">def</span> <span class="nf">deliver</span>
      <span class="nb">puts</span> <span class="s2">"Delivering a message from </span><span class="si">#{</span><span class="n">from</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">to</span><span class="si">}</span><span class="s2"> "</span><span class="o">+</span>
      <span class="s2">"with the subject '</span><span class="si">#{</span><span class="n">subject</span><span class="si">}</span><span class="s2">' and "</span><span class="o">+</span>
      <span class="s2">"the body '</span><span class="si">#{</span><span class="n">body</span><span class="si">}</span><span class="s2">'"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This code is a drop-in replacement for what I wrote before, but is quite different under the hood. Rather than putting the syntactic sugar directly onto the <code class="highlighter-rouge">Message</code> object, I create a <code class="highlighter-rouge">MessageBuilder</code> object for this purpose. When <code class="highlighter-rouge">FakeMail.deliver</code> is called, the <code class="highlighter-rouge">MessageBuilder</code> object ends up being the target context for the block to be evaluated in rather than the <code class="highlighter-rouge">Message</code> object. This effectively splits the code the implements the sugary interface from the code that implements the domain model, eliminating the need for dual purpose accessors.</p>

<p>There is another benefit that comes along with taking this approach, but it is more subtle. Whenever we use <code class="highlighter-rouge">instance_eval</code>, it evaluates the block as if you were executing your statements within the object it was called on. This means it is possible to bypass private methods and otherwise mess around with objects in ways that are typically reserved for internal use. By switching the context to a simple facade object whose only purpose is to provide some domain specific API calls for the user, it’s less likely that someone will accidentally call internal methods or otherwise stomp on the internals of the system’s domain objects.</p>

<p>It’s worth mentioning that even this improved approach to implementing an <code class="highlighter-rouge">instance_eval</code> based interface comes with its own limitations. For example, whenever you use <code class="highlighter-rouge">instance_eval</code>, it makes it so that <code class="highlighter-rouge">self</code> within the block points to the object the block is being evaluated against rather than the object in the the surrounding scope. The closure property of Ruby code blocks makes it possible to access local variables, but if you reference instance variables, they will refer to the object your block is being evaluated against. This can confuse beginners and even some more experienced Ruby developers.</p>

<p>If you want to use this style of API, your best bet is to reserve it for things that are relatively simple and configuration-like in nature. As things get more complex the limitations of this approach become more and more painful to deal with. That having been said, valid use cases for this pattern occur often enough that you should be comfortable implementing it whenever it makes sense to do so.</p>

<p>The next pattern is one that you probably WON’T use all that often, but is perhaps the best example of how far you can stretch Ruby’s syntax and behaviors to fit your own domain.</p>

<h3 id="implementing-a-shoddy-version-of-xml-builder">Implementing a shoddy version of XML Builder</h3>

<p>One of the first libraries that impressed me as a Ruby newbie was Jim Weirich’s XML Builder. The fact that you could create a single Ruby object that magically knew how to convert arbitrary method calls into an XML structure seemed like pure voodoo to me at the time.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"builder"</span>

<span class="n">builder</span> <span class="o">=</span> <span class="no">Builder</span><span class="o">::</span><span class="no">XmlMarkup</span><span class="p">.</span><span class="nf">new</span>

<span class="n">xml</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">class</span> <span class="k">do</span> <span class="o">|</span><span class="n">roster</span><span class="o">|</span>
  <span class="n">roster</span><span class="p">.</span><span class="nf">student</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">name</span><span class="p">(</span><span class="s2">"Jim"</span><span class="p">);</span>    <span class="n">s</span><span class="p">.</span><span class="nf">phone</span><span class="p">(</span><span class="s2">"555-1234"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">roster</span><span class="p">.</span><span class="nf">student</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">name</span><span class="p">(</span><span class="s2">"Jordan"</span><span class="p">);</span> <span class="n">s</span><span class="p">.</span><span class="nf">phone</span><span class="p">(</span><span class="s2">"123-1234"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">roster</span><span class="p">.</span><span class="nf">student</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">name</span><span class="p">(</span><span class="s2">"Greg"</span><span class="p">);</span>   <span class="n">s</span><span class="p">.</span><span class="nf">phone</span><span class="p">(</span><span class="s2">"567-1234"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">xml</span>

<span class="cm">=begin -- expected output --

&lt;class&gt;&lt;student&gt;&lt;name&gt;Jim&lt;/name&gt;&lt;phone&gt;555-1234&lt;/phone&gt;&lt;/student&gt;
&lt;student&gt;&lt;name&gt;Jordan&lt;/name&gt;&lt;phone&gt;123-1234&lt;/phone&gt;&lt;/student&gt;
&lt;student&gt;&lt;name&gt;Greg&lt;/name&gt;&lt;phone&gt;567-1234&lt;/phone&gt;&lt;/student&gt;&lt;/class&gt;  

=end</span>
</code></pre>
</div>

<p>Some time much later in my career, I was impressed again by how easy it is to implement this sort of behavior if you cut a few corners. While it’s mostly smoke and mirrors, the snippet below is sufficient for replicating the behavior of the previous example.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">module</span> <span class="nn">FakeBuilder</span>
  <span class="k">class</span> <span class="nc">XmlMarkup</span> <span class="o">&lt;</span> <span class="no">BasicObject</span>
    <span class="k">def</span> <span class="nf">initialize</span>
      <span class="vi">@output</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">end</span>
    
    <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="vi">@output</span> <span class="o">&lt;&lt;</span> <span class="s2">"&lt;</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&gt;"</span>
      
      <span class="n">block</span> <span class="p">?</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">:</span> <span class="vi">@output</span> <span class="o">&lt;&lt;</span> <span class="n">args</span><span class="p">.</span><span class="nf">first</span>

      <span class="vi">@output</span> <span class="o">&lt;&lt;</span> <span class="s2">"&lt;/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&gt;"</span>

      <span class="k">return</span> <span class="vi">@output</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Despite how compact this code is, it gives us a lot to talk about. The heart of the implemenation relies on the use of a <code class="highlighter-rouge">method_missing</code> hook to convert unknown method calls into XML tags. There are few special things to note about this code, even if you are already familiar with <code class="highlighter-rouge">method_missing</code>.</p>

<p>Typically it is expected that if you implement a <code class="highlighter-rouge">method_missing</code> hook, you should be as conservative as possible about what you handle in your hook and then use <code class="highlighter-rouge">super</code> to delegate everything else upstream. For example, if you were to write dynamic finders similar to the ones that ActiveRecord provides (i.e. something like <code class="highlighter-rouge">find_by_some_attribute</code>), you would make it so that your <code class="highlighter-rouge">method_missing</code> hook only handled method calls which matched the pattern <code class="highlighter-rouge">/^find_by_(.*)/</code>. However, in the case of Builder all method calls captured by <code class="highlighter-rouge">method_missing</code> are potentially valid XML tags, and so <code class="highlighter-rouge">super</code> is not needed in its <code class="highlighter-rouge">method_missing</code> hook.</p>

<p>On a somewhat similar note, certain methods that are provided by <code class="highlighter-rouge">Object</code> are actually valid XML tag names that wouldn’t be too rare to come across. In my example, I intentionally used XML data representing a class of students to illustrate this point, because it forces us to call <code class="highlighter-rouge">builder.class</code>. By inheriting from <code class="highlighter-rouge">BasicObject</code> instead of <code class="highlighter-rouge">Object</code>, we end up with far fewer reserved words on our object, which decreases the likelihood that we will accidentally call a method that does exist. While we don’t think about it often, all <code class="highlighter-rouge">method_missing</code> based APIs hinge on the idea that your hook will only be triggered by calls to undefined methods. In many cases we don’t need to think about this, but in the case of Builder (and perhaps when building proxy objects), we need to work with a blank slate object.</p>

<p>The final thing worth pointing out about this code is that it uses blocks in a slightly surprising way. Because the <code class="highlighter-rouge">method_missing</code> call yields the builder object itself whenever the block is given, it does not serve a functional purpose. To illustrate this point, it’s worth noting that the code below is functionally equivalent to our original example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">xml</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="nf">class</span> <span class="k">do</span> 
  <span class="n">builder</span><span class="p">.</span><span class="nf">student</span> <span class="p">{</span> <span class="n">builder</span><span class="p">.</span><span class="nf">name</span><span class="p">(</span><span class="s2">"Jim"</span><span class="p">);</span>    <span class="n">builder</span><span class="p">.</span><span class="nf">phone</span><span class="p">(</span><span class="s2">"555-1234"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">student</span> <span class="p">{</span> <span class="n">builder</span><span class="p">.</span><span class="nf">name</span><span class="p">(</span><span class="s2">"Jordan"</span><span class="p">);</span> <span class="n">builder</span><span class="p">.</span><span class="nf">phone</span><span class="p">(</span><span class="s2">"123-1234"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">builder</span><span class="p">.</span><span class="nf">student</span> <span class="p">{</span> <span class="n">builder</span><span class="p">.</span><span class="nf">name</span><span class="p">(</span><span class="s2">"Greg"</span><span class="p">);</span>   <span class="n">builder</span><span class="p">.</span><span class="nf">phone</span><span class="p">(</span><span class="s2">"567-1234"</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="n">xml</span>
</code></pre>
</div>

<p>However, Builder cleverly exploits block local variable assignment to allow contextual abbreviations so that the syntax more closely mirrors the underlying structure. These days we occasionally see <code class="highlighter-rouge">Object#tap</code> being used for similar purposes, but at the time that Builder did this it was quite novel.</p>

<p>While it’s tempting to write Builder off as just a weird little bit of Ruby magic, it has some surprisingly practical benefits to its design. Unlike my crappy prototype, the real Builder library will automatically escape your strings so that they’re XML safe. Also, because Builder essentially uses Ruby to build up an abstract syntax tree (AST) internally, it could possibly be used to render to multiple different output formats. While I’ve not actually tried it out myself, it looks like someone has already made a <a href="https://github.com/nov/jsonbuilder">JSON builder</a> which matches the same API but emits JSON hashes instead of XML tags.</p>

<p>With those benefits in mind, this is a good pattern to use for problems that involve outputting documents that nicely map to Ruby syntax as an intermediate format. But as I mentioned before, those circumstances are rare in most day to day programming work, and so you shouldn’t be too eager to use this technique as often as possible. That having been said, you could have some fantastic fun adding this sort of freewheeling code to various classes that don’t actually need it in your production applications and then telling your coworkers I told you to do it. I’ll leave it up to you to decide whether that’s a good idea or not :)</p>

<p>With four tough examples down and only two more to go, we’re on the home stretch. Take a quick break if you’re feeling tired, and then let’s move on to the next pattern.</p>

<h3 id="implementing-contest-on-top-of-minitest">Implementing Contest on top of MiniTest</h3>

<p>When I used to write code for Ruby 1.8, I liked using the Test::Unit standard library for testing, but I wanted context support and full text test cases similar to what was found in RSpec. I eventually settled on using the <a href="https://github.com/citrusbyte/contest">contest</a> library, because it gave me exactly what I needed in a very simple an elegant way.</p>

<p>When I moved to Ruby 1.9 and MiniTest, I didn’t immediately invest the time in learning <code class="highlighter-rouge">MiniTest::Spec</code>, which provides similar functionality to contest as well as few other RSpec-style goodies. Instead, I looked into porting contest to MiniTest. After finding a <a href="https://gist.github.com/25455">gist</a> from Chris Wanswrath and customizing it heavily, I ended up with a simple little test helper that made it possible for me to write tests in minitest which looked like this.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">context</span> <span class="s2">"A Portal"</span> <span class="k">do</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@portal</span> <span class="o">=</span> <span class="no">Portal</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"must not be open by default"</span> <span class="k">do</span>
    <span class="n">refute</span> <span class="vi">@portal</span><span class="p">.</span><span class="nf">open?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"must not be open when just the orange endpoint is set"</span> <span class="k">do</span>
    <span class="vi">@portal</span><span class="p">.</span><span class="nf">orange</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">refute</span> <span class="vi">@portal</span><span class="p">.</span><span class="nf">open?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"must not be open when just the blue endpoint is set"</span> <span class="k">do</span>
    <span class="vi">@portal</span><span class="p">.</span><span class="nf">blue</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">refute</span> <span class="vi">@portal</span><span class="p">.</span><span class="nf">open?</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"must be open when both endpoints are set"</span> <span class="k">do</span>
    <span class="vi">@portal</span><span class="p">.</span><span class="nf">orange</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
    <span class="vi">@portal</span><span class="p">.</span><span class="nf">blue</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">assert</span> <span class="vi">@portal</span><span class="p">.</span><span class="nf">open?</span>
  <span class="k">end</span>

  <span class="c1"># a pending test</span>
  <span class="nb">test</span> <span class="s2">"must require endpoints to be a 3 element array of numbers"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Without having to install any third party libraries, I was able to support this kind of test syntax via a single function in my test helpers file.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">super</span> <span class="k">unless</span> <span class="p">(</span><span class="nb">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">block</span>

  <span class="n">context_class</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">MiniTest</span><span class="o">::</span><span class="no">Unit</span><span class="o">::</span><span class="no">TestCase</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
      <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">block</span> <span class="o">||=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="n">skip</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">}</span>

        <span class="n">define_method</span><span class="p">(</span><span class="s2">"test: </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> "</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">define_method</span><span class="p">(</span><span class="ss">:setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="n">define_method</span><span class="p">(</span><span class="ss">:teardown</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="k">end</span>

       <span class="k">def</span> <span class="nf">to_s</span>
         <span class="nb">name</span>
       <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

   <span class="n">context_class</span><span class="p">.</span><span class="nf">singleton_class</span><span class="p">.</span><span class="nf">instance_eval</span> <span class="k">do</span>
     <span class="n">define_method</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span> <span class="p">{</span> <span class="nb">name</span> <span class="p">}</span>
   <span class="k">end</span>

  <span class="n">context_class</span><span class="p">.</span><span class="nf">class_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If you look past some of the dynamic class generation noise, you’ll see that a good chunk of this is quite similar to how I implemented a clone of <code class="highlighter-rouge">attr_accessor</code> earlier. The <code class="highlighter-rouge">test</code>, <code class="highlighter-rouge">setup</code>, and <code class="highlighter-rouge">teardown</code> methods are nothing more than class methods which delegate to <code class="highlighter-rouge">define_method</code>. The only slightly interesting detail worth noting here is that in the <code class="highlighter-rouge">test</code> method I define methods which are not callable using ordinary Ruby method calling syntax. The use of <code class="highlighter-rouge">define_method</code> allows us to bypass the ordinary syntactic limits of using <code class="highlighter-rouge">def</code>, and because these methods are only ever invoked dynamically, this works without any issues. The reason I don’t bother to normalize the strings is because you end up getting more humanized output from the test runner this way.</p>

<p>If you turn your focus back onto the dynamic class generation, you can see that this code creates an anonymous subclass of <code class="highlighter-rouge">MiniTest::Unit::TestCase</code> and then eventually uses <code class="highlighter-rouge">class_eval</code> to evaluate the provided block in the context of this class. This code is what enables us to write <code class="highlighter-rouge">context "foo" do ... end</code> and get something that works similar to the way an ordinary class definition works.</p>

<p>If you’re focusing on really subtle details, you’ll notice that this code goes through a bunch of hoops to define meaningful <code class="highlighter-rouge">name</code> and <code class="highlighter-rouge">to_s</code> methods on the class it dynamically generates. This is in part a bunch of massaging to get better output from MiniTest’s runner, and in part to make it so that our anonymous classes don’t look completely anonymous during debugging. The irb session below might make some sense of what’s going on here, but if it doesn’t you can feel free to chalk this up as an edge case you probably don’t need to worry about.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&gt;&gt; Class.new
=&gt; #&lt;Class:0x00000101069260&gt;
&gt;&gt; name = "A sample class"
=&gt; "A sample class"
&gt;&gt; Class.new { singleton_class.instance_eval { define_method(:to_s) { name } } }
=&gt; A sample class
</code></pre>
</div>

<p>Getting away from these ugly little details and returning to the overall pattern, it is relatively common to see domain-specific APIs which dynamically create modules or classes and then wrap certain kinds of method definitions in block based APIs as well. It’s a handy pattern when used correctly, and could be useful in your own projects. But even if you never end up using it yourself, it’s good to know how this all works as it’ll make code reading easier for you.</p>

<p>While this example was perfect for having a discussion about the pattern of dynamic class creation in general, I’d strongly recommend against using my helper in your MiniTest code at this point. You’ll find everything you need in <code class="highlighter-rouge">MiniTest::Spec</code>, and that is a much more standard solution than using some crazy hack I cooked up simply because I could.</p>

<p>With that disclaimer out of the way, we can move on to our final topic.</p>

<h3 id="implement-your-own-gherkin-parser-or-criticize-mine">Implement your own Gherkin parser, or criticize mine!</h3>

<p>So far, we’ve talked about various tools which enable the use of domain specific language (DSL) within your Ruby applications. However, there is a whole other category of DSL techniques which involve parsing external languages and then converting them into meaningful structures within the host language. This is a topic that deserves an entire article of its own.</p>

<p>But because it’ll be a while before I get around to writing that article, we can wrap up this article with a little teaser of things to come. To do so, I am challenging you to implement a basic story runner that parses the Gherkin language which is used by <a href="http://cukes.info/">Cucumber</a> and other similar tools.</p>

<p>Your mission, if you chose to accept it, is to take the following feature file and process it with Cucumber-style step definitions. You can feel free to simplify your prototype as much as you’d like, as long as you capture the core idea of processing the steps in the feature file and executing arbitrary code for each of those steps.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Feature: Addition
  Scenario: Add two numbers
    Given I have entered 70 into the calculator
    And I have entered 50 into the calculator
    When I press add
    Then the result should be 120
</code></pre>
</div>

<p>If that sounds like too much work for you, you can take on a slightly easier task instead. In preparation for this article, I build two different implementations that capture the essence of the way that that Cucumber story runner works. <a href="https://github.com/elm-city-craftworks/dsl_construction/blob/master/cucumber/global-dsl/fake_cuke.rb">One implementation uses global functions</a>, and the <a href="https://github.com/elm-city-craftworks/dsl_construction/blob/master/cucumber/binding-dsl/fake_cuke.rb">other implementation uses eval() with a binding</a>. I’d like you to examine these two approachs and share your thoughts on what the functional differences between them are.</p>

<p>While I know not everyone will have the time to try out this exercise, if a few of you work on this and share your results, it will lead to a good discussion which could help me gauge interest in a second article about external DSLs. So if you have a few spare moments, please participate!</p>

<h3 id="reflections">Reflections</h3>

<p>We’ve now reached the end of a whirlwind tour of several powerful tools Ruby provides for bending its syntax and semantics to meet domain-specific needs. While I tried to pick examples which illustrated natural uses of domain specific API construction patterns, I am left feeling that these are advanced techniques which even experienced developers have a hard time evaluating the tradeoffs of.</p>

<p>There are two metrics to apply before trying out anything you’ve seen in this article in your own projects. The first thing to remember is that any deviation from ordinary method definitions and ordinary method calls should offer a benefit that is at least proportional to how exotic your approach is. Cleverness for the sake of cleverness can be a real killer if you’re not careful. The second thing to remember is that whenever if you provide nice domain-specific APIs for convenience or aesthetic reasons, you should always make sure to build it as a facade over a boring and vanilla API. This will help make sure your objects are easier to test and easier to work with in scenarios that your domain specific interface did not anticipate.</p>

<p>If you follow these two bits of advice, you can have fun using Ruby’s sharp knives without getting cut too often. But if you do slip up from time to time, don’t be afraid to abandon fancy interfaces in favor of having something a bit dull but easier to maintain and understand. It can be tempting to layer dynamic features on top of one another to “simplify” things, but that only hides the underlying problem which is that perhaps you were trying too hard. This is something that used to happen to me all the time, so don’t feel bad when it happens to you. Just do what you can to learn from your mistakes as you try out new designs.</p>

<p><em>NOTE: If you want to experiment with the examples in this article a bit more, you can find all of them in <a href="https://github.com/elm-city-craftworks/dsl_construction">this git repository</a>. If you fork the code and submit pull requests with improvements, I will review your changes and eventually make a note of them here if we stumble across some good ideas that I didn’t cover.</em></p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Send questions and feedback to:</li>
          <li><a href="mailto:gregory@practicingdeveloper.com">gregory@practicingdeveloper.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/practicingdeveloper"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">practicingdeveloper</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/practicingdev"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">practicingdev</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>The world's largest collection of lessons for experienced Ruby developers.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
